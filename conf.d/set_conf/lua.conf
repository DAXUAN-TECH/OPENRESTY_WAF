# Lua 配置
# 注意：此文件保持在项目目录，不复制到系统目录
# nginx.conf 中的 include 路径会指向项目目录的 conf.d/set_conf
# Lua 路径指向项目目录（通过部署脚本自动替换）

# Lua 包路径（指向项目目录的 lua 文件夹）
# 部署脚本会自动替换 $PROJECT_ROOT 为实际项目路径
lua_package_path "$project_root/lua/?.lua;$project_root/lua/waf/?.lua;;";
lua_package_cpath "/usr/local/openresty/lualib/?.so;;";

# 初始化 Lua 模块
init_by_lua_block {
    -- 加载配置
    require("config")
    -- 初始化 WAF 模块
    local waf_init = require("waf.init")
    waf_init.init()
}

# 初始化工作进程
init_worker_by_lua_block {
    -- 初始化定时器，用于批量写入日志
    require("waf.log_collect").init_worker()
    
    -- 初始化 WAF 工作进程（包括自动解封定时器等）
    local waf_init = require("waf.init")
    waf_init.init_worker()
}

