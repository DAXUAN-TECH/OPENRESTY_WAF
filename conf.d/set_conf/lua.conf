# Lua 配置
# 注意：此文件保持在项目目录，不复制到系统目录
# nginx.conf 中的 include 路径会指向项目目录的 conf.d/set_conf
# Lua 路径指向项目目录（通过部署脚本自动替换）

# Lua 包路径（指向项目目录的 lua 文件夹）
# 注意：如果 $project_root 变量未设置，会在 init_by_lua_block 中动态设置
# 部署脚本会自动替换 $project_root 为实际项目路径
lua_package_path "$project_root/lua/?.lua;$project_root/lua/waf/?.lua;;";
lua_package_cpath "/usr/local/openresty/lualib/?.so;;";

# 初始化 Lua 模块
init_by_lua_block {
    -- 动态设置 package.path（如果 $project_root 变量未设置）
    -- 检查 package.path 是否包含未替换的 $project_root 变量
    local need_fix_path = false
    for path in package.path:gmatch("[^;]+") do
        if path:match("%$project_root") then
            need_fix_path = true
            break
        end
    end
    
    if need_fix_path then
        -- 尝试从 ngx.var.project_root 获取（如果可用）
        local project_root = nil
        local ok, var_value = pcall(function()
            return ngx.var.project_root
        end)
        if ok and var_value and var_value ~= "" then
            project_root = var_value
        end
        
        -- 如果 ngx.var 不可用，从 package.path 中已有的路径推断
        if not project_root then
            for path in package.path:gmatch("[^;]+") do
                -- 查找不包含 $project_root 的路径
                if not path:match("%$project_root") and path:match("/lua/") then
                    project_root = path:match("(.+)/lua/")
                    if project_root then
                        break
                    end
                end
            end
        end
        
        -- 如果仍然无法获取，尝试从当前工作目录推断
        if not project_root then
            -- 从 package.path 的第一个有效路径推断
            local first_path = package.path:match("([^;]+)")
            if first_path and first_path:match("/lua/") then
                project_root = first_path:match("(.+)/lua/")
            end
        end
        
        -- 如果找到了项目根目录，设置 package.path
        if project_root then
            package.path = project_root .. "/lua/?.lua;" .. project_root .. "/lua/waf/?.lua;" .. package.path
        end
    end
    
    -- 加载配置
    require("config")
    -- 初始化 WAF 模块
    local waf_init = require("waf.init")
    waf_init.init()
}

# 初始化工作进程
init_worker_by_lua_block {
    -- 初始化定时器，用于批量写入日志
    -- 使用 pcall 安全调用，避免错误导致整个 init_worker 失败
    local ok, log_collect = pcall(require, "waf.log_collect")
    if ok and log_collect and log_collect.init_worker then
        local init_ok, init_err = pcall(log_collect.init_worker)
        if not init_ok then
            ngx.log(ngx.ERR, "failed to initialize log_collect: ", init_err or "unknown error")
        end
    else
        ngx.log(ngx.ERR, "failed to load log_collect module: ", log_collect or "unknown error")
    end
    
    -- 初始化 WAF 工作进程（包括自动解封定时器等）
    local waf_init = require("waf.init")
    waf_init.init_worker()
}

