# Lua 配置
# 注意：此文件保持在项目目录，不复制到系统目录
# nginx.conf 中的 include 路径会指向项目目录的 conf.d/set_conf
# Lua 路径指向项目目录（通过部署脚本自动替换）
# 注意：lua_package_path 和 lua_package_cpath 已移至 nginx.conf 的 http 和 stream 块中

# 初始化 Lua 模块
init_by_lua_block {
    -- 加载配置
    require("config")
    -- 初始化 WAF 模块
    local waf_init = require("waf.init")
    waf_init.init()
}

# 初始化工作进程
init_worker_by_lua_block {
    -- 初始化定时器，用于批量写入日志
    -- 使用 pcall 安全调用，避免错误导致整个 init_worker 失败
    local ok, log_collect = pcall(require, "waf.log_collect")
    if ok and log_collect and log_collect.init_worker then
        local init_ok, init_err = pcall(log_collect.init_worker)
        if not init_ok then
            ngx.log(ngx.ERR, "failed to initialize log_collect: ", init_err or "unknown error")
        end
    else
        ngx.log(ngx.ERR, "failed to load log_collect module: ", log_collect or "unknown error")
    end
    
    -- 初始化 WAF 工作进程（包括自动解封定时器等）
    local waf_init = require("waf.init")
    waf_init.init_worker()
}

