# Lua 配置
# 注意：此文件保持在项目目录，不复制到系统目录
# nginx.conf 中的 include 路径会指向项目目录的 conf.d/set_conf
# Lua 路径指向项目目录（通过部署脚本自动替换）

# Lua 包路径（指向项目目录的 lua 文件夹）
# 注意：如果 $project_root 变量未设置，会在 init_by_lua_block 中动态设置
# 部署脚本会自动替换 $project_root 为实际项目路径
lua_package_path "$project_root/lua/?.lua;$project_root/lua/waf/?.lua;;";
lua_package_cpath "/usr/local/openresty/lualib/?.so;;";

# 初始化 Lua 模块
init_by_lua_block {
    -- 动态设置 package.path（如果 $project_root 变量未设置）
    -- 从当前脚本路径推断项目根目录
    local current_file = debug.getinfo(1, "S").source
    if current_file then
        -- 移除 "file://" 前缀（如果有）
        current_file = current_file:gsub("^@", "")
        -- 从 conf.d/set_conf/lua.conf 推断项目根目录
        local project_root = current_file:match("(.+)/conf%.d/set_conf/lua%.conf")
        if project_root then
            -- 设置 package.path
            package.path = package.path .. ";" .. project_root .. "/lua/?.lua;" .. project_root .. "/lua/waf/?.lua"
            -- 设置 ngx.var.project_root（如果可用）
            if ngx.var and ngx.var.project_root == nil or ngx.var.project_root == "" then
                -- 注意：在 init_by_lua 阶段无法设置 ngx.var，但可以设置全局变量
                -- 这里只设置 package.path
            end
        end
    end
    
    -- 加载配置
    require("config")
    -- 初始化 WAF 模块
    local waf_init = require("waf.init")
    waf_init.init()
}

# 初始化工作进程
init_worker_by_lua_block {
    -- 初始化定时器，用于批量写入日志
    -- 使用 pcall 安全调用，避免错误导致整个 init_worker 失败
    local ok, log_collect = pcall(require, "waf.log_collect")
    if ok and log_collect and log_collect.init_worker then
        local init_ok, init_err = pcall(log_collect.init_worker)
        if not init_ok then
            ngx.log(ngx.ERR, "failed to initialize log_collect: ", init_err or "unknown error")
        end
    else
        ngx.log(ngx.ERR, "failed to load log_collect module: ", log_collect or "unknown error")
    end
    
    -- 初始化 WAF 工作进程（包括自动解封定时器等）
    local waf_init = require("waf.init")
    waf_init.init_worker()
}

