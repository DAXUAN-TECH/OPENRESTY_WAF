# 高性能并发配置
# 注意：此文件保持在项目目录，不复制到系统目录
# 用于承载最大负载并发的优化配置

# ============================================
# 缓冲区配置（优化内存使用和性能）
# ============================================

# 客户端请求头缓冲区大小
client_header_buffer_size 64k;
large_client_header_buffers 4 64k;

# 客户端请求体缓冲区大小
client_body_buffer_size 128k;

# 代理缓冲区配置（用于反向代理）
proxy_buffer_size 64k;
proxy_buffers 8 64k;
proxy_busy_buffers_size 128k;
proxy_temp_file_write_size 64k;

# FastCGI 缓冲区配置（如果使用 FastCGI）
fastcgi_buffer_size 64k;
fastcgi_buffers 8 64k;
fastcgi_busy_buffers_size 128k;

# ============================================
# 超时配置（优化连接管理）
# ============================================

# 客户端连接超时
client_header_timeout 60s;
client_body_timeout 60s;
send_timeout 60s;

# 代理超时配置
proxy_connect_timeout 60s;
proxy_send_timeout 60s;
proxy_read_timeout 60s;

# FastCGI 超时配置
fastcgi_connect_timeout 60s;
fastcgi_send_timeout 60s;
fastcgi_read_timeout 60s;

# ============================================
# 连接优化
# ============================================

# Keepalive 连接优化
keepalive_timeout 75s;
keepalive_requests 10000;  # 每个 keepalive 连接最多处理 10000 个请求

# TCP 优化
tcp_nopush on;      # 在 sendfile 模式下，启用 TCP_NOPUSH
tcp_nodelay on;     # 禁用 Nagle 算法，减少延迟

# ============================================
# 文件传输优化
# ============================================

# 启用 sendfile（零拷贝技术）
sendfile on;
sendfile_max_chunk 512k;  # 每次 sendfile 调用最多传输 512k

# 文件描述符缓存
open_file_cache max=100000 inactive=20s;
open_file_cache_valid 30s;
open_file_cache_min_uses 2;
open_file_cache_errors on;

# ============================================
# HTTP/2 配置（提升性能）
# ============================================

# HTTP/2 配置说明：
# 1. HTTP/2 需要 SSL/TLS 支持（HTTPS）
# 2. 在 server 块中使用：listen 443 ssl http2;
# 3. 需要配置 SSL 证书

# HTTP/2 优化参数
# 注意：http2_max_field_size 和 http2_max_header_size 已过时，使用 large_client_header_buffers 替代
# large_client_header_buffers 4 8k;  # 已在 basic.conf 中配置，这里不再重复
# http2_max_field_size 16k;        # 已过时，使用 large_client_header_buffers
# http2_max_header_size 32k;       # 已过时，使用 large_client_header_buffers
# http2_max_requests 1000;         # 已过时，使用 keepalive_requests（已在 basic.conf 中配置）
http2_recv_buffer_size 256k;     # HTTP/2 接收缓冲区大小

# HTTP/2 推送（可选，谨慎使用）
# http2_push_preload on;

# 注意：HTTP/2 在 nginx 1.9.5+ 版本中可用
# OpenResty 通常包含较新版本的 nginx，支持 HTTP/2

# ============================================
# 其他性能优化
# ============================================

# 隐藏 Nginx 版本号（安全）
server_tokens off;

# 禁用不必要的日志（在高并发时可以减少 I/O）
# access_log off;  # 如果不需要访问日志，可以取消注释

# 启用 aio（异步 I/O，需要内核支持）
# aio on;
# aio_write on;

# 启用 directio（直接 I/O，适用于大文件）
# directio 4m;
# directio_alignment 512;

# ============================================
# 限制配置（防止资源耗尽）
# ============================================

# 限制请求体大小（防止大文件上传导致内存耗尽）
client_max_body_size 50m;

# 限制请求速率（在 waf.conf 中配置更详细的限流规则）

