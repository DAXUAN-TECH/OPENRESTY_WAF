# ============================================
# 默认 HTTP 服务器配置模板
# ============================================
# 注意：此文件保持在项目目录，不复制到系统目录
# nginx.conf 中的 include 路径会指向项目目录的 conf.d/vhost_conf
#
# 使用说明：
# 1. 根据实际需求修改 server_name、listen 端口等
# 2. 配置后端服务器地址（upstream backend）
# 3. 启用或禁用相关功能（SSL、限流、缓存等）
# 4. 修改后无需重新部署，直接 reload 即可生效
# ============================================

server {
    # ============================================
    # 基础配置
    # ============================================
    
    # 监听端口（HTTP）
    listen       80;
    
    # 服务器名称（支持多个域名，用空格分隔）
    # 示例：server_name example.com www.example.com;
    server_name  localhost;
    
    # 字符集设置
    charset utf-8;
    
    # 客户端请求体最大大小（上传文件限制）
    # 如果不需要上传大文件，可以设置较小值以提高安全性
    client_max_body_size 10m;
    
    # 客户端请求头缓冲区大小
    client_header_buffer_size 4k;
    large_client_header_buffers 4 16k;
    
    # ============================================
    # WAF 安全配置
    # ============================================
    
    # WAF 封控检查（在 access 阶段执行，优先级最高）
    # 功能：检查 IP 封控、地域封控、白名单等
    # 位置：lua/waf/ip_block.lua
    access_by_lua_block {
        require("waf.ip_block").check()
    }
    
    # 日志采集（在 log 阶段执行，不阻塞请求）
    # 功能：异步采集访问日志到 MySQL
    # 位置：lua/waf/log_collect.lua
    log_by_lua_block {
        require("waf.log_collect").collect()
    }
    
    # ============================================
    # 安全响应头配置
    # ============================================
    
    # 防止点击劫持
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # 防止 MIME 类型嗅探
    add_header X-Content-Type-Options "nosniff" always;
    
    # 启用 XSS 保护
    add_header X-XSS-Protection "1; mode=block" always;
    
    # 强制 HTTPS（如果使用 HTTPS，取消注释）
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # 内容安全策略（CSP，根据实际需求调整）
    # add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" always;
    
    # ============================================
    # 根路径配置（静态文件服务）
    # ============================================
    
    # 静态文件根目录（如果不需要静态文件服务，可以删除此配置）
    # root /var/www/html;
    
    # 默认索引文件
    # index index.html index.htm index.php;
    
    # ============================================
    # 代理到后端服务器（主要配置）
    # ============================================
    
    location / {
        # 代理到后端服务器（需要在 upstream.conf 中定义 backend）
        proxy_pass http://backend;
        
        # ============================================
        # 请求头设置（重要：传递真实客户端信息）
        # ============================================
        
        # 传递原始 Host 头
        proxy_set_header Host $host;
        
        # 传递真实客户端 IP（用于日志和封控）
        proxy_set_header X-Real-IP $remote_addr;
        
        # 传递代理链中的 IP（如果有多层代理）
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # 传递协议类型（http 或 https）
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 清空 Connection 头，启用 keepalive
        proxy_set_header Connection "";
        
        # ============================================
        # HTTP 版本和连接复用（性能优化）
        # ============================================
        
        # 启用 HTTP/1.1（支持 keepalive 连接复用）
        proxy_http_version 1.1;
        
        # ============================================
        # 超时设置（根据后端响应时间调整）
        # ============================================
        
        # 连接后端超时时间（默认已在 performance.conf 中配置）
        # proxy_connect_timeout 60s;
        
        # 发送请求到后端超时时间
        # proxy_send_timeout 60s;
        
        # 从后端读取响应超时时间
        # proxy_read_timeout 60s;
        
        # ============================================
        # 缓冲配置（性能优化）
        # ============================================
        
        # 启用代理缓冲（默认开启，提高性能）
        # 如果后端是流式响应或实时数据，可以关闭缓冲
        # proxy_buffering on;
        
        # 代理缓冲区大小
        # proxy_buffer_size 4k;
        # proxy_buffers 8 4k;
        # proxy_busy_buffers_size 8k;
        
        # ============================================
        # 重试配置
        # ============================================
        
        # 后端服务器失败时的重试次数（默认已在 upstream.conf 中配置）
        # proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        # proxy_next_upstream_tries 3;
        # proxy_next_upstream_timeout 10s;
        
        # ============================================
        # Cookie 和重定向处理
        # ============================================
        
        # 重写 Cookie 路径（如果后端路径与前端不同）
        # proxy_cookie_path /backend/ /;
        
        # 重写重定向 URL（如果后端返回重定向）
        # proxy_redirect http://backend/ http://$host/;
    }
    
    # ============================================
    # 静态文件服务（可选，如果不需要可以删除）
    # ============================================
    
    # 静态文件缓存配置（CSS、JS、图片等）
    # location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
    #     root /var/www/html;
    #     
    #     # 启用缓存（浏览器缓存 30 天）
    #     expires 30d;
    #     
    #     # 添加缓存控制头
    #     add_header Cache-Control "public, immutable";
    #     
    #     # 禁用访问日志（减少日志量）
    #     access_log off;
    #     
    #     # 禁用 WAF 检查（静态文件通常不需要检查）
    #     # access_by_lua_block {
    #     #     -- 跳过 WAF 检查
    #     # }
    # }
    
    # ============================================
    # 上传文件配置（可选）
    # ============================================
    
    # 文件上传路径（如果需要上传文件）
    # location /upload {
    #     proxy_pass http://backend;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     
    #     # 上传文件大小限制（需要与 client_max_body_size 配合）
    #     client_max_body_size 100m;
    #     
    #     # 上传超时时间
    #     proxy_read_timeout 300s;
    #     proxy_send_timeout 300s;
    # }
    
    # ============================================
    # API 接口配置（可选，如果需要特殊处理）
    # ============================================
    
    # API 接口路径（可以单独配置超时、限流等）
    # location /api/ {
    #     proxy_pass http://backend;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     
    #     # API 接口通常需要更长的超时时间
    #     proxy_read_timeout 120s;
    #     
    #     # 可以添加 API 限流（需要在 performance.conf 中配置 limit_req）
    #     # limit_req zone=api_limit burst=10 nodelay;
    # }
    
    # ============================================
    # 健康检查端点（重要：用于监控和负载均衡）
    # ============================================
    
    location /health {
        # 禁用访问日志（减少日志量）
        access_log off;
        
        # 返回健康状态
        return 200 "OK\n";
        
        # 设置响应头
        add_header Content-Type text/plain;
        
        # 可以添加更详细的健康检查逻辑
        # access_by_lua_block {
        #     -- 检查数据库连接、Redis 连接等
        #     -- 如果检查失败，返回 503
        # }
    }
    
    # ============================================
    # 状态监控端点（可选，用于监控系统状态）
    # ============================================
    
    # location /status {
    #     # 使用 Nginx 状态模块（需要编译时启用）
    #     # stub_status on;
    #     
    #     # 或者使用 OpenResty 的 lua-resty-core 模块
    #     # content_by_lua_block {
    #     #     -- 返回系统状态信息
    #     # }
    #     
    #     # 限制访问（只允许内网访问）
    #     # allow 127.0.0.1;
    #     # allow 10.0.0.0/8;
    #     # deny all;
    # }
    
    # ============================================
    # 错误页面配置（可选）
    # ============================================
    
    # 自定义错误页面
    # error_page 404 /404.html;
    # error_page 500 502 503 504 /50x.html;
    # 
    # location = /404.html {
    #     root /var/www/html;
    #     internal;
    # }
    # 
    # location = /50x.html {
    #     root /var/www/html;
    #     internal;
    # }
    
    # ============================================
    # 日志配置（可选，覆盖全局日志配置）
    # ============================================
    
    # 访问日志（默认已在 log.conf 中配置）
    # access_log $project_root/logs/access.log;
    
    # 错误日志（默认已在 log.conf 中配置）
    # error_log $project_root/logs/error.log;
    
    # ============================================
    # 限流配置（可选，需要在 performance.conf 中定义限流区域）
    # ============================================
    
    # IP 限流（防止 DDoS 攻击）
    # limit_req_zone $binary_remote_addr zone=ip_limit:10m rate=10r/s;
    # limit_req zone=ip_limit burst=20 nodelay;
    
    # 连接数限制（防止连接耗尽）
    # limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
    # limit_conn conn_limit 10;
    
    # ============================================
    # 禁止访问的路径（安全配置）
    # ============================================
    
    # 禁止访问隐藏文件（.htaccess、.git 等）
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # 禁止访问备份文件
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ============================================
# HTTPS 配置示例（如果需要 HTTPS，取消注释并配置）
# ============================================
#
# server {
#     listen       443 ssl http2;
#     server_name  localhost;
#     
#     # SSL 证书配置（证书文件放在 conf.d/cert/ 目录）
#     ssl_certificate     $project_root/conf.d/cert/your_domain.crt;
#     ssl_certificate_key $project_root/conf.d/cert/your_domain.key;
#     
#     # SSL 协议和加密套件配置（安全配置）
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
#     ssl_prefer_server_ciphers off;
#     
#     # SSL 会话缓存（性能优化）
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 10m;
#     
#     # OCSP Stapling（提高 SSL 握手性能）
#     ssl_stapling on;
#     ssl_stapling_verify on;
#     
#     # 其他配置与 HTTP 配置相同
#     # ...（复制上面的配置）
# }
#
# ============================================
# HTTP 到 HTTPS 重定向（如果使用 HTTPS）
# ============================================
#
# server {
#     listen       80;
#     server_name  localhost;
#     
#     # 重定向所有 HTTP 请求到 HTTPS
#     return 301 https://$server_name$request_uri;
# }
#
# ============================================
# 配置说明
# ============================================
#
# 1. 基础配置：
#    - 修改 listen 端口和 server_name 域名
#    - 根据实际需求调整 client_max_body_size
#
# 2. WAF 配置：
#    - access_by_lua_block：IP 封控检查（必须）
#    - log_by_lua_block：日志采集（必须）
#
# 3. 代理配置：
#    - 修改 proxy_pass 指向实际后端服务器
#    - 根据后端响应时间调整超时设置
#
# 4. 安全配置：
#    - 启用安全响应头
#    - 配置限流规则（防止 DDoS）
#    - 禁止访问敏感路径
#
# 5. 性能优化：
#    - 启用 HTTP/1.1 keepalive
#    - 配置静态文件缓存
#    - 调整缓冲区大小
#
# 6. 监控配置：
#    - 配置健康检查端点 /health
#    - 可选：配置状态监控端点 /status
#
# 7. HTTPS 配置：
#    - 取消注释 HTTPS server 块
#    - 配置 SSL 证书路径
#    - 配置 HTTP 到 HTTPS 重定向
#
# ============================================
