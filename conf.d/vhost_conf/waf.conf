# ============================================
# WAF 管理服务配置
# ============================================
# 注意：此文件专门为 WAF 管理功能提供服务
# 包含所有 WAF 相关的 API 端点和 Web 管理界面
#
# 功能开关说明：
# - 部分 API 端点通过数据库功能开关控制（如 rule_management_ui、config_check_api）
# - 功能管理 API（/api/features）是必须的，用于管理功能开关
# - 如果不需要某些功能，可以注释掉对应的 location 块
# ============================================

server {
    # ============================================
    # 基础配置
    # ============================================
    
    # 监听端口（HTTP）
    # 注意：可以根据需要修改端口，或使用不同的 server_name 来区分
    listen       80;
    
    # 服务器名称（建议使用专门的域名或子域名）
    # 示例：server_name waf-admin.example.com;
    server_name  localhost;
    
    # 字符集设置
    charset utf-8;
    
    # 客户端请求体最大大小（用于导入规则等操作）
    client_max_body_size 10m;
    
    # ============================================
    # WAF 安全配置
    # ============================================
    
    # WAF 封控检查（在 access 阶段执行，优先级最高）
    # 注意：管理接口通常需要跳过封控检查，但保留此配置以防需要
    # access_by_lua_block {
    #     require("waf.ip_block").check()
    # }
    
    # 系统访问白名单检查（在 access 阶段执行，优先级最高）
    # 只针对此server块生效，默认关闭状态
    access_by_lua_block {
        local system_access_whitelist_api = require "api.system_access_whitelist"
        local client_ip = ngx.var.remote_addr
        local ip_allowed = system_access_whitelist_api.check_ip_allowed(client_ip)
        if not ip_allowed then
            ngx.log(ngx.WARN, "System access whitelist: IP ", client_ip, " is not allowed")
            ngx.status = 403
            ngx.header.content_type = "text/html; charset=utf-8"
            ngx.say([[
<html><head><meta charset="UTF-8"><title>访问被拒绝</title></head><body>
<h1>403 Forbidden</h1>
<p>您的IP地址（]] .. (client_ip or "unknown") .. [[）不在系统访问白名单中，无法访问WAF管理系统。</p>
<p>请联系管理员将您的IP地址添加到系统访问白名单。</p>
</body></html>
            ]])
            ngx.exit(403)
        end
    }
    
    # 日志采集（在 log 阶段执行，不阻塞请求）
    log_by_lua_block {
        require("waf.log_collect").collect()
    }
    
    # ============================================
    # API 路由分发（统一入口）
    # 注意：所有 /api/* 路径都由路由分发器处理
    # 路由逻辑在 lua/api/handler.lua 中实现
    # ============================================
    
    location /api/ {
        access_log off;
        
        access_by_lua_block {
            -- 系统访问白名单检查（继承server级别的检查）
            -- 注意：location级别的access_by_lua_block会覆盖server级别的
            -- 所以需要在这里重新执行白名单检查
            local system_access_whitelist_api = require "api.system_access_whitelist"
            local client_ip = ngx.var.remote_addr
            local ip_allowed = system_access_whitelist_api.check_ip_allowed(client_ip)
            if not ip_allowed then
                ngx.log(ngx.WARN, "System access whitelist: IP ", client_ip, " is not allowed (API)")
                ngx.status = 403
                ngx.header.content_type = "text/html; charset=utf-8"
                ngx.say([[
<html><head><meta charset="UTF-8"><title>访问被拒绝</title></head><body>
<h1>403 Forbidden</h1>
<p>您的IP地址（]] .. (client_ip or "unknown") .. [[）不在系统访问白名单中，无法访问WAF管理系统。</p>
<p>请联系管理员将您的IP地址添加到系统访问白名单。</p>
</body></html>
                ]])
                ngx.exit(403)
            end
            -- 跳过封控检查（功能开关检查在 API 代码中）
        }
        
        content_by_lua_block {
            local api_handler = require "api.handler"
            api_handler.route()
        }
        
        # 限制访问（建议只允许内网访问）
        # allow 127.0.0.1;
        # allow 10.0.0.0/8;
        # deny all;
    }
    
    # ============================================
    # Web管理界面和监控端点（统一入口，只有一个 location）
    # 所有非 /api/* 的路径都由路由分发器处理
    # 路由逻辑在 lua/web/handler.lua 中实现
    # 注意：/api/* 路径会被上面的 location /api/ 优先匹配
    # 支持的路径：
    #   - /metrics → Prometheus 指标导出（受 config.metrics.enable 控制）
    #   - /admin 或 /admin/ → 导航首页
    #   - /admin/features → 功能管理界面
    #   - /admin/rules → 规则管理界面（受功能开关控制）
    #   - 其他路径 → 404 页面
    # ============================================
    
    location / {
        access_log off;
        
        access_by_lua_block {
            -- 系统访问白名单检查（继承server级别的检查）
            -- 注意：location级别的access_by_lua_block会覆盖server级别的
            -- 所以需要在这里重新执行白名单检查
            local system_access_whitelist_api = require "api.system_access_whitelist"
            local client_ip = ngx.var.remote_addr
            local ip_allowed = system_access_whitelist_api.check_ip_allowed(client_ip)
            if not ip_allowed then
                ngx.log(ngx.WARN, "System access whitelist: IP ", client_ip, " is not allowed (Web)")
                ngx.status = 403
                ngx.header.content_type = "text/html; charset=utf-8"
                ngx.say([[
<html><head><meta charset="UTF-8"><title>访问被拒绝</title></head><body>
<h1>403 Forbidden</h1>
<p>您的IP地址（]] .. (client_ip or "unknown") .. [[）不在系统访问白名单中，无法访问WAF管理系统。</p>
<p>请联系管理员将您的IP地址添加到系统访问白名单。</p>
</body></html>
                ]])
                ngx.exit(403)
            end
            -- 跳过封控检查（功能开关检查在路由分发器中）
        }
        
        content_by_lua_block {
            local web_handler = require "web.handler"
            web_handler.route()
        }
        
        # 限制访问（建议只允许内网访问）
        # allow 127.0.0.1;
        # allow 10.0.0.0/8;
        # deny all;
    }
    
    # ============================================
    # 禁止访问的路径（安全配置）
    # ============================================
    
    # 禁止访问隐藏文件（.htaccess、.git 等）
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # 禁止访问备份文件
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }
}

