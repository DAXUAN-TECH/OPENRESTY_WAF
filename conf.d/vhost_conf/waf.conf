# ============================================
# WAF ç®¡ç†æœåŠ¡é…ç½®
# ============================================
# æ³¨æ„ï¼šæ­¤æ–‡ä»¶ä¸“é—¨ä¸º WAF ç®¡ç†åŠŸèƒ½æä¾›æœåŠ¡
# åŒ…å«æ‰€æœ‰ WAF ç›¸å…³çš„ API ç«¯ç‚¹å’Œ Web ç®¡ç†ç•Œé¢
#
# åŠŸèƒ½å¼€å…³è¯´æ˜ï¼š
# - éƒ¨åˆ† API ç«¯ç‚¹é€šè¿‡æ•°æ®åº“åŠŸèƒ½å¼€å…³æ§åˆ¶ï¼ˆå¦‚ rule_management_uiã€config_check_apiï¼‰
# - åŠŸèƒ½ç®¡ç† APIï¼ˆ/api/featuresï¼‰æ˜¯å¿…é¡»çš„ï¼Œç”¨äºç®¡ç†åŠŸèƒ½å¼€å…³
# - å¦‚æœä¸éœ€è¦æŸäº›åŠŸèƒ½ï¼Œå¯ä»¥æ³¨é‡Šæ‰å¯¹åº”çš„ location å—
# ============================================

server {
    # ============================================
    # åŸºç¡€é…ç½®
    # ============================================
    
    # ç›‘å¬ç«¯å£ï¼ˆHTTPï¼‰
    # æ³¨æ„ï¼šå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ç«¯å£ï¼Œæˆ–ä½¿ç”¨ä¸åŒçš„ server_name æ¥åŒºåˆ†
    listen       80;
    
    # æœåŠ¡å™¨åç§°ï¼ˆå»ºè®®ä½¿ç”¨ä¸“é—¨çš„åŸŸåæˆ–å­åŸŸåï¼‰
    # ç¤ºä¾‹ï¼šserver_name waf-admin.example.com;
    server_name  localhost;
    
    # å­—ç¬¦é›†è®¾ç½®
    charset utf-8;
    
    # å®¢æˆ·ç«¯è¯·æ±‚ä½“æœ€å¤§å¤§å°ï¼ˆç”¨äºå¯¼å…¥è§„åˆ™ç­‰æ“ä½œï¼‰
    client_max_body_size 10m;
    
    # ============================================
    # WAF å®‰å…¨é…ç½®
    # ============================================
    
    # WAF å°æ§æ£€æŸ¥ï¼ˆåœ¨ access é˜¶æ®µæ‰§è¡Œï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼‰
    # æ³¨æ„ï¼šç®¡ç†æ¥å£é€šå¸¸éœ€è¦è·³è¿‡å°æ§æ£€æŸ¥ï¼Œä½†ä¿ç•™æ­¤é…ç½®ä»¥é˜²éœ€è¦
    # access_by_lua_block {
    #     require("waf.ip_block").check()
    # }
    
    # ç³»ç»Ÿè®¿é—®ç™½åå•æ£€æŸ¥ï¼ˆåœ¨ access é˜¶æ®µæ‰§è¡Œï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼‰
    # åªé’ˆå¯¹æ­¤serverå—ç”Ÿæ•ˆï¼Œé»˜è®¤å…³é—­çŠ¶æ€
    access_by_lua_block {
        local system_access_whitelist_api = require "api.system_access_whitelist"
        local client_ip = ngx.var.remote_addr
        local ip_allowed = system_access_whitelist_api.check_ip_allowed(client_ip)
        if not ip_allowed then
            ngx.log(ngx.WARN, "System access whitelist: IP ", client_ip, " is not allowed")
            ngx.status = 403
            ngx.header.content_type = "text/html; charset=utf-8"
            local ip_display = client_ip or "unknown"
            local html_content = [====[
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ— æƒè®¿é—®æƒé™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e0e0e0;
            padding: 20px;
        }
        .container {
            text-align: center;
            max-width: 600px;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 60px 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5),
                        0 0 0 1px rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .icon {
            font-size: 80px;
            margin-bottom: 30px;
            opacity: 0.9;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }
        h1 {
            font-size: 36px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 20px;
            letter-spacing: 1px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        .error-code {
            font-size: 120px;
            font-weight: 900;
            color: rgba(255, 255, 255, 0.1);
            line-height: 1;
            margin-bottom: 20px;
            letter-spacing: -5px;
        }
        .message {
            font-size: 18px;
            line-height: 1.8;
            color: #d0d0d0;
            margin-bottom: 30px;
        }
        .ip-info {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 20px;
            margin: 30px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .ip-info strong {
            color: #4a9eff;
            font-weight: 600;
        }
        .hint {
            font-size: 16px;
            color: #b0b0b0;
            line-height: 1.6;
            margin-top: 20px;
        }
        .divider {
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, transparent, #4a9eff, transparent);
            margin: 30px auto;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="error-code">403</div>
        <div class="icon">ğŸ”’</div>
        <h1>æ— æƒè®¿é—®æƒé™</h1>
        <div class="divider"></div>
        <div class="message">
            å¾ˆæŠ±æ­‰ï¼Œæ‚¨å½“å‰æ²¡æœ‰è®¿é—®æ­¤ç³»ç»Ÿçš„æƒé™ã€‚
        </div>
        <div class="ip-info">
            <p style="margin-bottom: 10px;">æ£€æµ‹åˆ°çš„IPåœ°å€ï¼š</p>
            <p style="font-size: 20px; font-weight: 600; color: #ffffff;"><strong>]====] .. ip_display .. [====[</strong></p>
        </div>
        <div class="hint">
            <p>å¦‚éœ€è®¿é—®ï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜å°†æ‚¨çš„IPåœ°å€æ·»åŠ åˆ°è®¿é—®ç™½åå•ä¸­ã€‚</p>
            <p style="margin-top: 10px; font-size: 14px; color: #888;">æ„Ÿè°¢æ‚¨çš„ç†è§£ä¸é…åˆã€‚</p>
        </div>
    </div>
</body>
</html>
            ]====]
            ngx.say(html_content)
            ngx.exit(403)
        end
    }
    
    # æ—¥å¿—é‡‡é›†ï¼ˆåœ¨ log é˜¶æ®µæ‰§è¡Œï¼Œä¸é˜»å¡è¯·æ±‚ï¼‰
    log_by_lua_block {
        require("waf.log_collect").collect()
    }
    
    # ============================================
    # API è·¯ç”±åˆ†å‘ï¼ˆç»Ÿä¸€å…¥å£ï¼‰
    # æ³¨æ„ï¼šæ‰€æœ‰ /api/* è·¯å¾„éƒ½ç”±è·¯ç”±åˆ†å‘å™¨å¤„ç†
    # è·¯ç”±é€»è¾‘åœ¨ lua/api/handler.lua ä¸­å®ç°
    # ============================================
    
    location /api/ {
        access_log off;
        
        access_by_lua_block {
            -- ç³»ç»Ÿè®¿é—®ç™½åå•æ£€æŸ¥ï¼ˆç»§æ‰¿serverçº§åˆ«çš„æ£€æŸ¥ï¼‰
            -- æ³¨æ„ï¼šlocationçº§åˆ«çš„access_by_lua_blockä¼šè¦†ç›–serverçº§åˆ«çš„
            -- æ‰€ä»¥éœ€è¦åœ¨è¿™é‡Œé‡æ–°æ‰§è¡Œç™½åå•æ£€æŸ¥
            local system_access_whitelist_api = require "api.system_access_whitelist"
            local client_ip = ngx.var.remote_addr
            local ip_allowed = system_access_whitelist_api.check_ip_allowed(client_ip)
            if not ip_allowed then
                ngx.log(ngx.WARN, "System access whitelist: IP ", client_ip, " is not allowed (API)")
                ngx.status = 403
                ngx.header.content_type = "text/html; charset=utf-8"
                local ip_display = client_ip or "unknown"
                local html_content = [====[
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ— æƒè®¿é—®æƒé™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e0e0e0;
            padding: 20px;
        }
        .container {
            text-align: center;
            max-width: 600px;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 60px 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5),
                        0 0 0 1px rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .icon {
            font-size: 80px;
            margin-bottom: 30px;
            opacity: 0.9;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }
        h1 {
            font-size: 36px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 20px;
            letter-spacing: 1px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        .error-code {
            font-size: 120px;
            font-weight: 900;
            color: rgba(255, 255, 255, 0.1);
            line-height: 1;
            margin-bottom: 20px;
            letter-spacing: -5px;
        }
        .message {
            font-size: 18px;
            line-height: 1.8;
            color: #d0d0d0;
            margin-bottom: 30px;
        }
        .ip-info {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 20px;
            margin: 30px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .ip-info strong {
            color: #4a9eff;
            font-weight: 600;
        }
        .hint {
            font-size: 16px;
            color: #b0b0b0;
            line-height: 1.6;
            margin-top: 20px;
        }
        .divider {
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, transparent, #4a9eff, transparent);
            margin: 30px auto;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="error-code">403</div>
        <div class="icon">ğŸ”’</div>
        <h1>æ— æƒè®¿é—®æƒé™</h1>
        <div class="divider"></div>
        <div class="message">
            å¾ˆæŠ±æ­‰ï¼Œæ‚¨å½“å‰æ²¡æœ‰è®¿é—®æ­¤ç³»ç»Ÿçš„æƒé™ã€‚
        </div>
        <div class="ip-info">
            <p style="margin-bottom: 10px;">æ£€æµ‹åˆ°çš„IPåœ°å€ï¼š</p>
            <p style="font-size: 20px; font-weight: 600; color: #ffffff;"><strong>]====] .. ip_display .. [====[</strong></p>
        </div>
        <div class="hint">
            <p>å¦‚éœ€è®¿é—®ï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜å°†æ‚¨çš„IPåœ°å€æ·»åŠ åˆ°è®¿é—®ç™½åå•ä¸­ã€‚</p>
            <p style="margin-top: 10px; font-size: 14px; color: #888;">æ„Ÿè°¢æ‚¨çš„ç†è§£ä¸é…åˆã€‚</p>
        </div>
    </div>
</body>
</html>
                ]====]
                ngx.say(html_content)
                ngx.exit(403)
            end
            -- è·³è¿‡å°æ§æ£€æŸ¥ï¼ˆåŠŸèƒ½å¼€å…³æ£€æŸ¥åœ¨ API ä»£ç ä¸­ï¼‰
        }
        
        content_by_lua_block {
            local api_handler = require "api.handler"
            api_handler.route()
        }
        
        # é™åˆ¶è®¿é—®ï¼ˆå»ºè®®åªå…è®¸å†…ç½‘è®¿é—®ï¼‰
        # allow 127.0.0.1;
        # allow 10.0.0.0/8;
        # deny all;
    }
    
    # ============================================
    # Webç®¡ç†ç•Œé¢å’Œç›‘æ§ç«¯ç‚¹ï¼ˆç»Ÿä¸€å…¥å£ï¼Œåªæœ‰ä¸€ä¸ª locationï¼‰
    # æ‰€æœ‰é /api/* çš„è·¯å¾„éƒ½ç”±è·¯ç”±åˆ†å‘å™¨å¤„ç†
    # è·¯ç”±é€»è¾‘åœ¨ lua/web/handler.lua ä¸­å®ç°
    # æ³¨æ„ï¼š/api/* è·¯å¾„ä¼šè¢«ä¸Šé¢çš„ location /api/ ä¼˜å…ˆåŒ¹é…
    # æ”¯æŒçš„è·¯å¾„ï¼š
    #   - /metrics â†’ Prometheus æŒ‡æ ‡å¯¼å‡ºï¼ˆå— config.metrics.enable æ§åˆ¶ï¼‰
    #   - /admin æˆ– /admin/ â†’ å¯¼èˆªé¦–é¡µ
    #   - /admin/features â†’ åŠŸèƒ½ç®¡ç†ç•Œé¢
    #   - /admin/rules â†’ è§„åˆ™ç®¡ç†ç•Œé¢ï¼ˆå—åŠŸèƒ½å¼€å…³æ§åˆ¶ï¼‰
    #   - å…¶ä»–è·¯å¾„ â†’ 404 é¡µé¢
    # ============================================
    
    location / {
        access_log off;
        
        access_by_lua_block {
            -- ç³»ç»Ÿè®¿é—®ç™½åå•æ£€æŸ¥ï¼ˆç»§æ‰¿serverçº§åˆ«çš„æ£€æŸ¥ï¼‰
            -- æ³¨æ„ï¼šlocationçº§åˆ«çš„access_by_lua_blockä¼šè¦†ç›–serverçº§åˆ«çš„
            -- æ‰€ä»¥éœ€è¦åœ¨è¿™é‡Œé‡æ–°æ‰§è¡Œç™½åå•æ£€æŸ¥
            local system_access_whitelist_api = require "api.system_access_whitelist"
            local client_ip = ngx.var.remote_addr
            local ip_allowed = system_access_whitelist_api.check_ip_allowed(client_ip)
            if not ip_allowed then
                ngx.log(ngx.WARN, "System access whitelist: IP ", client_ip, " is not allowed (Web)")
                ngx.status = 403
                ngx.header.content_type = "text/html; charset=utf-8"
                local ip_display = client_ip or "unknown"
                local html_content = [====[
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ— æƒè®¿é—®æƒé™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e0e0e0;
            padding: 20px;
        }
        .container {
            text-align: center;
            max-width: 600px;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 60px 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5),
                        0 0 0 1px rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .icon {
            font-size: 80px;
            margin-bottom: 30px;
            opacity: 0.9;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }
        h1 {
            font-size: 36px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 20px;
            letter-spacing: 1px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        .error-code {
            font-size: 120px;
            font-weight: 900;
            color: rgba(255, 255, 255, 0.1);
            line-height: 1;
            margin-bottom: 20px;
            letter-spacing: -5px;
        }
        .message {
            font-size: 18px;
            line-height: 1.8;
            color: #d0d0d0;
            margin-bottom: 30px;
        }
        .ip-info {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 20px;
            margin: 30px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .ip-info strong {
            color: #4a9eff;
            font-weight: 600;
        }
        .hint {
            font-size: 16px;
            color: #b0b0b0;
            line-height: 1.6;
            margin-top: 20px;
        }
        .divider {
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, transparent, #4a9eff, transparent);
            margin: 30px auto;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="error-code">403</div>
        <div class="icon">ğŸ”’</div>
        <h1>æ— æƒè®¿é—®æƒé™</h1>
        <div class="divider"></div>
        <div class="message">
            å¾ˆæŠ±æ­‰ï¼Œæ‚¨å½“å‰æ²¡æœ‰è®¿é—®æ­¤ç³»ç»Ÿçš„æƒé™ã€‚
        </div>
        <div class="ip-info">
            <p style="margin-bottom: 10px;">æ£€æµ‹åˆ°çš„IPåœ°å€ï¼š</p>
            <p style="font-size: 20px; font-weight: 600; color: #ffffff;"><strong>]====] .. ip_display .. [====[</strong></p>
        </div>
        <div class="hint">
            <p>å¦‚éœ€è®¿é—®ï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜å°†æ‚¨çš„IPåœ°å€æ·»åŠ åˆ°è®¿é—®ç™½åå•ä¸­ã€‚</p>
            <p style="margin-top: 10px; font-size: 14px; color: #888;">æ„Ÿè°¢æ‚¨çš„ç†è§£ä¸é…åˆã€‚</p>
        </div>
    </div>
</body>
</html>
                ]====]
                ngx.say(html_content)
                ngx.exit(403)
            end
            -- è·³è¿‡å°æ§æ£€æŸ¥ï¼ˆåŠŸèƒ½å¼€å…³æ£€æŸ¥åœ¨è·¯ç”±åˆ†å‘å™¨ä¸­ï¼‰
        }
        
        content_by_lua_block {
            local web_handler = require "web.handler"
            web_handler.route()
        }
        
        # é™åˆ¶è®¿é—®ï¼ˆå»ºè®®åªå…è®¸å†…ç½‘è®¿é—®ï¼‰
        # allow 127.0.0.1;
        # allow 10.0.0.0/8;
        # deny all;
    }
    
    # ============================================
    # ç¦æ­¢è®¿é—®çš„è·¯å¾„ï¼ˆå®‰å…¨é…ç½®ï¼‰
    # ============================================
    
    # ç¦æ­¢è®¿é—®éšè—æ–‡ä»¶ï¼ˆ.htaccessã€.git ç­‰ï¼‰
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # ç¦æ­¢è®¿é—®å¤‡ä»½æ–‡ä»¶
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }
}

