# 功能开关配置参数报告

## 一、可配置参数的功能开关

以下功能开关除了开关本身，还有可配置的参数（存储在 `waf_system_config` 表中）：

### 1. ✅ **auto_block** - 自动封控
**可配置参数：**
- `auto_block_enable` - 是否启用自动封控（1-启用，0-禁用）
- `auto_block_frequency_threshold` - 频率阈值（每分钟访问次数，默认：100）
- `auto_block_error_rate_threshold` - 错误率阈值（0-1之间，如0.5表示50%，默认：0.5）
- `auto_block_scan_path_threshold` - 扫描行为阈值（短时间内访问的不同路径数，默认：20）
- `auto_block_window_size` - 统计窗口大小（秒，默认：60）
- `auto_block_duration` - 自动封控时长（秒，默认1小时：3600）
- `auto_block_check_interval` - 检查间隔（秒，默认：10）

**配置位置：** 系统设置页面（`/admin/system`）

### 2. ✅ **alert** - 告警功能
**可配置参数：**
- `alert_enable` - 是否启用告警（1-启用，0-禁用）
- `alert_cooldown` - 告警冷却时间（秒，防止重复告警，默认：300）
- `alert_webhook_url` - Webhook URL（可选，用于发送告警到外部系统）
- `alert_threshold_block_rate` - 每分钟封控次数阈值（默认：100）
- `alert_threshold_cache_miss_rate` - 缓存未命中率阈值（50%，默认：0.5）
- `alert_threshold_db_failure_count` - 数据库连续失败次数阈值（默认：3）
- `alert_threshold_pool_usage` - 连接池使用率阈值（90%，默认：0.9）
- `alert_threshold_error_rate` - 错误率阈值（10%，默认：0.1）

**配置位置：** 系统设置页面（`/admin/system`）

### 3. ✅ **performance_monitor** - 性能监控
**可配置参数：**
- `performance_monitor_enable` - 是否启用性能监控（1-启用，0-禁用）
- `performance_slow_query_threshold` - 慢查询阈值（毫秒，超过此时间的查询会被记录，默认：100）
- `performance_monitor_interval` - 性能监控检查间隔（秒，默认：60）
- `performance_max_slow_queries` - 最大慢查询记录数（默认：1000）

**配置位置：** 系统设置页面（`/admin/system`）

### 4. ✅ **pool_monitor** - 连接池监控
**可配置参数：**
- `pool_monitor_enable` - 是否启用连接池监控（1-启用，0-禁用）
- `pool_monitor_check_interval` - 监控检查间隔（秒，默认：10）
- `pool_monitor_warn_threshold` - 连接池警告阈值（80%，默认：0.8）
- `pool_monitor_max_pool_size` - 最大连接池大小（默认：100）
- `pool_monitor_min_pool_size` - 最小连接池大小（默认：10）
- `pool_monitor_growth_step` - 连接池增长步长（默认：10）

**配置位置：** 系统设置页面（`/admin/system`）

### 5. ✅ **cache_warmup** - 缓存预热
**可配置参数：**
- `cache_warmup_enable` - 是否启用缓存预热（1-启用，0-禁用）
- `cache_warmup_interval` - 预热间隔（秒，默认：300）
- `cache_warmup_batch_size` - 预热批次大小（默认：100）
- `cache_warmup_smooth_transition` - 是否启用平滑过渡（1-启用，0-禁用，默认：1）
- `cache_warmup_warmup_common_ips` - 是否预热常用IP（1-启用，0-禁用，默认：0）

**配置位置：** 系统设置页面（`/admin/system`）

### 6. ✅ **cache_protection** - 缓存穿透防护
**可配置参数：**
- `cache_protection_enable` - 是否启用缓存穿透防护（1-启用，0-禁用）
- `cache_protection_enable_bloom_filter` - 是否启用布隆过滤器（1-启用，0-禁用，默认：1）
- `cache_protection_enable_rate_limit` - 是否启用频率限制（1-启用，0-禁用，默认：1）
- `cache_protection_empty_result_ttl` - 空结果缓存时间（秒，默认：60）
- `cache_protection_bloom_filter_size` - 布隆过滤器大小（默认：100000）
- `cache_protection_bloom_filter_hash_count` - 布隆过滤器哈希函数数量（默认：3）
- `cache_protection_rate_limit_window` - 频率限制窗口（秒，默认：60）
- `cache_protection_rate_limit_threshold` - 频率限制阈值（每个窗口内的请求数，默认：100）

**配置位置：** 系统设置页面（`/admin/system`）

### 7. ✅ **cache_optimizer** - 缓存策略优化
**可配置参数：**
- `cache_optimizer_enable` - 是否启用缓存策略优化（1-启用，0-禁用）
- `cache_dynamic_ttl_enable` - 是否启用动态TTL调整（1-启用，0-禁用，默认：1）
- `cache_hotspot_detection_enable` - 是否启用热点数据识别（1-启用，0-禁用，默认：1）
- `cache_hotspot_preload_enable` - 是否启用热点数据预加载（1-启用，0-禁用，默认：0）
- `cache_hotspot_threshold` - 热点数据访问次数阈值（默认：100）
- `cache_min_ttl` - 动态TTL最小值（秒，默认：30）
- `cache_max_ttl` - 动态TTL最大值（秒，默认：3600）

**配置位置：** 系统设置页面（`/admin/system`）

### 8. ✅ **cache_tuner** - 缓存自动调优
**可配置参数：**
- `cache_tuner_enable` - 是否启用缓存自动调优（1-启用，0-禁用）
- `cache_tuner_interval` - 缓存调优检查间隔（秒，默认5分钟：300）
- `cache_base_ttl` - 缓存基础TTL（秒，用于自动调优的基准值，默认：60）

**配置位置：** 系统设置页面（`/admin/system`）

### 9. ✅ **redis_cache** - Redis二级缓存
**可配置参数：**
- `redis_cache_enable` - 是否启用Redis二级缓存（1-启用，0-禁用）
- `redis_cache_key_prefix` - Redis键前缀（默认：`waf:`）
- `redis_cache_ttl` - 默认TTL（秒，默认：300）

**配置位置：** 系统设置页面（`/admin/system`）

### 10. ✅ **rule_backup** - 规则备份
**可配置参数：**
- `rule_backup_enable` - 是否启用规则备份（1-启用，0-禁用）
- `rule_backup_backup_interval` - 备份间隔（秒，默认5分钟：300）
- `rule_backup_max_backup_files` - 最大备份文件数（默认：10）

**配置位置：** 系统设置页面（`/admin/system`）

### 11. ✅ **rule_notification** - 规则更新通知
**可配置参数：**
- `rule_notification_enable` - 是否启用规则更新通知（1-启用，0-禁用）
- `rule_notification_use_redis_pubsub` - 是否使用Redis Pub/Sub（1-启用，0-禁用，默认：0）
- `rule_notification_channel` - Redis Pub/Sub频道（默认：`waf:rule_update`）

**配置位置：** 系统设置页面（`/admin/system`）

### 12. ✅ **fallback** - 降级机制
**可配置参数：**
- `fallback_enable` - 是否启用降级机制（1-启用，0-禁用）
- `fallback_health_check_interval` - 健康检查间隔（秒，默认：10）

**配置位置：** 系统设置页面（`/admin/system`）

### 13. ✅ **csrf** - CSRF防护
**可配置参数：**
- `csrf_enable` - 是否启用CSRF防护（1-启用，0-禁用）
- `csrf_token_ttl` - CSRF Token过期时间（秒，默认1小时：3600）

**配置位置：** 系统设置页面（`/admin/system`）

### 14. ✅ **rate_limit_login** - 登录速率限制
**可配置参数：**
- `rate_limit_login_enable` - 是否启用登录接口速率限制（1-启用，0-禁用）
- `rate_limit_login_rate` - 登录接口速率限制（每分钟请求数，默认：5）

**配置位置：** 系统设置页面（`/admin/system`）

### 15. ✅ **rate_limit_api** - API速率限制
**可配置参数：**
- `rate_limit_api_enable` - 是否启用API速率限制（1-启用，0-禁用）
- `rate_limit_api_rate` - API速率限制（每分钟请求数，默认：100）

**配置位置：** 系统设置页面（`/admin/system`）

### 16. ✅ **proxy_trusted_check** - 受信任代理检查
**可配置参数：**
- `proxy_enable_trusted_proxy_check` - 是否启用受信任代理检查（1-启用，0-禁用）
- `proxy_trusted_proxies_cache_ttl` - 受信任代理列表缓存时间（秒，默认：300）
- `proxy_log_ip_resolution` - 是否记录IP解析过程日志（1-启用，0-禁用，调试用，默认：0）

**配置位置：** 系统设置页面（`/admin/system`）

### 17. ✅ **metrics** - 监控指标
**可配置参数：**
- `metrics_enable` - 是否启用监控指标（1-启用，0-禁用）
- `metrics_prometheus_endpoint` - Prometheus指标导出端点（默认：`/metrics`）

**配置位置：** 系统设置页面（`/admin/system`）

### 18. ✅ **geo_block** - 地域封控
**可配置参数：**
- `geo_enable` - 是否启用地域封控（1-启用，0-禁用）
- `geo_cache_ttl` - GeoIP查询结果缓存时间（秒，默认1小时：3600）

**配置位置：** 系统设置页面（`/admin/system`）

### 19. ✅ **whitelist** - 白名单
**可配置参数：**
- `whitelist_enable` - 是否启用白名单（1-启用，0-禁用）

**配置位置：** 系统设置页面（`/admin/system`）

### 20. ✅ **block_enable** - 封控功能
**可配置参数：**
- `block_enable` - 是否启用封控（1-启用，0-禁用）
- `block_page` - 封控页面HTML内容（403错误时显示的页面，可通过Web界面修改）

**配置位置：** 系统设置页面（`/admin/system`）

### 21. ✅ **cache_invalidation** - 缓存失效
**可配置参数：**
- `cache_invalidation_enable_version_check` - 是否启用版本号检查（1-启用，0-禁用）
- `cache_invalidation_version_check_interval` - 版本号检查间隔（秒，默认：30）

**配置位置：** 系统设置页面（`/admin/system`）

### 22. ✅ **shared_memory_optimizer** - 共享内存优化
**可配置参数：**
- `shared_memory_optimizer_enable` - 是否启用共享内存优化（使用Redis替代部分共享内存，1-启用，0-禁用）
- `shared_memory_redis_fallback_enable` - 是否启用Redis回退机制（Redis失败时回退到共享内存，1-启用，0-禁用）

**配置位置：** 系统设置页面（`/admin/system`）

## 二、无配置参数的功能开关

以下功能开关只有开关本身，没有额外的配置参数：

1. ❌ **ip_block** - IP封控（无额外参数）
2. ❌ **log_collect** - 日志采集（无额外参数）
3. ❌ **rule_management_ui** - 规则管理界面（无额外参数）
4. ❌ **config_validation** - 配置验证（无额外参数）
5. ❌ **config_check_api** - 配置检查API（无额外参数）
6. ❌ **stats** - 统计报表（无额外参数）
7. ❌ **monitor** - 监控面板（无额外参数）
8. ❌ **proxy_management** - 反向代理管理（无额外参数）

## 三、配置参数访问方式

### 当前实现
1. **功能开关**：通过 `/api/features` API 管理（功能管理页面）
2. **配置参数**：通过 `/api/config` API 管理（系统设置页面）

### 配置参数存储
- 所有配置参数存储在 `waf_system_config` 表中
- 通过 `config_manager.get_config()` 或 `config.*.enable` 访问
- 支持通过系统设置页面（`/admin/system`）修改

## 四、建议

### 选项 A：保持现状
- 功能开关在功能管理页面管理
- 配置参数在系统设置页面管理
- **优点**：职责清晰，界面简洁
- **缺点**：需要在两个页面之间切换

### 选项 B：在功能管理页面集成配置参数
- 点击功能开关时，展开显示该功能的配置参数
- 可以在同一个页面管理开关和参数
- **优点**：用户体验更好，一站式管理
- **缺点**：需要修改前端和后端代码，增加复杂度

### 选项 C：创建功能配置详情页面
- 为每个有配置参数的功能创建独立的配置页面
- 从功能管理页面跳转到配置页面
- **优点**：配置更详细，支持更多参数
- **缺点**：页面数量增加，导航更复杂

## 五、总结

### 统计
- ✅ **有配置参数**：22 个功能开关
- ❌ **无配置参数**：8 个功能开关

### 配置参数最多的功能
1. **cache_protection** - 8 个参数
2. **auto_block** - 7 个参数
3. **alert** - 8 个参数
4. **cache_optimizer** - 7 个参数

### 配置参数最少的功能
1. **whitelist** - 1 个参数（仅开关）
2. **fallback** - 2 个参数
3. **csrf** - 2 个参数
4. **rate_limit_login** - 2 个参数
5. **rate_limit_api** - 2 个参数

