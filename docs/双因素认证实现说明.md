# 双因素认证（2FA/TOTP）实现说明

## 一、实现架构概述

本系统实现了基于 **TOTP (Time-based One-Time Password)** 的双因素认证，完全兼容 **Google Authenticator** 等主流认证应用。

### 1.1 技术栈
- **标准协议**：RFC 6238 (TOTP)
- **加密算法**：HMAC-SHA1
- **密钥编码**：Base32
- **时间步长**：30秒
- **验证码位数**：6位数字
- **时间窗口**：允许前后1个时间窗口（±30秒）的时钟偏差

### 1.2 核心模块

```
lua/waf/totp.lua          # TOTP核心算法实现
lua/waf/auth.lua          # 用户认证和TOTP密钥管理
lua/api/auth.lua          # TOTP相关API接口
lua/web/user_settings.html # 用户设置页面（2FA配置）
lua/web/login.html         # 登录页面（2FA验证）
lua/config.lua            # TOTP配置
```

---

## 二、核心模块详解

### 2.1 TOTP核心模块 (`lua/waf/totp.lua`)

#### 主要功能函数：

1. **`generate_secret(length)`** - 生成随机密钥
   - 生成指定长度的随机字节
   - Base32编码后返回
   - 默认长度：16字节（Base32编码后约26字符）

2. **`generate_totp(secret_base32, time_step, digits)`** - 生成TOTP验证码
   - 解码Base32密钥
   - 计算当前时间步数（`time / 30`）
   - 使用HMAC-SHA1计算哈希
   - 动态截取生成6位数字验证码

3. **`verify_totp(secret_base32, code, time_step, window)`** - 验证TOTP代码
   - 验证当前时间窗口的代码
   - 允许前后1个时间窗口的偏差（±30秒）
   - 兼容时钟不同步的情况

4. **`generate_qr_data(secret, username, issuer)`** - 生成QR码数据
   - 生成 `otpauth://` URL
   - 返回包含密钥、用户名、发行者的数据对象
   - 支持前端JavaScript生成QR码（内网部署）

5. **`generate_qr_url(secret, username, issuer)`** - 生成QR码URL
   - 根据配置选择本地或外部QR码服务
   - 内网部署建议使用本地模式

#### 关键技术实现：

- **Base32编解码**：完全自主实现，不依赖外部库
- **HMAC-SHA1**：使用OpenResty的`resty.sha1`模块
- **位运算**：兼容性实现，支持无`bit`库的环境
- **时间同步**：允许±30秒的时钟偏差

---

### 2.2 认证模块 (`lua/waf/auth.lua`)

#### TOTP相关函数：

1. **`set_user_totp_secret(username, secret)`** - 设置用户TOTP密钥
   ```lua
   -- 保存到数据库 waf_users 表的 totp_secret 字段
   UPDATE waf_users SET totp_secret = ? WHERE username = ?
   ```

2. **`user_has_totp(username)`** - 检查用户是否启用TOTP
   ```lua
   -- 检查用户的 totp_secret 字段是否非空
   ```

3. **`get_user(username)`** - 获取用户信息（包含TOTP密钥）
   ```lua
   -- 从数据库读取用户信息，包括 totp_secret
   SELECT id, username, password_hash, role, totp_secret, status
   FROM waf_users WHERE username = ?
   ```

#### 登录流程中的TOTP验证：

在 `login()` 函数中：
1. 验证用户名和密码
2. 检查用户是否启用TOTP（`user_has_totp()`）
3. 如果启用，验证TOTP代码（`totp.verify_totp()`）
4. 验证通过后创建会话

---

### 2.3 API接口模块 (`lua/api/auth.lua`)

#### TOTP相关API：

1. **`GET /api/auth/totp/status`** - 获取TOTP状态
   ```lua
   -- 返回当前用户是否启用TOTP
   {
       enabled: true/false,
       username: "用户名"
   }
   ```

2. **`POST /api/auth/totp/setup`** - 设置TOTP（生成密钥和QR码）
   ```lua
   -- 生成新的TOTP密钥
   -- 返回密钥、QR码数据、otpauth URL
   {
       secret: "BASE32密钥",
       qr_data: { otpauth_url, secret, username, issuer },
       qr_generator: "local",
       allow_manual_entry: true
   }
   ```

3. **`POST /api/auth/totp/enable`** - 启用TOTP
   ```lua
   -- 请求体：{ secret: "密钥", code: "6位验证码" }
   -- 验证验证码后，保存密钥到数据库
   -- 记录审计日志
   ```

4. **`POST /api/auth/totp/disable`** - 禁用TOTP
   ```lua
   -- 请求体：{ code: "6位验证码" }
   -- 验证验证码后，清除数据库中的密钥
   -- 记录审计日志
   ```

5. **`POST /api/auth/login`** - 登录（支持TOTP）
   ```lua
   -- 如果用户启用TOTP，需要提供 totp_code
   -- 第一次请求（无TOTP代码）：返回 requires_totp: true
   -- 第二次请求（带TOTP代码）：验证TOTP后登录
   ```

---

## 三、工作流程

### 3.1 启用双因素认证流程

```
用户操作                    前端                   后端API
  |                         |                      |
  |--点击"设置2FA"--------->|                      |
  |                         |--POST /api/auth/totp/setup-->|
  |                         |                      |--生成密钥
  |                         |                      |--生成QR码数据
  |                         |<--返回密钥和QR码数据--|
  |                         |                      |
  |<--显示QR码和密钥--------|                      |
  |                         |                      |
  |--扫描QR码或手动输入密钥 |                      |
  |--输入6位验证码--------->|                      |
  |                         |--POST /api/auth/totp/enable-->|
  |                         |  {secret, code}      |--验证TOTP代码
  |                         |                      |--保存密钥到数据库
  |                         |                      |--记录审计日志
  |                         |<--返回成功-----------|
  |<--显示"已启用"----------|                      |
```

### 3.2 登录流程（启用2FA后）

```
用户操作                    前端                   后端API
  |                         |                      |
  |--输入用户名和密码------->|                      |
  |                         |--POST /api/auth/login-->|
  |                         |  {username, password} |--验证用户名密码
  |                         |                      |--检查是否启用TOTP
  |                         |<--返回requires_totp: true--|
  |                         |                      |
  |<--显示TOTP输入框--------|                      |
  |                         |                      |
  |--输入6位验证码---------->|                      |
  |                         |--POST /api/auth/login-->|
  |                         |  {username, password, totp_code} |
  |                         |                      |--验证TOTP代码
  |                         |                      |--创建会话
  |                         |<--返回登录成功--------|
  |<--跳转到管理页面--------|                      |
```

### 3.3 禁用双因素认证流程

```
用户操作                    前端                   后端API
  |                         |                      |
  |--点击"禁用2FA"--------->|                      |
  |<--确认对话框------------|                      |
  |--输入6位验证码---------->|                      |
  |                         |--POST /api/auth/totp/disable-->|
  |                         |  {code}              |--验证TOTP代码
  |                         |                      |--清除数据库密钥
  |                         |                      |--记录审计日志
  |                         |<--返回成功-----------|
  |<--显示"已禁用"----------|                      |
```

---

## 四、数据库设计

### 4.1 用户表 (`waf_users`)

```sql
CREATE TABLE IF NOT EXISTS waf_users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'user',
    status VARCHAR(20) NOT NULL DEFAULT 'active',
    totp_secret VARCHAR(32) DEFAULT NULL COMMENT 'TOTP密钥（Base32编码的双因素认证密钥，NULL表示未启用双因素认证）',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**关键字段说明：**
- `totp_secret`: VARCHAR(32) - 存储Base32编码的TOTP密钥
  - `NULL` 或空字符串：未启用双因素认证
  - 非空：已启用双因素认证，存储密钥

---

## 五、前端实现

### 5.1 用户设置页面 (`lua/web/user_settings.html`)

#### 主要功能：

1. **显示TOTP状态**
   - 显示"已启用"或"未启用"状态
   - 根据状态显示不同的操作按钮

2. **设置TOTP**
   - 调用 `/api/auth/totp/setup` 生成密钥
   - 显示QR码（支持本地生成或外部服务）
   - 显示密钥（支持手动输入）
   - 输入验证码后调用 `/api/auth/totp/enable` 启用

3. **禁用TOTP**
   - 确认对话框
   - 输入验证码后调用 `/api/auth/totp/disable` 禁用

#### 关键JavaScript函数：

- `loadTotpStatus()` - 加载TOTP状态
- `setupTotp()` - 设置TOTP（生成密钥和QR码）
- `enableTotp()` - 启用TOTP（验证并保存）
- `disableTotp()` - 禁用TOTP（验证后清除）

### 5.2 登录页面 (`lua/web/login.html`)

#### TOTP集成：

1. **动态显示TOTP输入框**
   - 初始状态：隐藏TOTP输入框
   - 第一次登录请求返回 `requires_totp: true` 时显示
   - 用户输入验证码后再次提交

2. **登录流程**
   ```javascript
   // 第一次请求（无TOTP代码）
   POST /api/auth/login
   { username, password }
   
   // 如果返回 requires_totp: true
   // 显示TOTP输入框
   
   // 第二次请求（带TOTP代码）
   POST /api/auth/login
   { username, password, totp_code }
   ```

---

## 六、配置说明

### 6.1 TOTP配置 (`lua/config.lua`)

```lua
_M.totp = {
    -- QR码生成方式：local（本地前端生成）或 external（使用外部服务）
    qr_generator = "local",  -- 内网部署建议使用 "local"
    
    -- 外部QR码服务URL（当qr_generator为"external"时使用）
    external_qr_url = "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=",
    
    -- 是否允许手动输入密钥（当无法扫描QR码时）
    allow_manual_entry = true
}
```

**配置说明：**
- **`qr_generator = "local"`**：内网部署必须使用此选项，前端使用JavaScript QR码库生成
- **`qr_generator = "external"`**：需要外网访问，使用外部QR码服务
- **`allow_manual_entry = true`**：允许用户手动输入密钥，提高兼容性

---

## 七、安全特性

### 7.1 密钥安全

1. **密钥存储**
   - 密钥以Base32编码存储在数据库
   - 密钥仅在设置时生成一次
   - 禁用时从数据库清除

2. **密钥传输**
   - 密钥通过HTTPS传输（生产环境必须）
   - 密钥仅在设置阶段传输，启用后不再传输

### 7.2 验证安全

1. **时间窗口验证**
   - 允许前后1个时间窗口（±30秒）的偏差
   - 兼容服务器和手机时间不同步的情况

2. **验证码验证**
   - 启用TOTP时必须验证验证码
   - 禁用TOTP时必须验证验证码（防止未授权禁用）

### 7.3 审计日志

所有TOTP操作都记录审计日志：
- **设置TOTP**：`log_totp_action("setup", username, success, error)`
- **启用TOTP**：`log_totp_action("enable", username, success, error)`
- **禁用TOTP**：`log_totp_action("disable", username, success, error)`

审计日志记录到 `waf_audit_logs` 表，包含：
- 操作时间
- 用户名
- 操作类型
- 操作状态（成功/失败）
- 错误信息（如有）

---

## 八、兼容性说明

### 8.1 支持的认证应用

- ✅ Google Authenticator
- ✅ Microsoft Authenticator
- ✅ Authy
- ✅ 1Password
- ✅ LastPass Authenticator
- ✅ 其他支持TOTP标准的应用

### 8.2 内网部署支持

✅ **完全支持内网部署**：
- TOTP算法本身不需要网络连接
- 只需要服务器和手机时间同步
- QR码可以使用前端JavaScript库生成
- 支持手动输入密钥

---

## 九、使用示例

### 9.1 用户启用2FA

1. 登录系统，进入"用户设置"页面
2. 找到"双因素认证（2FA）"部分
3. 点击"设置双因素认证"按钮
4. 使用Google Authenticator扫描显示的QR码（或手动输入密钥）
5. 在Google Authenticator中获取6位验证码
6. 输入验证码，点击"启用双因素认证"
7. 系统验证成功后，2FA已启用

### 9.2 用户登录（已启用2FA）

1. 在登录页面输入用户名和密码
2. 点击"登录"
3. 系统提示"请输入双因素认证代码"
4. 打开Google Authenticator，获取当前6位验证码
5. 在登录页面输入验证码
6. 点击"登录"
7. 验证通过后，登录成功

### 9.3 用户禁用2FA

1. 在"用户设置"页面，找到"双因素认证（2FA）"部分
2. 点击"禁用双因素认证"按钮
3. 确认对话框中选择"确定"
4. 输入当前6位验证码
5. 点击"禁用"
6. 系统验证成功后，2FA已禁用

---

## 十、故障排查

### 10.1 验证码错误

**可能原因：**
1. 服务器和手机时间不同步（超过±30秒）
2. 输入错误
3. 密钥不匹配（重新设置）

**解决方案：**
1. 检查服务器时间：`date`
2. 检查手机时间设置
3. 重新设置2FA

### 10.2 QR码无法显示

**可能原因：**
1. 内网部署，无法访问外部QR码服务
2. 前端JavaScript QR码库未加载

**解决方案：**
1. 配置 `qr_generator = "local"`
2. 确保前端加载了QR码生成库（如qrcode.js）
3. 使用手动输入密钥的方式

### 10.3 密钥丢失

**解决方案：**
1. 如果已启用2FA，需要管理员协助禁用
2. 禁用后重新设置2FA

---

## 十一、总结

本系统实现了完整的TOTP双因素认证功能，具有以下特点：

✅ **标准兼容**：完全符合RFC 6238标准，兼容Google Authenticator
✅ **安全可靠**：密钥加密存储，验证码时间窗口验证
✅ **内网支持**：完全支持内网部署，无需外网访问
✅ **用户友好**：支持QR码扫描和手动输入密钥
✅ **审计完整**：所有操作记录审计日志
✅ **易于维护**：模块化设计，代码清晰

---

**文档版本**：v1.0  
**最后更新**：2024年  
**维护者**：WAF开发团队

