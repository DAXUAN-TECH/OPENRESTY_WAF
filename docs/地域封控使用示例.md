# 地域封控使用示例

## 功能说明

地域封控功能支持：
- **国外**：按国家级别封控（如：US, JP, KR）
- **国内**：按省市级别封控（如：CN:Beijing, CN:Shanghai）

## 规则格式

### 1. 国家级别封控（国外）

格式：`国家代码`（ISO 3166-1 alpha-2）

示例：
- `US` - 封控美国
- `JP` - 封控日本
- `KR` - 封控韩国
- `GB` - 封控英国

### 2. 省份级别封控（国内）

格式：`CN:省份名称`

示例：
- `CN:Beijing` - 封控北京
- `CN:Shanghai` - 封控上海
- `CN:Guangdong` - 封控广东
- `CN:Zhejiang` - 封控浙江

### 3. 城市级别封控（国内，精确到城市）

格式：`CN:省份名称:城市名称`

示例：
- `CN:Beijing:Beijing` - 封控北京市
- `CN:Shanghai:Shanghai` - 封控上海市
- `CN:Guangdong:Guangzhou` - 封控广州市

## 匹配优先级

系统会按以下优先级进行匹配（从精确到模糊）：

1. **城市级别**：`CN:Beijing:Beijing`（最精确，优先级最高）
2. **省份级别**：`CN:Beijing`
3. **国家级别**：`CN`

如果匹配到更精确的规则，就不会继续匹配更模糊的规则。

## SQL 示例

### 示例 1：封控整个国家（国外）

```sql
-- 封控美国
INSERT INTO waf_block_rules (rule_type, rule_value, rule_name, description, status, priority)
VALUES ('geo', 'US', '封控美国', '封控所有来自美国的访问', 1, 80);

-- 封控日本
INSERT INTO waf_block_rules (rule_type, rule_value, rule_name, description, status, priority)
VALUES ('geo', 'JP', '封控日本', '封控所有来自日本的访问', 1, 80);

-- 封控韩国
INSERT INTO waf_block_rules (rule_type, rule_value, rule_name, description, status, priority)
VALUES ('geo', 'KR', '封控韩国', '封控所有来自韩国的访问', 1, 80);
```

### 示例 2：封控国内省份

```sql
-- 封控北京
INSERT INTO waf_block_rules (rule_type, rule_value, rule_name, description, status, priority)
VALUES ('geo', 'CN:Beijing', '封控北京', '封控所有来自北京的访问', 1, 90);

-- 封控上海
INSERT INTO waf_block_rules (rule_type, rule_value, rule_name, description, status, priority)
VALUES ('geo', 'CN:Shanghai', '封控上海', '封控所有来自上海的访问', 1, 90);

-- 封控广东
INSERT INTO waf_block_rules (rule_type, rule_value, rule_name, description, status, priority)
VALUES ('geo', 'CN:Guangdong', '封控广东', '封控所有来自广东的访问', 1, 90);

-- 封控浙江
INSERT INTO waf_block_rules (rule_type, rule_value, rule_name, description, status, priority)
VALUES ('geo', 'CN:Zhejiang', '封控浙江', '封控所有来自浙江的访问', 1, 90);
```

### 示例 3：封控国内城市（精确到城市）

```sql
-- 封控北京市（精确到城市）
INSERT INTO waf_block_rules (rule_type, rule_value, rule_name, description, status, priority)
VALUES ('geo', 'CN:Beijing:Beijing', '封控北京市', '封控所有来自北京市的访问', 1, 100);

-- 封控上海市（精确到城市）
INSERT INTO waf_block_rules (rule_type, rule_value, rule_name, description, status, priority)
VALUES ('geo', 'CN:Shanghai:Shanghai', '封控上海市', '封控所有来自上海市的访问', 1, 100);

-- 封控广州市（精确到城市）
INSERT INTO waf_block_rules (rule_type, rule_value, rule_name, description, status, priority)
VALUES ('geo', 'CN:Guangdong:Guangzhou', '封控广州市', '封控所有来自广州市的访问', 1, 100);
```

### 示例 4：批量封控多个国家

```sql
-- 封控多个国家
INSERT INTO waf_block_rules (rule_type, rule_value, rule_name, description, status, priority) VALUES
('geo', 'US', '封控美国', '封控所有来自美国的访问', 1, 80),
('geo', 'JP', '封控日本', '封控所有来自日本的访问', 1, 80),
('geo', 'KR', '封控韩国', '封控所有来自韩国的访问', 1, 80),
('geo', 'GB', '封控英国', '封控所有来自英国的访问', 1, 80);
```

### 示例 5：定时封控（设置生效时间）

```sql
-- 封控北京，仅在特定时间段生效
INSERT INTO waf_block_rules (rule_type, rule_value, rule_name, description, status, priority, start_time, end_time)
VALUES ('geo', 'CN:Beijing', '封控北京-限时', '封控所有来自北京的访问（限时）', 1, 90, 
        '2024-01-01 00:00:00', '2024-12-31 23:59:59');
```

## 查询 IP 的地理位置

在配置规则前，可以先查询 IP 的实际地理位置信息，以确定正确的省份和城市名称：

### 方法 1：通过 Lua 代码查询

```lua
local geo_block = require "waf.geo_block"
local geo_info = geo_block.get_geo_info("8.8.8.8")

-- 返回结果示例：
-- {
--     country_code = "US",
--     country_name = "United States",
--     region_name = "California",
--     city_name = "Mountain View"
-- }
```

### 方法 2：通过在线工具查询

可以使用在线 GeoIP 查询工具，如：
- https://www.maxmind.com/en/geoip-demo
- https://www.ipip.net/ip.html

## 常见省份名称对照

以下是一些常见省份的英文名称（GeoIP2 数据库中的标准名称）：

| 中文名称 | 英文名称（数据库） | 规则值示例 |
|---------|------------------|-----------|
| 北京 | Beijing | CN:Beijing |
| 上海 | Shanghai | CN:Shanghai |
| 广东 | Guangdong | CN:Guangdong |
| 浙江 | Zhejiang | CN:Zhejiang |
| 江苏 | Jiangsu | CN:Jiangsu |
| 四川 | Sichuan | CN:Sichuan |
| 山东 | Shandong | CN:Shandong |
| 河南 | Henan | CN:Henan |
| 湖北 | Hubei | CN:Hubei |
| 湖南 | Hunan | CN:Hunan |

**注意**：省份名称必须与 GeoIP2 数据库中的名称完全一致。建议先查询 IP 获取实际的地理位置信息。

## 管理规则

### 查询所有地域封控规则

```sql
SELECT id, rule_type, rule_value, rule_name, description, status, priority, 
       start_time, end_time, created_at
FROM waf_block_rules
WHERE rule_type = 'geo'
ORDER BY priority DESC, created_at DESC;
```

### 启用/禁用规则

```sql
-- 启用规则
UPDATE waf_block_rules SET status = 1 WHERE id = 1;

-- 禁用规则
UPDATE waf_block_rules SET status = 0 WHERE id = 1;
```

### 删除规则

```sql
DELETE FROM waf_block_rules WHERE id = 1;
```

### 修改规则

```sql
UPDATE waf_block_rules 
SET rule_value = 'CN:Shanghai', 
    rule_name = '封控上海（修改）',
    description = '封控所有来自上海的访问（已修改）',
    priority = 95
WHERE id = 1;
```

## 注意事项

1. **数据库版本**：必须使用 `GeoLite2-City.mmdb`（City 版本），Country 版本不包含省市信息
2. **名称匹配**：省份和城市名称必须与 GeoIP2 数据库中的名称完全一致
3. **匹配优先级**：系统会从精确到模糊进行匹配，优先匹配更精确的规则
4. **缓存机制**：规则匹配结果会缓存 60 秒，修改规则后可能需要等待缓存过期
5. **性能影响**：地域封控会增加一定的查询开销，建议合理使用
6. **数据库更新**：GeoIP2 数据库需要定期更新（建议每月更新一次）

## 测试验证

### 测试封控是否生效

1. 添加测试规则（先禁用，避免误封）：
```sql
INSERT INTO waf_block_rules (rule_type, rule_value, rule_name, status, priority)
VALUES ('geo', 'CN:Beijing', '测试-封控北京', 0, 90);
```

2. 查询规则是否已添加：
```sql
SELECT * FROM waf_block_rules WHERE rule_name = '测试-封控北京';
```

3. 启用规则并测试：
```sql
UPDATE waf_block_rules SET status = 1 WHERE rule_name = '测试-封控北京';
```

4. 从北京 IP 访问，应该返回 403

5. 测试完成后删除规则：
```sql
DELETE FROM waf_block_rules WHERE rule_name = '测试-封控北京';
```

## 故障排查

### 问题 1：规则不生效

**可能原因**：
- 数据库文件不存在或路径错误
- 地域封控功能未启用（`config.geo.enable = false`）
- 规则状态为禁用（`status = 0`）
- 规则值格式不正确
- 缓存未过期

**解决方法**：
1. 检查数据库文件是否存在
2. 检查配置文件中的 `geo.enable` 设置
3. 检查规则状态和格式
4. 等待缓存过期或重启服务

### 问题 2：省份名称不匹配

**可能原因**：
- 省份名称与数据库中的名称不一致
- 使用了中文名称而不是英文名称

**解决方法**：
1. 先查询 IP 获取实际的地理位置信息
2. 使用查询结果中的省份名称
3. 参考常见省份名称对照表

### 问题 3：性能问题

**可能原因**：
- 规则数量过多
- 数据库文件过大
- 缓存未生效

**解决方法**：
1. 优化规则数量，合并相似规则
2. 确保缓存机制正常工作
3. 考虑使用 Redis 分布式缓存

