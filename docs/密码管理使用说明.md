# 密码管理使用说明

## 概述

WAF系统提供了完整的密码管理功能，支持BCrypt密码哈希、密码强度检查和随机密码生成。

## 安装BCrypt库

在生产环境使用前，需要安装BCrypt库：

```bash
opm get openresty/lua-resty-bcrypt
```

## API接口

### 1. 生成密码哈希

**接口**：`POST /api/auth/password/hash`

**权限**：需要管理员权限

**请求参数**：
```json
{
    "password": "your_password",
    "cost": 10  // 可选，BCrypt成本因子（4-31，默认10）
}
```

**响应示例**：
```json
{
    "success": true,
    "hash": "$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy",
    "strength": {
        "valid": true,
        "strength": "strong",
        "score": 5,
        "checks": {
            "length_ok": true,
            "has_upper": true,
            "has_lower": true,
            "has_digit": true,
            "has_special": true
        }
    },
    "message": "密码哈希生成成功"
}
```

**使用示例**：
```bash
curl -X POST http://localhost/api/auth/password/hash \
  -H "Content-Type: application/json" \
  -H "Cookie: waf_session=your_session_id" \
  -d '{"password": "MySecurePassword123!", "cost": 10}'
```

### 2. 检查密码强度

**接口**：`POST /api/auth/password/check`

**权限**：需要登录

**请求参数**：
```json
{
    "password": "your_password"
}
```

**响应示例**：
```json
{
    "valid": true,
    "strength": "strong",
    "score": 5,
    "checks": {
        "length_ok": true,
        "has_upper": true,
        "has_lower": true,
        "has_digit": true,
        "has_special": true
    }
}
```

**密码强度等级**：
- `weak`: 分数 < 3
- `medium`: 分数 3-4
- `strong`: 分数 >= 4

### 3. 生成随机密码

**接口**：`POST /api/auth/password/generate`

**权限**：需要管理员权限

**请求参数**：
```json
{
    "length": 16  // 可选，密码长度（8-128，默认16）
}
```

**响应示例**：
```json
{
    "success": true,
    "password": "aB3$kL9mN2pQ5rS",
    "strength": {
        "valid": true,
        "strength": "strong",
        "score": 5,
        "checks": {
            "length_ok": true,
            "has_upper": true,
            "has_lower": true,
            "has_digit": true,
            "has_special": true
        }
    },
    "message": "随机密码生成成功"
}
```

## 数据库操作

### 创建用户并设置BCrypt密码

1. **生成密码哈希**（使用API或Lua代码）：
```lua
local password_utils = require "waf.password_utils"
local hash, err = password_utils.hash_password("MySecurePassword123!", 10)
```

2. **插入用户到数据库**：
```sql
INSERT INTO waf_users (username, password_hash, role, status)
VALUES ('admin', '$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy', 'admin', 1);
```

### 更新用户密码

1. **生成新密码哈希**（使用API）
2. **更新数据库**：
```sql
UPDATE waf_users 
SET password_hash = '$2a$10$...', updated_at = NOW()
WHERE username = 'admin';
```

## 密码强度要求

系统会检查以下密码强度指标：

1. **长度**：至少8位
2. **大写字母**：包含至少一个大写字母
3. **小写字母**：包含至少一个小写字母
4. **数字**：包含至少一个数字
5. **特殊字符**：包含至少一个特殊字符或下划线

**建议**：
- 生产环境密码长度至少12位
- 使用强密码（包含大小写字母、数字、特殊字符）
- 定期更换密码
- 不要在多个系统使用相同密码

## BCrypt成本因子

BCrypt成本因子决定了哈希计算的复杂度：

- **成本因子范围**：4-31
- **默认值**：10
- **推荐值**：
  - 开发/测试：8-10
  - 生产环境：10-12
  - 高安全要求：12-14

**注意**：成本因子每增加1，计算时间大约增加2倍。

## 安全建议

1. **生产环境必须使用BCrypt**
   - 安装 `resty.bcrypt` 库
   - 所有密码使用BCrypt哈希存储
   - 不要使用简单哈希比较

2. **密码策略**
   - 强制使用强密码
   - 定期更换密码
   - 限制密码尝试次数
   - 记录密码修改日志

3. **密码存储**
   - 永远不要存储明文密码
   - 使用BCrypt哈希存储
   - 定期备份用户表

4. **密码传输**
   - 使用HTTPS传输密码
   - 不要在URL中传递密码
   - 使用POST方法提交密码

## 故障排查

### 问题1：BCrypt库未安装

**错误**：`BCrypt library (resty.bcrypt) is not available`

**解决**：
```bash
opm get openresty/lua-resty-bcrypt
```

### 问题2：密码验证失败

**可能原因**：
1. BCrypt哈希格式不正确
2. 密码不匹配
3. BCrypt库未正确安装

**解决**：
1. 检查密码哈希格式（应以`$2a$`、`$2b$`或`$2y$`开头）
2. 确认密码正确
3. 重新安装BCrypt库

### 问题3：密码强度检查失败

**错误**：`密码长度至少8位`

**解决**：
- 使用至少8位密码
- 包含大小写字母、数字、特殊字符

## 示例代码

### Lua代码示例

```lua
local password_utils = require "waf.password_utils"

-- 生成密码哈希
local hash, err = password_utils.hash_password("MyPassword123!", 10)
if hash then
    ngx.log(ngx.INFO, "Password hash: ", hash)
else
    ngx.log(ngx.ERR, "Failed to hash password: ", err)
end

-- 验证密码
local verify_ok, err = password_utils.verify_password("MyPassword123!", hash)
if verify_ok then
    ngx.log(ngx.INFO, "Password verified")
else
    ngx.log(ngx.ERR, "Password verification failed: ", err)
end

-- 检查密码强度
local strength = password_utils.check_password_strength("MyPassword123!")
ngx.log(ngx.INFO, "Password strength: ", strength.strength)

-- 生成随机密码
local random_password = password_utils.generate_random_password(16)
ngx.log(ngx.INFO, "Random password: ", random_password)
```

## 相关文档

- [代码完善总结](代码完善总结.md)
- [代码优化总结](代码优化总结.md)
- [TOTP内网部署说明](TOTP内网部署说明.md)

