# OpenResty WAF 高性能并发优化指南

## 概述

本文档提供了 OpenResty WAF 系统的高性能并发优化配置，旨在承载最大负载并发。

## 理论最大并发计算

```
最大并发连接数 = worker_processes × worker_connections
```

**示例**：
- 8 个 worker 进程
- 每个 worker 65535 个连接
- **理论最大并发 = 8 × 65535 = 524,280 连接**

## 配置文件优化

### 1. nginx.conf 优化

#### Worker 进程配置
```nginx
worker_processes auto;  # 自动检测 CPU 核心数
```

**建议**：
- 生产环境：设置为 CPU 核心数
- 高并发场景：可以设置为 CPU 核心数的 1.5-2 倍（如果 CPU 性能足够）

#### Events 配置
```nginx
events {
    worker_connections 65535;  # 从 10240 提升到 65535
    use epoll;                 # Linux 系统最佳事件模型
    multi_accept on;           # 允许同时接受多个连接
    accept_mutex off;          # 高并发场景关闭互斥锁
}
```

### 2. performance.conf（新增）

包含以下优化配置：

#### 缓冲区优化
- `client_header_buffer_size`: 64k
- `large_client_header_buffers`: 4 × 64k
- `client_body_buffer_size`: 128k
- `proxy_buffers`: 8 × 64k

#### 超时优化
- `keepalive_timeout`: 75s
- `keepalive_requests`: 10000（每个连接最多处理 10000 个请求）
- 各种代理超时：60s

#### 文件传输优化
- `sendfile`: on（零拷贝）
- `sendfile_max_chunk`: 512k
- `open_file_cache`: 缓存文件描述符

### 3. upstream.conf 优化

```nginx
upstream backend {
    server 127.0.0.1:8080;
    keepalive 1024;           # 从 32 增加到 1024
    keepalive_requests 10000;
    keepalive_timeout 60s;
}
```

**关键优化点**：
- `keepalive 1024`: 每个 worker 保持 1024 个到后端的 keepalive 连接
- 大幅减少连接建立和关闭的开销

### 4. server/default.conf 优化

```nginx
location / {
    proxy_http_version 1.1;    # 启用 HTTP/1.1
    proxy_set_header Connection "";  # 启用 keepalive
}
```

## 系统级优化

### 1. 文件描述符限制

编辑 `/etc/security/limits.conf`：

```bash
* soft nofile 65535
* hard nofile 65535
root soft nofile 65535
root hard nofile 65535
```

应用配置：
```bash
ulimit -n 65535
```

### 2. 系统内核参数优化

编辑 `/etc/sysctl.conf`：

```bash
# 文件描述符限制
fs.file-max = 1000000

# 网络参数优化
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 65535
net.ipv4.tcp_max_syn_backlog = 65535

# TCP 参数优化
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_keepalive_probes = 5
net.ipv4.tcp_keepalive_intvl = 15

# 端口范围
net.ipv4.ip_local_port_range = 1024 65535

# 连接跟踪（如果使用防火墙）
# net.netfilter.nf_conntrack_max = 1000000
```

应用配置：
```bash
sudo sysctl -p
```

### 3. 网络优化

```bash
# 增加 TCP 连接队列大小
echo 'net.core.somaxconn = 65535' | sudo tee -a /etc/sysctl.conf
echo 'net.ipv4.tcp_max_syn_backlog = 65535' | sudo tee -a /etc/sysctl.conf

# 优化 TCP 连接回收
echo 'net.ipv4.tcp_tw_reuse = 1' | sudo tee -a /etc/sysctl.conf
echo 'net.ipv4.tcp_fin_timeout = 30' | sudo tee -a /etc/sysctl.conf

sudo sysctl -p
```

## 应用层优化

### 1. MySQL 连接池优化

编辑 `lua/config.lua`：

```lua
_M.mysql = {
    pool_size = 100,  -- 从 50 增加到 100
    pool_timeout = 10000,
}
```

### 2. WAF 缓存优化

编辑 `conf.d/http_set/waf.conf`：

```nginx
lua_shared_dict waf_cache 50m;      # 从 10m 增加到 50m
lua_shared_dict waf_log_buffer 100m; # 从 50m 增加到 100m
```

### 3. 日志优化

在高并发场景下，可以考虑：

```nginx
# 关闭访问日志（如果不需要）
access_log off;

# 或使用缓冲日志
access_log logs/access.log main buffer=32k flush=5s;
```

## 性能测试

### 1. 压力测试工具

```bash
# 使用 wrk 进行压力测试
wrk -t8 -c1000 -d30s http://localhost/

# 使用 ab 进行压力测试
ab -n 100000 -c 1000 http://localhost/

# 使用 Apache Bench
ab -n 100000 -c 1000 -k http://localhost/
```

### 2. 监控指标

```bash
# 查看连接数
netstat -an | grep :80 | wc -l

# 查看进程状态
ps aux | grep nginx

# 查看系统负载
top
htop

# 查看网络连接
ss -s
```

## 性能调优建议

### 1. 根据实际负载调整

- **低并发场景**（< 1000 连接）：
  - `worker_connections`: 10240
  - `keepalive`: 32

- **中并发场景**（1000-10000 连接）：
  - `worker_connections`: 32768
  - `keepalive`: 512

- **高并发场景**（> 10000 连接）：
  - `worker_connections`: 65535
  - `keepalive`: 1024

### 2. 内存使用估算

```
总内存需求 ≈ 
  worker_processes × (
    worker_connections × 平均连接内存 +
    共享内存大小
  )
```

**示例**：
- 8 workers
- 65535 connections/worker
- 平均 10KB/connection
- 共享内存 150MB

```
总内存 ≈ 8 × (65535 × 10KB + 150MB) ≈ 5.5GB
```

### 3. CPU 使用优化

- 使用 `worker_processes auto` 自动检测 CPU 核心数
- 监控 CPU 使用率，避免过载
- 考虑使用 CPU 亲和性绑定（`worker_cpu_affinity`）

## 故障排查

### 1. 连接数达到上限

**症状**：`worker_connections are not enough`

**解决**：
- 增加 `worker_connections`
- 增加 `worker_processes`
- 检查系统文件描述符限制

### 2. 内存不足

**症状**：OOM（Out of Memory）

**解决**：
- 减少缓冲区大小
- 减少 `worker_connections`
- 增加服务器内存

### 3. 后端连接失败

**症状**：`upstream timed out`

**解决**：
- 增加 `keepalive` 连接数
- 检查后端服务器性能
- 优化后端应用

## 监控和告警

### 1. 关键指标

- 并发连接数
- 请求处理速率（QPS）
- 响应时间
- 错误率
- CPU 使用率
- 内存使用率

### 2. 告警阈值

- 并发连接数 > 理论最大值的 80%
- 响应时间 > 1 秒
- 错误率 > 1%
- CPU 使用率 > 80%
- 内存使用率 > 90%

## 总结

通过以上优化，OpenResty WAF 系统可以支持：

- **理论最大并发**：524,280 连接（8 workers × 65535）
- **实际建议并发**：根据服务器配置和实际负载调整
- **QPS 能力**：10,000+ QPS（取决于规则复杂度和后端性能）

**重要提示**：
1. 优化需要根据实际环境调整
2. 建议逐步增加并发数，观察系统表现
3. 定期监控系统资源使用情况
4. 做好压力测试和容量规划

