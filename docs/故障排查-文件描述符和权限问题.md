# 故障排查：文件描述符和权限问题

## 问题 1：文件描述符限制

### 错误信息

```
65535 worker_connections exceed open file resource limit: 1024
```

### 问题说明

Nginx 配置了 `worker_connections 65535`，但系统默认的文件描述符限制只有 1024，导致无法创建足够的连接。

### 解决方案

#### 方法 1：临时增加限制（当前会话有效）

```bash
# 查看当前限制
ulimit -n

# 临时增加限制
ulimit -n 65535
```

#### 方法 2：永久增加限制（推荐）

编辑 `/etc/security/limits.conf`：

```bash
sudo vi /etc/security/limits.conf
```

添加以下内容：

```
# OpenResty WAF 文件描述符限制
* soft nofile 65535
* hard nofile 65535
root soft nofile 65535
root hard nofile 65535
nobody soft nofile 65535
nobody hard nofile 65535
```

**说明**：
- `*` 表示所有用户
- `soft` 表示软限制（警告阈值）
- `hard` 表示硬限制（最大允许值）
- `nofile` 表示打开文件数限制
- `nobody` 是 nginx worker 进程的用户

#### 方法 3：通过 systemd 服务文件设置

如果使用 systemd 管理 OpenResty 服务，编辑服务文件：

```bash
sudo vi /etc/systemd/system/openresty.service
```

在 `[Service]` 部分添加：

```ini
[Service]
LimitNOFILE=65535
```

然后重新加载 systemd 配置：

```bash
sudo systemctl daemon-reload
sudo systemctl restart openresty
```

#### 方法 4：降低 worker_connections（不推荐）

如果无法增加系统限制，可以降低 `worker_connections` 的值：

编辑 `init_file/nginx.conf`：

```nginx
events {
    worker_connections  1024;  # 降低到系统限制以下
}
```

然后重新部署：

```bash
sudo ./scripts/deploy.sh
sudo systemctl restart openresty
```

### 验证

```bash
# 查看当前限制
ulimit -n

# 查看 nginx worker 进程的限制
cat /proc/$(pgrep -f "nginx: worker" | head -1)/limits | grep "Max open files"

# 重启 OpenResty 后检查错误日志
tail -f /data/OPENRESTY_WAF/logs/error.log
```

## 问题 2：配置文件创建失败

### 错误信息

```
无法创建Stream代理配置文件: /data/OPENRESTY_WAF/conf.d/vhost_conf/proxy_stream_2.conf
```

### 问题说明

Nginx worker 进程（通常以 `nobody` 用户运行）没有写入 `conf.d` 目录的权限，导致无法创建配置文件。

### 解决方案

#### 方法 1：使用部署脚本自动设置权限（推荐）

```bash
cd /data/OPENRESTY_WAF
sudo ./scripts/deploy.sh
```

部署脚本会自动设置正确的权限。

#### 方法 2：手动设置权限

```bash
# 设置 conf.d 目录及其子目录的所有者为 nobody:nobody
sudo chown -R nobody:nobody /data/OPENRESTY_WAF/conf.d

# 设置目录权限为 755（所有者可读写执行，其他用户可读执行）
sudo chmod -R 755 /data/OPENRESTY_WAF/conf.d

# 设置配置文件权限为 644（所有者可读写，其他用户可读）
sudo find /data/OPENRESTY_WAF/conf.d -type f -name "*.conf" -exec chmod 644 {} \;
```

#### 方法 3：检查 SELinux 或 AppArmor（如果启用）

如果系统启用了 SELinux 或 AppArmor，可能需要调整安全策略：

**SELinux**：
```bash
# 检查 SELinux 状态
getenforce

# 如果启用，设置目录上下文
sudo chcon -R -t httpd_sys_rw_content_t /data/OPENRESTY_WAF/conf.d
```

**AppArmor**：
```bash
# 检查 AppArmor 状态
sudo aa-status

# 如果启用，可能需要修改 AppArmor 配置文件
```

### 验证

```bash
# 检查目录所有者和权限
ls -ld /data/OPENRESTY_WAF/conf.d
ls -ld /data/OPENRESTY_WAF/conf.d/vhost_conf
ls -ld /data/OPENRESTY_WAF/conf.d/upstream

# 检查 nginx worker 进程的用户
ps aux | grep "nginx: worker" | head -1

# 测试写入权限（以 nobody 用户身份）
sudo -u nobody touch /data/OPENRESTY_WAF/conf.d/vhost_conf/.test_write
sudo -u nobody rm /data/OPENRESTY_WAF/conf.d/vhost_conf/.test_write

# 如果测试成功，说明权限正确
```

### 常见权限问题

#### 问题 1：目录所有者不正确

**错误**：目录所有者是 root 或其他用户

**解决**：
```bash
sudo chown -R nobody:nobody /data/OPENRESTY_WAF/conf.d
```

#### 问题 2：目录权限不足

**错误**：目录权限是 700 或其他限制性权限

**解决**：
```bash
sudo chmod -R 755 /data/OPENRESTY_WAF/conf.d
```

#### 问题 3：父目录权限不足

**错误**：`/data/OPENRESTY_WAF` 目录权限不足

**解决**：
```bash
# 确保项目根目录有执行权限（允许进入目录）
sudo chmod 755 /data/OPENRESTY_WAF
```

#### 问题 4：磁盘空间不足

**错误**：磁盘空间或 inode 不足

**解决**：
```bash
# 检查磁盘空间
df -h /data/OPENRESTY_WAF

# 检查 inode 使用情况
df -i /data/OPENRESTY_WAF

# 清理不需要的文件
```

## 问题 3：同时出现两个问题

如果同时出现文件描述符限制和权限问题，按以下顺序解决：

1. **先解决文件描述符限制**（问题 1）
   - 增加系统文件描述符限制
   - 重启 OpenResty 服务

2. **再解决权限问题**（问题 2）
   - 设置正确的目录权限
   - 验证权限设置

3. **验证修复**
   - 检查错误日志
   - 尝试创建代理配置
   - 确认配置文件成功创建

## 预防措施

### 1. 部署脚本自动设置

部署脚本 `scripts/deploy.sh` 会自动设置正确的权限，建议每次部署后运行：

```bash
sudo ./scripts/deploy.sh
```

### 2. 系统优化脚本

运行系统优化脚本，自动配置文件描述符限制：

```bash
sudo ./scripts/optimize_system.sh
```

### 3. 定期检查

定期检查权限和限制：

```bash
# 检查文件描述符限制
ulimit -n

# 检查目录权限
ls -ld /data/OPENRESTY_WAF/conf.d

# 检查错误日志
tail -n 50 /data/OPENRESTY_WAF/logs/error.log | grep -i "permission\|limit\|file"
```

## 相关文档

- [部署文档](../docs/部署文档.md)
- [系统优化指南](../docs/性能优化指南.md)
- [部署脚本说明](../scripts/deploy_README.md)

