# 数据库时区设置说明

## 问题说明

如果日志时间显示不正确（例如显示的时间比实际时间晚8小时），可能是以下原因：

1. **代码使用了 UTC 时间**：代码中使用了 `os.date("!%Y-%m-%d %H:%M:%S", time)`，其中 `!` 表示 UTC 时间
2. **数据库时区设置不正确**：MySQL 数据库的时区设置与服务器时区不一致

## 解决方案

### 方案1：设置数据库时区为本地时区（推荐）

如果服务器在中国（UTC+8），建议将数据库时区设置为 `Asia/Shanghai`：

```sql
-- 查看当前时区
SELECT @@global.time_zone, @@session.time_zone;

-- 设置全局时区（需要 root 权限）
SET GLOBAL time_zone = '+08:00';
-- 或者
SET GLOBAL time_zone = 'Asia/Shanghai';

-- 设置当前会话时区
SET time_zone = '+08:00';
-- 或者
SET time_zone = 'Asia/Shanghai';
```

**永久设置（修改配置文件）**：

编辑 MySQL 配置文件（通常是 `/etc/my.cnf` 或 `/etc/mysql/my.cnf`）：

```ini
[mysqld]
default-time-zone = '+08:00'
# 或者
default-time-zone = 'Asia/Shanghai'
```

然后重启 MySQL：

```bash
# CentOS/RHEL
systemctl restart mysqld
# 或者
systemctl restart mysql

# Ubuntu/Debian
systemctl restart mysql
```

### 方案2：检查服务器系统时区

确保服务器系统时区设置正确：

```bash
# 查看当前时区
timedatectl

# 设置时区（中国）
timedatectl set-timezone Asia/Shanghai

# 或者使用 tzselect 交互式选择
tzselect
```

### 方案3：统一使用 UTC 时间

如果希望统一使用 UTC 时间，可以：

1. 保持代码使用 UTC 时间（`os.date("!%Y-%m-%d %H:%M:%S", time)`）
2. 设置数据库时区为 UTC：

```sql
SET GLOBAL time_zone = '+00:00';
```

3. 在前端显示时转换为本地时间

## 验证时区设置

### 验证数据库时区

```sql
-- 查看数据库时区
SELECT @@global.time_zone, @@session.time_zone;

-- 查看当前时间
SELECT NOW(), UTC_TIMESTAMP();

-- 查看时区偏移
SELECT TIMEDIFF(NOW(), UTC_TIMESTAMP());
```

### 验证系统时区

```bash
# 查看系统时区
date
timedatectl

# 查看时区文件
ls -la /etc/localtime
```

## 注意事项

1. **代码已修复**：代码已修改为使用本地时间（移除了 `!` 符号），不再使用 UTC 时间
2. **数据库时区**：建议将数据库时区设置为与服务器相同的时区
3. **NOW() 函数**：MySQL 的 `NOW()` 函数会使用数据库的时区设置
4. **一致性**：确保服务器时区、数据库时区和代码使用的时区保持一致

## 常见时区对照

| 时区名称 | UTC偏移 | 说明 |
|---------|---------|------|
| Asia/Shanghai | +08:00 | 中国标准时间（CST） |
| Asia/Hong_Kong | +08:00 | 香港时间 |
| Asia/Taipei | +08:00 | 台北时间 |
| UTC | +00:00 | 协调世界时 |
| America/New_York | -05:00 | 美国东部时间 |

## 相关文件

- `lua/waf/log_collect.lua` - 访问日志采集
- `lua/waf/log_queue.lua` - 日志队列处理
- `lua/waf/ip_block.lua` - IP封控日志
- `lua/waf/auto_unblock.lua` - 自动解封日志

