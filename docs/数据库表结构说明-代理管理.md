# 数据库表结构说明 - 代理管理

## 概述

代理管理功能使用两个核心数据表来实现：
- **waf_proxy_configs**：代理配置主表（一个代理配置一条记录）
- **waf_proxy_backends**：后端服务器表（一个代理配置可以有多个后端服务器）

这两个表采用**一对多（1:N）**的关系设计，用于支持负载均衡功能。

---

## 表关系图

```
waf_proxy_configs (主表)
    │
    │ 1:N (一个代理配置可以有多个后端服务器)
    │
    └──> waf_proxy_backends (从表)
            └── proxy_id (外键，关联到 waf_proxy_configs.id)
```

---

## 1. waf_proxy_configs（代理配置主表）

### 表作用
存储代理配置的**基本信息**，每个代理配置对应**一条记录**。

### 主要字段

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `id` | INT UNSIGNED | 主键ID，自增 | 1 |
| `proxy_name` | VARCHAR(100) | 代理配置名称（唯一） | "MySQL代理" |
| `proxy_type` | VARCHAR(20) | 代理类型 | http / tcp / udp |
| `listen_port` | INT UNSIGNED | 监听端口 | 80, 443, 3306 |
| `listen_address` | VARCHAR(45) | 监听地址 | 0.0.0.0 |
| `server_name` | VARCHAR(255) | 服务器名称（HTTP代理） | example.com |
| `location_path` | VARCHAR(255) | 路径匹配（HTTP代理） | /, /api/ |
| `backend_type` | VARCHAR(20) | 后端类型 | upstream（固定值） |
| `load_balance` | VARCHAR(20) | 负载均衡算法 | round_robin / least_conn / ip_hash |
| `proxy_timeout` | INT | 代理超时（秒） | 60 |
| `proxy_connect_timeout` | INT | 连接超时（秒） | 60 |
| `ssl_enable` | TINYINT | 是否启用SSL | 0 / 1 |
| `ip_rule_id` | BIGINT UNSIGNED | 防护规则ID | 关联 waf_block_rules |
| `status` | TINYINT | 状态：1-启用，0-禁用 | 1 |
| `priority` | INT | 优先级 | 0 |

### 存储内容
- ✅ 代理的基本配置（名称、类型、端口、地址）
- ✅ 代理的全局设置（超时、SSL、负载均衡算法）
- ✅ 代理的状态和优先级
- ❌ **不存储后端服务器列表**（后端服务器存储在 waf_proxy_backends 表中）

### 示例数据
```sql
id: 1
proxy_name: "MySQL代理"
proxy_type: "tcp"
listen_port: 3336
listen_address: "0.0.0.0"
backend_type: "upstream"
load_balance: "round_robin"
status: 1
```

---

## 2. waf_proxy_backends（后端服务器表）

### 表作用
存储每个代理配置的**后端服务器列表**，一个代理配置可以对应**多条记录**（支持多个后端服务器实现负载均衡）。

### 主要字段

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `id` | INT UNSIGNED | 主键ID，自增 | 1 |
| `proxy_id` | INT UNSIGNED | 代理配置ID（外键） | 关联 waf_proxy_configs.id |
| `backend_address` | VARCHAR(255) | 后端服务器地址 | 192.168.1.10 |
| `backend_port` | INT UNSIGNED | 后端服务器端口 | 3306 |
| `backend_path` | VARCHAR(255) | 后端路径（HTTP/HTTPS） | /api, /v1 |
| `weight` | INT UNSIGNED | 权重（负载均衡） | 1, 2, 3 |
| `max_fails` | INT | 最大失败次数 | 3 |
| `fail_timeout` | INT | 失败超时（秒） | 30 |
| `backup` | TINYINT | 是否为备用服务器 | 0 / 1 |
| `down` | TINYINT | 是否手动下线 | 0 / 1 |
| `status` | TINYINT | 状态：1-启用，0-禁用 | 1 |

### 存储内容
- ✅ 后端服务器的地址和端口
- ✅ 后端服务器的负载均衡参数（权重、失败次数、超时）
- ✅ 后端服务器的状态（启用/禁用、备用/主用、上线/下线）
- ✅ HTTP/HTTPS代理的后端路径（TCP/UDP代理此字段为NULL）

### 示例数据
```sql
-- 代理ID为1的MySQL代理有两个后端服务器
id: 1, proxy_id: 1, backend_address: "192.168.1.10", backend_port: 3306, weight: 1, status: 1
id: 2, proxy_id: 1, backend_address: "192.168.1.11", backend_port: 3306, weight: 1, status: 1
```

---

## 表关系说明

### 外键关系
```sql
FOREIGN KEY (proxy_id) REFERENCES waf_proxy_configs(id) ON DELETE CASCADE
```

- **关联字段**：`waf_proxy_backends.proxy_id` → `waf_proxy_configs.id`
- **级联删除**：删除代理配置时，自动删除其所有后端服务器记录

### 查询示例

#### 查询代理配置及其后端服务器
```sql
-- 查询代理配置
SELECT * FROM waf_proxy_configs WHERE id = 1;

-- 查询该代理的后端服务器
SELECT * FROM waf_proxy_backends WHERE proxy_id = 1 AND status = 1;
```

#### 联合查询
```sql
SELECT 
    p.id,
    p.proxy_name,
    p.proxy_type,
    p.listen_port,
    b.backend_address,
    b.backend_port,
    b.weight
FROM waf_proxy_configs p
LEFT JOIN waf_proxy_backends b ON p.id = b.proxy_id AND b.status = 1
WHERE p.id = 1;
```

---

## 设计优势

### 1. 支持负载均衡
- 一个代理配置可以配置多个后端服务器
- 通过 `weight` 字段实现权重分配
- 通过 `backup` 字段实现主备切换

### 2. 灵活的后端管理
- 可以单独启用/禁用某个后端服务器
- 可以手动标记后端服务器为下线（`down`）
- 可以动态添加/删除后端服务器，无需修改主配置

### 3. 数据规范化
- 避免在主表中存储多个后端服务器的冗余数据
- 符合数据库第三范式（3NF）设计原则
- 便于维护和扩展

### 4. 性能优化
- 主表查询快速（代理配置基本信息）
- 后端服务器表有联合索引 `idx_proxy_id_status`，查询特定代理的启用后端速度快
- 支持按需加载后端服务器列表

---

## 使用场景

### 场景1：创建HTTP代理（负载均衡）
```sql
-- 1. 创建代理配置
INSERT INTO waf_proxy_configs (proxy_name, proxy_type, listen_port, ...) 
VALUES ('Web服务代理', 'http', 80, ...);

-- 假设返回的ID是 1

-- 2. 添加多个后端服务器
INSERT INTO waf_proxy_backends (proxy_id, backend_address, backend_port, weight) 
VALUES 
    (1, '192.168.1.20', 8080, 2),
    (1, '192.168.1.21', 8080, 2),
    (1, '192.168.1.22', 8080, 1);
```

### 场景2：创建TCP代理（MySQL负载均衡）
```sql
-- 1. 创建代理配置
INSERT INTO waf_proxy_configs (proxy_name, proxy_type, listen_port, ...) 
VALUES ('MySQL代理', 'tcp', 3336, ...);

-- 假设返回的ID是 2

-- 2. 添加多个后端服务器（注意：backend_path 为 NULL）
INSERT INTO waf_proxy_backends (proxy_id, backend_address, backend_port, weight) 
VALUES 
    (2, '192.168.1.30', 3306, 1),
    (2, '192.168.1.31', 3306, 1);
```

### 场景3：禁用某个后端服务器
```sql
-- 禁用ID为5的后端服务器
UPDATE waf_proxy_backends SET status = 0 WHERE id = 5;
```

### 场景4：删除代理配置（级联删除）
```sql
-- 删除代理配置，后端服务器会自动删除（ON DELETE CASCADE）
DELETE FROM waf_proxy_configs WHERE id = 1;
```

---

## 注意事项

### 1. backend_path 字段
- **HTTP/HTTPS代理**：可以配置 `backend_path`（如 `/api`, `/v1`）
- **TCP/UDP代理**：`backend_path` 必须为 `NULL`（TCP/UDP协议不支持路径）

### 2. backend_address 和 backend_port（已废弃）
- `waf_proxy_configs` 表中的 `backend_address` 和 `backend_port` 字段已不再使用
- 现在所有代理都使用 `upstream` 类型，后端服务器信息存储在 `waf_proxy_backends` 表中
- 为了兼容数据库结构，这些字段仍然保留，但插入时传入 `NULL`

### 3. 后端服务器必须存在
- 创建代理配置时，必须至少添加一个后端服务器
- 后端服务器列表不能为空

### 4. 负载均衡算法
- `round_robin`：轮询（默认）
- `least_conn`：最少连接
- `ip_hash`：IP哈希（会话保持）

---

## 总结

| 对比项 | waf_proxy_configs | waf_proxy_backends |
|--------|-------------------|-------------------|
| **作用** | 存储代理配置基本信息 | 存储后端服务器列表 |
| **关系** | 主表（1） | 从表（N） |
| **记录数** | 一个代理一条记录 | 一个代理多条记录 |
| **存储内容** | 代理的全局配置 | 后端服务器的详细信息 |
| **查询频率** | 高（基本信息） | 中（按需加载） |
| **更新频率** | 低（配置变更） | 中（后端服务器管理） |

---

## 相关文件

- 数据库初始化脚本：`init_file/init.sql`
- 数据库迁移脚本：`scripts/migrate_add_backend_path.sql`
- 代理管理模块：`lua/waf/proxy_management.lua`
- Nginx配置生成：`lua/waf/nginx_config_generator.lua`

