# 日志查看说明

## 日志文件位置

### 错误日志（Error Log）
- **路径**: `$project_root/logs/error.log`
- **默认路径**: `/data/OPENRESTY_WAF/logs/error.log`
- **内容**: Nginx/OpenResty 的错误日志，包括 Lua 脚本的所有 `ngx.log()` 输出

### 访问日志（Access Log）
- **路径**: `$project_root/logs/access.log`
- **默认路径**: `/data/OPENRESTY_WAF/logs/access.log`
- **内容**: HTTP 访问日志，记录所有客户端请求

## 查看日志命令

### 实时查看错误日志
```bash
# 查看最新的错误日志
tail -f /data/OPENRESTY_WAF/logs/error.log

# 或者使用相对路径（在项目目录下）
tail -f logs/error.log
```

### 实时查看访问日志
```bash
# 查看最新的访问日志
tail -f /data/OPENRESTY_WAF/logs/access.log

# 或者使用相对路径（在项目目录下）
tail -f logs/access.log
```

### 查看最近的日志
```bash
# 查看最近 100 行错误日志
tail -n 100 logs/error.log

# 查看最近 50 行访问日志
tail -n 50 logs/access.log
```

### 搜索特定内容
```bash
# 搜索登录相关的日志
grep -i "login\|auth\|verify_credentials" logs/error.log

# 搜索错误信息
grep -i "error\|failed" logs/error.log

# 搜索特定用户的日志
grep "admin" logs/error.log
```

## 日志级别

### Nginx 错误日志级别
在 `init_file/nginx.conf` 中配置：
```nginx
error_log /path/to/project/logs/error.log warn;
```

**日志级别说明**：
- `debug`: 调试信息（最详细）
- `info`: 信息（包括 INFO 级别的 Lua 日志）
- `notice`: 通知
- `warn`: 警告（包括 WARN 和 ERR 级别的 Lua 日志）
- `error`: 错误（只记录 ERR 级别的 Lua 日志）
- `crit`: 严重错误

**注意**：如果设置为 `warn`，`ngx.log(ngx.INFO, ...)` 的日志不会记录。

### Lua 日志级别
在 Lua 代码中使用 `ngx.log()` 记录日志：

```lua
ngx.log(ngx.DEBUG, "调试信息")    -- 只在 debug 级别显示
ngx.log(ngx.INFO, "信息")         -- 在 info 及以上级别显示
ngx.log(ngx.WARN, "警告")         -- 在 warn 及以上级别显示
ngx.log(ngx.ERR, "错误")          -- 在 error 及以上级别显示
```

## 登录相关的日志

### 登录验证日志
在 `lua/waf/auth.lua` 的 `verify_credentials` 函数中记录：

- **INFO 级别**：
  - `verify_credentials: attempting to verify user: <username>`
  - `verify_credentials: user found in database: <username>`
  - `verify_credentials: password verification successful for user: <username>`
  - `verify_credentials: user not found in database: <username>`
  - `verify_credentials: checking if database is empty...`
  - `verify_credentials: database is empty (user_count: 0)`
  - `verify_credentials: password hash generated successfully`
  - `verify_credentials: created user verified successfully`

- **WARN 级别**：
  - `verify_credentials: password verification failed for user: <username>`
  - `verify_credentials: database is empty, creating default admin user`
  - `verify_credentials: default admin user created successfully`
  - `verify_credentials: authentication failed for user: <username>`

- **ERR 级别**：
  - `verify_credentials: database query failed (pcall error): <error>`
  - `verify_credentials: database query error: <error>`
  - `verify_credentials: database query returned nil (connection failed?)`
  - `verify_credentials: failed to hash password for default admin user: <error>`
  - `verify_credentials: failed to create default admin user: <error>`

### 登录 API 日志
在 `lua/api/auth.lua` 的 `login` 函数中记录：

- **INFO 级别**：
  - `auth.login: login attempt for user: <username>`
  - `auth.login: authentication successful for user: <username>`

- **WARN 级别**：
  - `auth.login: username or password is empty`
  - `auth.login: authentication failed for user: <username>`

## 常见问题排查

### 问题 1：登录失败但没有日志

**可能原因**：
1. 日志级别设置太高（`warn` 或 `error`），INFO 级别的日志不会记录
2. 日志文件路径不正确
3. 日志文件权限问题

**解决方法**：
1. 检查 `nginx.conf` 中的 `error_log` 级别，建议设置为 `info` 或 `debug`
2. 检查日志文件路径是否正确
3. 检查日志文件权限：`chmod 644 logs/error.log`

### 问题 2：数据库连接失败

**日志特征**：
```
verify_credentials: database query failed (pcall error): ...
verify_credentials: database query error: ...
verify_credentials: database query returned nil (connection failed?)
```

**解决方法**：
1. 检查 MySQL 配置（`lua/config.lua`）
2. 检查 MySQL 服务是否运行
3. 检查网络连接
4. 检查数据库用户权限

### 问题 3：BCrypt 库不可用

**日志特征**：
```
verify_credentials: failed to hash password for default admin user: BCrypt library (resty.bcrypt) is not available
```

**解决方法**：
```bash
# 安装 BCrypt 库
opm get openresty/lua-resty-bcrypt
```

### 问题 4：数据库表不存在

**日志特征**：
```
verify_credentials: database query error: Table 'waf_db.waf_users' doesn't exist
```

**解决方法**：
1. 运行数据库初始化脚本：`mysql < init_file/数据库设计.sql`
2. 检查数据库名称是否正确

## 日志轮转

建议配置日志轮转以防止日志文件过大：

```bash
# /etc/logrotate.d/openresty-waf
/data/OPENRESTY_WAF/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 nobody nobody
    sharedscripts
    postrotate
        /usr/local/openresty/bin/openresty -s reopen
    endscript
}
```

## 调试技巧

### 1. 临时提高日志级别
修改 `nginx.conf` 中的 `error_log` 级别为 `debug`：
```nginx
error_log /path/to/project/logs/error.log debug;
```
然后重新加载配置：`openresty -s reload`

### 2. 查看特定时间段的日志
```bash
# 查看今天的日志
grep "$(date +%Y/%m/%d)" logs/error.log

# 查看最近 1 小时的日志
tail -n 1000 logs/error.log | grep "$(date +%H)"
```

### 3. 实时监控登录尝试
```bash
# 实时监控登录相关的日志
tail -f logs/error.log | grep -i "login\|auth\|verify_credentials"
```

### 4. 统计错误数量
```bash
# 统计今天的错误数量
grep "$(date +%Y/%m/%d)" logs/error.log | grep -i "error\|failed" | wc -l
```

