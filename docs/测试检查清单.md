# 服务器测试检查清单

## 一、部署前检查

### 1.1 文件完整性检查

- [ ] 所有 Lua 脚本文件已创建
  - [ ] `lua/config.lua`
  - [ ] `lua/waf/init.lua`
  - [ ] `lua/waf/ip_block.lua`
  - [ ] `lua/waf/ip_utils.lua`
  - [ ] `lua/waf/log_collect.lua`
  - [ ] `lua/waf/mysql_pool.lua`
  - [ ] `lua/waf/geo_block.lua`

- [ ] 配置文件已创建
  - [ ] `init_file/nginx.conf`
  - [ ] `init_file/数据库设计.sql`
  - [ ] `conf.d/set_conf/waf.conf`
  - [ ] `conf.d/set_conf/*.conf`（所有参数配置）

- [ ] 数据库脚本已创建
  - [ ] `init_file/数据库设计.sql`

- [ ] 安装脚本已创建
  - [ ] `scripts/install_openresty.sh`
  - [ ] `scripts/install_geoip.sh`

### 1.2 代码检查

- [ ] 所有 Lua 脚本语法正确
- [ ] 所有模块依赖关系正确
- [ ] 配置文件路径正确
- [ ] 数据库连接配置正确

## 二、服务器部署步骤

### 2.1 安装 OpenResty

```bash
# 使用一键安装脚本
sudo ./scripts/install_openresty.sh

# 验证安装
/usr/local/openresty/bin/openresty -v
```

### 2.2 安装 MySQL

```bash
# CentOS/RHEL
sudo yum install -y mysql-server
sudo systemctl start mysqld
sudo systemctl enable mysqld

# Ubuntu/Debian
sudo apt-get install -y mysql-server
sudo systemctl start mysql
sudo systemctl enable mysql
```

### 2.3 创建数据库

```bash
# 登录 MySQL
mysql -u root -p

# 执行 SQL 脚本
source /path/to/init_file/数据库设计.sql

# 或者
mysql -u root -p < init_file/数据库设计.sql
```

### 2.4 部署配置文件

```bash
# 使用部署脚本（推荐，自动处理路径）
sudo ./scripts/deploy.sh

# 注意：
# - init_file/nginx.conf 会复制到系统目录
# - conf.d/ 和 lua/ 保持在项目目录，不复制
# - 修改配置后无需重新部署，直接 reload 即可
```

### 2.5 修改配置

```bash
# 编辑数据库配置
# 编辑项目目录下的配置文件
vim lua/config.lua

# 修改以下内容：
# - MySQL host, port, database, user, password
```

### 2.6 安装 GeoIP2 数据库（可选）

```bash
# 如果需要地域封控功能
sudo ./scripts/install_geoip.sh YOUR_ACCOUNT_ID YOUR_LICENSE_KEY

# 然后在 config.lua 中启用
# _M.geo.enable = true
```

### 2.7 测试配置

```bash
# 测试 Nginx 配置
sudo /usr/local/openresty/bin/openresty -t

# 如果测试通过，启动服务
sudo systemctl start openresty
sudo systemctl enable openresty
```

## 三、功能测试

### 3.1 基础功能测试

- [ ] **健康检查**
  ```bash
  curl http://localhost/health
  # 应该返回: OK
  ```

- [ ] **日志采集测试**
  ```bash
  # 访问任意路径
  curl http://localhost/test
  
  # 检查数据库是否有记录
  mysql -u waf_user -p waf_db -e "SELECT * FROM waf_access_logs ORDER BY id DESC LIMIT 5;"
  ```

### 3.2 IP 封控测试

- [ ] **单个 IP 封控测试**
  ```sql
  -- 添加测试封控规则（先禁用，避免误封）
  INSERT INTO waf_block_rules (rule_type, rule_value, rule_name, status, priority)
  VALUES ('single_ip', '127.0.0.1', '测试封控', 0, 100);
  
  -- 查询规则
  SELECT * FROM waf_block_rules WHERE rule_name = '测试封控';
  
  -- 启用规则
  UPDATE waf_block_rules SET status = 1 WHERE rule_name = '测试封控';
  
  -- 等待缓存刷新（或重启服务）
  sleep 5
  
  -- 测试封控（应该返回 403）
  curl -v http://localhost/
  ```

- [ ] **IP 段封控测试**
  ```sql
  -- 添加 IP 段封控规则
  INSERT INTO waf_block_rules (rule_type, rule_value, rule_name, status, priority)
  VALUES ('ip_range', '192.168.1.0/24', '测试IP段封控', 0, 90);
  
  -- 启用并测试
  UPDATE waf_block_rules SET status = 1 WHERE rule_name = '测试IP段封控';
  ```

- [ ] **白名单测试**
  ```sql
  -- 添加白名单
  INSERT INTO waf_whitelist (ip_type, ip_value, description, status)
  VALUES ('single_ip', '127.0.0.1', '测试白名单', 1);
  
  -- 测试：即使有封控规则，白名单 IP 也应该能访问
  ```

### 3.3 地域封控测试（如果启用）

- [ ] **地域封控测试**
  ```sql
  -- 添加地域封控规则
  INSERT INTO waf_block_rules (rule_type, rule_value, rule_name, status, priority)
  VALUES ('geo', 'US', '测试-封控美国', 0, 80);
  
  -- 启用并测试
  UPDATE waf_block_rules SET status = 1 WHERE rule_name = '测试-封控美国';
  ```

### 3.4 日志功能测试

- [ ] **访问日志采集**
  ```bash
  # 访问多个路径
  curl http://localhost/page1
  curl http://localhost/page2
  curl http://localhost/page3
  
  # 等待批量写入（默认 1 秒）
  sleep 2
  
  # 检查数据库
  mysql -u waf_user -p waf_db -e "SELECT COUNT(*) FROM waf_access_logs;"
  ```

- [ ] **封控日志记录**
  ```bash
  # 触发封控后，检查封控日志
  mysql -u waf_user -p waf_db -e "SELECT * FROM waf_block_logs ORDER BY id DESC LIMIT 5;"
  ```

## 四、性能测试

### 4.1 压力测试

```bash
# 使用 ab 或 wrk 进行压力测试
ab -n 10000 -c 100 http://localhost/

# 或使用 wrk
wrk -t4 -c100 -d30s http://localhost/
```

### 4.2 监控指标

- [ ] 检查响应时间
- [ ] 检查错误率
- [ ] 检查数据库连接数
- [ ] 检查内存使用情况

## 五、常见问题排查

### 5.1 配置文件错误

**症状**：`nginx -t` 报错

**检查**：
```bash
# 检查配置文件语法
sudo /usr/local/openresty/bin/openresty -t

# 检查 Lua 模块路径
# 确认 lua_package_path 配置正确
```

### 5.2 数据库连接失败

**症状**：日志中显示数据库连接错误

**检查**：
```bash
# 检查 MySQL 服务
sudo systemctl status mysql

# 测试数据库连接
mysql -u waf_user -p waf_db -e "SELECT 1;"

# 检查防火墙
sudo iptables -L -n | grep 3306
```

### 5.3 日志未写入

**症状**：访问后数据库中没有记录

**检查**：
```bash
# 检查 log_by_lua 是否配置
grep -n "log_by_lua" /usr/local/openresty/nginx/conf/nginx.conf

# 检查错误日志
tail -f /usr/local/openresty/nginx/logs/error.log

# 检查共享内存
# 确认 waf_log_buffer 已配置
```

### 5.4 封控不生效

**症状**：添加规则后仍然可以访问

**检查**：
```bash
# 检查规则状态
mysql -u waf_user -p waf_db -e "SELECT * FROM waf_block_rules WHERE status = 1;"

# 检查缓存（需要重启服务清除缓存）
sudo systemctl restart openresty

# 检查 access_by_lua 是否配置
# 检查封控配置（在 conf.d/vhost_conf/default.conf 中）
grep -n "access_by_lua" conf.d/vhost_conf/default.conf
```

### 5.5 GeoIP2 数据库问题

**症状**：地域封控不工作

**检查**：
```bash
# 检查数据库文件是否存在
# 检查 GeoIP 数据库（在项目目录）
ls -lh lua/geoip/GeoLite2-City.mmdb

# 检查配置
# 检查地域封控配置（在项目目录）
grep -A 3 "geo" lua/config.lua

# 检查 lua-resty-maxminddb 是否安装
/usr/local/openresty/bin/opm list | grep maxminddb
```

## 六、安全检查

### 6.1 配置安全

- [ ] 修改默认数据库密码
- [ ] 检查配置文件权限
- [ ] 限制管理接口访问（如果有）

### 6.2 防火墙配置

```bash
# 开放 HTTP/HTTPS 端口
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload

# 或使用 iptables
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
```

## 七、监控和日志

### 7.1 日志位置

- 错误日志：`logs/error.log`（项目目录）
- 访问日志：`logs/access.log`（项目目录）
- GeoIP 更新日志：`logs/geoip_update.log`（项目目录）
- 业务日志：MySQL `waf_access_logs` 和 `waf_block_logs` 表

### 7.2 监控命令

```bash
# 查看错误日志
tail -f /usr/local/openresty/nginx/logs/error.log

# 查看访问日志
# 查看访问日志（项目目录）
tail -f logs/access.log

# 查看服务状态
sudo systemctl status openresty

# 查看进程
ps aux | grep nginx

# 查看连接数
netstat -an | grep :80 | wc -l
```

## 八、回滚方案

如果出现问题，可以快速回滚：

```bash
# 停止服务
sudo systemctl stop openresty

# 恢复配置文件
# 恢复 nginx.conf（从备份恢复后需要重新部署）
sudo cp /backup/nginx.conf /usr/local/openresty/nginx/conf/nginx.conf
# 或从 init_file 目录重新部署
sudo cp init_file/nginx.conf /usr/local/openresty/nginx/conf/nginx.conf
# 或重新运行部署脚本
sudo ./scripts/deploy.sh

# 重启服务
sudo systemctl start openresty
```

## 九、测试完成标准

- [ ] 所有基础功能正常
- [ ] IP 封控功能正常
- [ ] 日志采集功能正常
- [ ] 白名单功能正常
- [ ] 性能满足要求
- [ ] 无严重错误日志
- [ ] 数据库连接稳定

## 十、注意事项

1. **测试环境**：建议先在测试环境验证
2. **数据备份**：部署前备份数据库
3. **逐步启用**：先启用日志采集，再启用封控功能
4. **监控告警**：设置监控和告警机制
5. **文档记录**：记录测试过程和问题

