# WAF 监控指标说明

## 概述

WAF 系统使用 **Prometheus 格式**的监控指标来监控系统状态。这些指标通过 `/metrics` 端点提供，可以被 Prometheus 监控系统采集，也可以在 Dashboard 页面中可视化显示。

## 指标类型

Prometheus 支持三种主要的指标类型：

1. **Counter（计数器）**：只能增加，不能减少的累积指标
2. **Gauge（仪表盘）**：可以增加或减少的瞬时值指标
3. **Histogram（直方图）**：用于统计分布情况

## WAF 监控指标详解

### 1. waf_blocks_total（总封控次数）

- **类型**：Counter（计数器）
- **说明**：WAF 系统总共封控的请求数量
- **单位**：次
- **用途**：统计 WAF 的总体防护效果
- **示例值**：`waf_blocks_total 0` 表示当前总封控次数为 0

### 2. waf_auto_blocks_total（自动封控IP总数）

- **类型**：Counter（计数器）
- **说明**：通过自动封控功能封控的 IP 总数
- **单位**：个
- **用途**：统计自动封控功能的启用效果
- **示例值**：`waf_auto_blocks_total 0` 表示当前自动封控的 IP 总数为 0

### 3. waf_blocked_ips（当前被封控IP数）

- **类型**：Gauge（仪表盘）
- **说明**：当前时刻被封控的 IP 数量（实时值）
- **单位**：个
- **用途**：监控当前系统的封控状态
- **示例值**：`waf_blocked_ips 0` 表示当前没有 IP 被封控

### 4. waf_cache_hit_rate（缓存命中率）

- **类型**：Gauge（仪表盘）
- **说明**：WAF 规则缓存的命中率
- **单位**：百分比（0.0-1.0，需要乘以 100 显示为百分比）
- **用途**：评估缓存效果，命中率越高说明性能越好
- **示例值**：`waf_cache_hit_rate 0.0000` 表示缓存命中率为 0%

### 5. waf_rule_match_duration_seconds（规则匹配耗时）

- **类型**：Gauge（仪表盘）
- **说明**：规则匹配的平均耗时
- **单位**：秒（通常显示为毫秒，需要乘以 1000）
- **用途**：监控 WAF 规则匹配的性能
- **示例值**：`waf_rule_match_duration_seconds 0.000000` 表示平均匹配耗时为 0 秒

### 6. waf_database_health（数据库健康状态）

- **类型**：Gauge（仪表盘）
- **说明**：数据库连接的健康状态
- **单位**：布尔值（1=健康，0=异常）
- **用途**：监控数据库连接状态
- **示例值**：
  - `waf_database_health 1` 表示数据库连接正常
  - `waf_database_health 0` 表示数据库连接异常

### 7. waf_fallback_enabled（降级模式状态）

- **类型**：Gauge（仪表盘）
- **说明**：降级模式是否启用
- **单位**：布尔值（1=已启用，0=未启用）
- **用途**：监控系统是否处于降级模式
- **示例值**：
  - `waf_fallback_enabled 1` 表示降级模式已启用
  - `waf_fallback_enabled 0` 表示降级模式未启用

## 如何查看指标

### 方式一：通过 Dashboard 页面查看（推荐）

访问 `/admin/dashboard` 页面，系统会自动解析 Prometheus 指标并以友好的中文界面显示：

- 数据库健康状态：显示为"健康"或"异常"
- 总封控次数：显示为数字
- 缓存命中率：显示为百分比（如 85.5%）
- 当前被封控IP数：显示为数字
- 规则匹配耗时：显示为毫秒（如 2.5ms）
- 降级模式：显示为"已启用"或"未启用"

### 方式二：直接访问 /metrics 端点

访问 `/metrics` 端点可以查看原始的 Prometheus 格式指标：

```
# HELP waf_blocks_total Total number of blocked requests
# TYPE waf_blocks_total counter
waf_blocks_total 0
```

### 方式三：使用 Prometheus 监控系统

如果部署了 Prometheus 监控系统，可以配置 Prometheus 从 `/metrics` 端点采集指标，然后在 Grafana 中可视化展示。

## 指标更新频率

- 指标数据存储在 OpenResty 的共享内存缓存中
- 指标缓存 TTL 为 300 秒（5 分钟）
- Dashboard 页面默认每 30 秒自动刷新一次

## 注意事项

1. **指标格式**：所有指标都遵循 Prometheus 标准格式
2. **指标前缀**：所有 WAF 指标都以 `waf_` 开头
3. **指标单位**：
   - 时间单位：秒（在 Dashboard 中显示为毫秒）
   - 百分比：0.0-1.0（在 Dashboard 中显示为 0%-100%）
   - 布尔值：1 或 0（在 Dashboard 中显示为中文状态）
4. **指标持久化**：指标存储在内存中，重启后会重置

## 相关文件

- **指标生成**：`lua/waf/metrics.lua`
- **指标端点**：`lua/web/handler.lua`（`/metrics` 路由）
- **Dashboard 显示**：`lua/web/dashboard.html`
- **配置**：`lua/config.lua`（`metrics.enable` 配置项）

