# 路径配置分析文档

## 概述

本文档分析了 OpenResty WAF 项目中所有配置文件的路径配置逻辑，特别是当 `init_file/nginx.conf` 被复制到 OpenResty 安装目录时的路径处理。

## 目录结构

```
项目根目录/
├── init_file/
│   └── nginx.conf          # 主配置文件模板（会被复制到系统目录）
├── conf.d/                 # 配置文件目录（保持在项目目录）⭐
│   ├── set_conf/          # 参数配置文件
│   │   ├── lua.conf       # Lua 配置（使用 $project_root）
│   │   ├── log.conf       # 日志配置（使用 $project_root）
│   │   └── ...
│   └── vhost_conf/        # 虚拟主机配置
│       ├── default.conf
│       └── waf.conf
├── lua/                    # Lua 脚本（保持在项目目录）⭐
├── logs/                   # 日志文件（保持在项目目录）⭐
└── ...
```

## 路径配置原则

### 1. 主配置文件（nginx.conf）

**位置**：`/usr/local/openresty/nginx/conf/nginx.conf`（从 `init_file/nginx.conf` 复制）

**需要替换的路径**：
- `error_log /path/to/project/logs/error.log` → `error_log $PROJECT_ROOT_ABS/logs/error.log`
  - **原因**：`error_log` 指令不支持变量，必须使用绝对路径
- `include /path/to/project/conf.d/set_conf/*.conf` → `include $PROJECT_ROOT_ABS/conf.d/set_conf/*.conf`
  - **原因**：`include` 指令需要绝对路径才能找到项目目录下的配置文件
- `include /path/to/project/conf.d/vhost_conf/*.conf` → `include $PROJECT_ROOT_ABS/conf.d/vhost_conf/*.conf`
  - **原因**：同上

**需要添加的配置**：
- 在 `http` 块开始处添加：`set $project_root "$PROJECT_ROOT_ABS";`
  - **原因**：`conf.d/set_conf/lua.conf` 和 `log.conf` 都使用了 `$project_root` 变量

### 2. 参数配置文件（conf.d/set_conf/*.conf）

**位置**：保持在项目目录，**不复制**到系统目录

**路径使用方式**：
- 使用 `$project_root` 变量引用项目根目录
- 示例：
  ```nginx
  # lua.conf
  lua_package_path "$project_root/lua/?.lua;$project_root/lua/waf/?.lua;;";
  
  # log.conf
  access_log $project_root/logs/access.log main;
  ```

**为什么使用变量**：
- 配置文件保持在项目目录，可以随时修改
- 使用变量可以避免硬编码绝对路径，提高可移植性
- 部署脚本会自动设置 `$project_root` 变量

### 3. 虚拟主机配置（conf.d/vhost_conf/*.conf）

**位置**：保持在项目目录，**不复制**到系统目录

**路径使用方式**：
- 使用 `$project_root` 变量引用项目根目录（在注释的示例中）
- 示例：
  ```nginx
  # default.conf（注释中的示例）
  # ssl_certificate $project_root/conf.d/cert/your_domain.crt;
  # access_log $project_root/logs/access.log;
  ```

## 部署流程

### 步骤1：删除旧配置文件
```bash
rm -f /usr/local/openresty/nginx/conf/nginx.conf
```

### 步骤2：复制模板文件
```bash
cp init_file/nginx.conf /usr/local/openresty/nginx/conf/nginx.conf
```

### 步骤3：替换路径占位符
```bash
# 替换 error.log 路径（必须使用绝对路径）
sed -i "s|/path/to/project/logs/error.log|$PROJECT_ROOT_ABS/logs/error.log|g" nginx.conf

# 替换 include 路径（必须使用绝对路径）
sed -i "s|/path/to/project/conf.d/set_conf|$PROJECT_ROOT_ABS/conf.d/set_conf|g" nginx.conf
sed -i "s|/path/to/project/conf.d/vhost_conf|$PROJECT_ROOT_ABS/conf.d/vhost_conf|g" nginx.conf
```

### 步骤4：添加 $project_root 变量
```bash
# 在 http { 后添加
sed -i '/^http {/a\    set $project_root "'"$PROJECT_ROOT_ABS"'";' nginx.conf
```

## 路径配置总结

| 配置项 | 位置 | 路径类型 | 说明 |
|--------|------|----------|------|
| `error_log` | nginx.conf | 绝对路径 | 不支持变量，必须替换为绝对路径 |
| `include conf.d/set_conf/*.conf` | nginx.conf | 绝对路径 | 需要指向项目目录，必须替换为绝对路径 |
| `include conf.d/vhost_conf/*.conf` | nginx.conf | 绝对路径 | 需要指向项目目录，必须替换为绝对路径 |
| `set $project_root` | nginx.conf | 变量设置 | 必须在 http 块开始处设置，供子配置文件使用 |
| `lua_package_path` | lua.conf | 变量引用 | 使用 `$project_root` 变量 |
| `access_log` | log.conf | 变量引用 | 使用 `$project_root` 变量 |
| `ssl_certificate` | vhost_conf/*.conf | 变量引用 | 使用 `$project_root` 变量（在注释示例中） |

## 关键点

1. **主配置文件（nginx.conf）**：
   - 被复制到系统目录 `/usr/local/openresty/nginx/conf/nginx.conf`
   - 需要包含项目目录下的配置文件（通过 `include` 指令）
   - `include` 路径必须是**绝对路径**，指向项目目录

2. **子配置文件（conf.d/*.conf）**：
   - 保持在项目目录，**不复制**到系统目录
   - 使用 `$project_root` 变量引用项目根目录
   - 通过 `include` 指令被主配置文件加载

3. **$project_root 变量**：
   - 必须在 `nginx.conf` 的 `http` 块中通过 `set` 指令设置
   - 部署脚本会自动设置此变量为实际项目路径
   - 子配置文件通过此变量引用项目目录下的资源（Lua 脚本、日志文件等）

## 验证方法

### 1. 检查路径替换
```bash
# 检查 error.log 路径
grep "error_log" /usr/local/openresty/nginx/conf/nginx.conf

# 检查 include 路径
grep "include.*conf.d" /usr/local/openresty/nginx/conf/nginx.conf

# 检查 $project_root 变量
grep "set \$project_root" /usr/local/openresty/nginx/conf/nginx.conf
```

### 2. 检查配置文件语法
```bash
/usr/local/openresty/bin/openresty -t
```

### 3. 检查变量使用
```bash
# 检查 lua.conf 中的变量使用
grep "project_root" conf.d/set_conf/lua.conf

# 检查 log.conf 中的变量使用
grep "project_root" conf.d/set_conf/log.conf
```

## 常见问题

### Q1: 为什么 error_log 不能使用变量？
A: Nginx 的 `error_log` 指令不支持变量，必须在配置时使用绝对路径。

### Q2: 为什么 include 路径必须是绝对路径？
A: 因为 `nginx.conf` 在系统目录（`/usr/local/openresty/nginx/conf/`），而配置文件在项目目录，相对路径无法找到项目目录下的文件。

### Q3: 为什么子配置文件使用 $project_root 变量而不是绝对路径？
A: 使用变量可以提高可移植性，如果项目目录移动，只需更新 `$project_root` 变量即可，无需修改所有子配置文件。

### Q4: 如果项目目录移动了怎么办？
A: 需要重新运行部署脚本，脚本会自动更新所有路径配置。

