# OpenResty + MySQL IP é‡‡é›†ä¸å°æ§ç³»ç»Ÿ - éƒ¨ç½²æ–‡æ¡£

## ğŸ“‹ å¿«é€Ÿå¼€å§‹

**æ¨èä½¿ç”¨ä¸€é”®å®‰è£…è„šæœ¬**ï¼š

```bash
# è¿è¡Œä¸€é”®å®‰è£…è„šæœ¬ï¼ˆæ¨èï¼‰
sudo ./start.sh
```

ä¸€é”®å®‰è£…è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆæ‰€æœ‰å®‰è£…å’Œé…ç½®æ­¥éª¤ï¼ŒåŒ…æ‹¬ï¼š
- âœ… å®‰è£… OpenResty
- âœ… å®‰è£… MySQL å’Œ Redisï¼ˆå¯é€‰ï¼Œæ”¯æŒæœ¬åœ°/å¤–éƒ¨é€‰æ‹©ï¼‰
- âœ… éƒ¨ç½²é…ç½®æ–‡ä»¶
- âœ… é…ç½®æ•°æ®åº“è¿æ¥
- âœ… åˆå§‹åŒ–æ•°æ®åº“ï¼ˆ18ä¸ªè¡¨å’Œå¤šä¸ªè§†å›¾ï¼‰
- âœ… å®‰è£… GeoIP æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰
- âœ… ç³»ç»Ÿä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

è¯¦ç»†è¯´æ˜è¯·å‚è€ƒï¼š[start_README.md](../start_README.md)

## ğŸ¯ ç³»ç»ŸåŠŸèƒ½æ¦‚è§ˆ

å®‰è£…å®Œæˆåï¼Œç³»ç»Ÿæä¾›ä»¥ä¸‹å®Œæ•´åŠŸèƒ½ï¼š

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- âœ… IPå°æ§ï¼ˆå•ä¸ªIPã€IPæ®µã€åœ°åŸŸå°æ§ï¼‰
- âœ… ç™½åå•æœºåˆ¶
- âœ… è®¿é—®æ—¥å¿—é‡‡é›†
- âœ… è‡ªåŠ¨å°æ§ï¼ˆåŸºäºé¢‘ç‡å’Œè¡Œä¸ºï¼‰
- âœ… è‡ªåŠ¨è§£å°

**ç®¡ç†åŠŸèƒ½**ï¼š
- âœ… Webç®¡ç†ç•Œé¢ï¼ˆç™»å½•ã€åŠŸèƒ½ç®¡ç†ã€è§„åˆ™ç®¡ç†ã€ä»£ç†ç®¡ç†ã€ç»Ÿè®¡ã€ç›‘æ§ï¼‰
- âœ… RESTful APIæ¥å£ï¼ˆå®Œæ•´çš„CRUDæ“ä½œï¼‰
- âœ… è§„åˆ™ç®¡ç†ï¼ˆCRUDã€å¯¼å…¥/å¯¼å‡ºã€åˆ†ç»„ã€æ¨¡æ¿ï¼‰
- âœ… è§„åˆ™å¤‡ä»½å’Œæ¢å¤
- âœ… åŠŸèƒ½å¼€å…³ç®¡ç†ï¼ˆåŠ¨æ€æ§åˆ¶åŠŸèƒ½å¯ç”¨/ç¦ç”¨ï¼‰
- âœ… åå‘ä»£ç†ç®¡ç†ï¼ˆHTTPã€TCPã€UDPï¼‰
- âœ… ç»Ÿè®¡æŠ¥è¡¨ï¼ˆæ¦‚è§ˆã€æ—¶é—´åºåˆ—ã€IPç»Ÿè®¡ã€è§„åˆ™ç»Ÿè®¡ï¼‰
- âœ… ç›‘æ§é¢æ¿ï¼ˆå®æ—¶ç›‘æ§ã€PrometheusæŒ‡æ ‡ï¼‰
- âœ… é…ç½®éªŒè¯ï¼ˆå¯åŠ¨æ—¶å’Œè¿è¡Œæ—¶ï¼‰

**å®‰å…¨åŠŸèƒ½**ï¼š
- âœ… ç”¨æˆ·è®¤è¯ï¼ˆç”¨æˆ·åå¯†ç ç™»å½•ï¼‰
- âœ… TOTPåŒå› ç´ è®¤è¯ï¼ˆæ”¯æŒæœ¬åœ°QRç ç”Ÿæˆï¼‰
- âœ… å¯†ç ç®¡ç†ï¼ˆBCryptå“ˆå¸Œã€å¼ºåº¦æ£€æŸ¥ã€ç”Ÿæˆå·¥å…·ï¼‰
- âœ… ä¼šè¯ç®¡ç†ï¼ˆCookie-basedï¼‰
- âœ… X-Forwarded-Forå®‰å…¨å¢å¼ºï¼ˆå—ä¿¡ä»»ä»£ç†æ£€æŸ¥ï¼‰
- âœ… æ‰€æœ‰APIå’Œé¡µé¢éƒ½éœ€è¦ç™»å½•è®¤è¯

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- âœ… å¤šçº§ç¼“å­˜ï¼ˆå…±äº«å†…å­˜ã€LRUã€RedisäºŒçº§ç¼“å­˜ï¼‰
- âœ… ç¼“å­˜é¢„çƒ­æœºåˆ¶
- âœ… ç¼“å­˜å¤±æ•ˆæœºåˆ¶ï¼ˆç‰ˆæœ¬å·æ£€æŸ¥ï¼‰
- âœ… ç¼“å­˜ç©¿é€é˜²æŠ¤ï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ã€é¢‘ç‡é™åˆ¶ï¼‰
- âœ… æ•°æ®åº“è¿æ¥æ± ï¼ˆå¯ç›‘æ§ã€å¯è‡ªåŠ¨è°ƒæ•´ï¼‰
- âœ… å¼‚æ­¥æ‰¹é‡æ—¥å¿—å†™å…¥
- âœ… æ—¥å¿—é˜Ÿåˆ—æœºåˆ¶
- âœ… IP Trieæ ‘é«˜æ•ˆåŒ¹é…
- âœ… é™çº§æœºåˆ¶ï¼ˆæ•°æ®åº“æ•…éšœæ—¶è‡ªåŠ¨é™çº§ï¼‰
- âœ… ç³»ç»Ÿè‡ªåŠ¨ä¼˜åŒ–ï¼ˆæ ¹æ®ç¡¬ä»¶è‡ªåŠ¨ä¼˜åŒ–ï¼‰

---

## ä¸€ã€ç¯å¢ƒè¦æ±‚

### 1.1 ç³»ç»Ÿè¦æ±‚

**æ“ä½œç³»ç»Ÿæ”¯æŒ**ï¼ˆè„šæœ¬è‡ªåŠ¨æ£€æµ‹ï¼‰ï¼š
- **RedHat ç³»åˆ—**ï¼šCentOS 6.x/7.x/8.xã€RHEL 6.x/7.x/8.x/9.xã€Fedoraã€Rocky Linux 8.x/9.xã€AlmaLinux 8.x/9.xã€Oracle Linux 7.x/8.x/9.xã€Amazon Linux 1/2/2023
- **Debian ç³»åˆ—**ï¼šDebian 9+ã€Ubuntu 16.04+ã€Linux Mintã€Kali Linuxã€Raspbian
- **SUSE ç³»åˆ—**ï¼šopenSUSE Leap/Tumbleweedã€SLES
- **Arch ç³»åˆ—**ï¼šArch Linuxã€Manjaro
- **å…¶ä»–**ï¼šAlpine Linuxã€Gentoo

**ç¡¬ä»¶è¦æ±‚**ï¼š
- **CPU**ï¼š2 æ ¸åŠä»¥ä¸Šï¼ˆæ¨è 4 æ ¸+ï¼‰
- **å†…å­˜**ï¼š4GB åŠä»¥ä¸Šï¼ˆæ¨è 8GB+ï¼‰
- **ç£ç›˜**ï¼š20GB åŠä»¥ä¸Šï¼ˆæ ¹æ®æ—¥å¿—é‡è°ƒæ•´ï¼‰

### 1.2 è½¯ä»¶è¦æ±‚
- **OpenResty**ï¼š1.21.4.1 æˆ–æ›´é«˜ç‰ˆæœ¬
- **MySQL**ï¼š8.0 æˆ– MariaDB 10.6+
- **Redis**ï¼š5.0+ï¼ˆå¯é€‰ï¼Œç”¨äºç¼“å­˜ï¼‰

## äºŒã€å®‰è£…æ­¥éª¤

### 2.1 å®‰è£… OpenResty

**æ¨èä½¿ç”¨ä¸€é”®å®‰è£…è„šæœ¬**ï¼ˆè‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿç±»å‹å¹¶å®‰è£…ï¼‰ï¼š

```bash
# ä½¿ç”¨ä¸€é”®å®‰è£…è„šæœ¬ï¼ˆæ”¯æŒå¤šç§ Linux å‘è¡Œç‰ˆï¼‰
sudo ./scripts/install_openresty.sh

# è‡ªå®šä¹‰å®‰è£…è·¯å¾„ï¼ˆé»˜è®¤ï¼š/usr/local/openrestyï¼‰
sudo OPENRESTY_PREFIX=/opt/openresty ./scripts/install_openresty.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- âœ… æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹ï¼ˆæ”¯æŒ 20+ ç§ Linux å‘è¡Œç‰ˆï¼‰
- âœ… å®‰è£…æ‰€éœ€ä¾èµ–åŒ…
- âœ… å®‰è£… OpenRestyï¼ˆä¼˜å…ˆä½¿ç”¨åŒ…ç®¡ç†å™¨ï¼Œå¤±è´¥åˆ™ä»æºç ç¼–è¯‘ï¼‰
- âœ… é…ç½® systemd æœåŠ¡
- âœ… å®‰è£…å¸¸ç”¨ Lua æ¨¡å—

**æ‰‹åŠ¨å®‰è£…**ï¼ˆä¸æ¨èï¼Œä»…ä½œå‚è€ƒï¼‰ï¼š

#### CentOS/RHEL
```bash
# æ·»åŠ  OpenResty ä»“åº“
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo

# å®‰è£… OpenResty
sudo yum install -y openresty openresty-resty

# éªŒè¯å®‰è£…
/usr/local/openresty/bin/openresty -v
```

#### Ubuntu/Debian
```bash
# æ·»åŠ  OpenResty ä»“åº“
wget -qO - https://openresty.org/package/pubkey.gpg | sudo apt-key add -
sudo apt-get -y install software-properties-common
sudo add-apt-repository -y "deb http://openresty.org/package/ubuntu $(lsb_release -sc) main"
sudo apt-get update

# å®‰è£… OpenResty
sudo apt-get install -y openresty

# éªŒè¯å®‰è£…
/usr/local/openresty/bin/openresty -v
```

**æ³¨æ„**ï¼šæ‰€æœ‰è„šæœ¬éƒ½æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡ `OPENRESTY_PREFIX` é…ç½®å®‰è£…è·¯å¾„ï¼Œæ— ç¡¬ç¼–ç ç»å¯¹è·¯å¾„ã€‚

### 2.2 å®‰è£… MySQL

**æ¨èä½¿ç”¨ä¸€é”®å®‰è£…è„šæœ¬**ï¼ˆè‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿç±»å‹å¹¶ä¼˜åŒ–é…ç½®ï¼‰ï¼š

```bash
# ä½¿ç”¨ä¸€é”®å®‰è£…è„šæœ¬ï¼ˆæ”¯æŒå¤šç§ Linux å‘è¡Œç‰ˆï¼‰
sudo ./scripts/install_mysql.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- âœ… æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹
- âœ… æ£€æµ‹ç¡¬ä»¶é…ç½®ï¼ˆCPUã€å†…å­˜ï¼‰
- âœ… æ ¹æ®ç¡¬ä»¶è‡ªåŠ¨ä¼˜åŒ– MySQL é…ç½®å‚æ•°
- âœ… åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
- âœ… æ‰§è¡Œ SQL è„šæœ¬åˆå§‹åŒ–æ•°æ®åº“
- âœ… æ›´æ–° WAF é…ç½®æ–‡ä»¶

**æ‰‹åŠ¨å®‰è£…**ï¼ˆä¸æ¨èï¼Œä»…ä½œå‚è€ƒï¼‰ï¼š

#### CentOS/RHEL
```bash
# å®‰è£… MySQL 8.0
sudo yum install -y mysql-server

# å¯åŠ¨ MySQL
sudo systemctl start mysqld
sudo systemctl enable mysqld

# è·å–ä¸´æ—¶å¯†ç 
sudo grep 'temporary password' /var/log/mysqld.log
```

#### Ubuntu/Debian
```bash
# å®‰è£… MySQL 8.0
sudo apt-get update
sudo apt-get install -y mysql-server

# å¯åŠ¨ MySQL
sudo systemctl start mysql
sudo systemctl enable mysql
```

### 2.3 å®‰è£… Redisï¼ˆå¯é€‰ï¼‰

**æ¨èä½¿ç”¨ä¸€é”®å®‰è£…è„šæœ¬**ï¼ˆè‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿç±»å‹å¹¶ä¼˜åŒ–é…ç½®ï¼‰ï¼š

```bash
# ä½¿ç”¨ä¸€é”®å®‰è£…è„šæœ¬ï¼ˆæ”¯æŒå¤šç§ Linux å‘è¡Œç‰ˆï¼‰
sudo ./scripts/install_redis.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- âœ… æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹
- âœ… æ£€æµ‹ç¡¬ä»¶é…ç½®ï¼ˆCPUã€å†…å­˜ï¼‰
- âœ… æ ¹æ®ç¡¬ä»¶è‡ªåŠ¨ä¼˜åŒ– Redis é…ç½®å‚æ•°
- âœ… é…ç½® systemd æœåŠ¡
- âœ… æ›´æ–° WAF é…ç½®æ–‡ä»¶

**æ‰‹åŠ¨å®‰è£…**ï¼ˆä¸æ¨èï¼Œä»…ä½œå‚è€ƒï¼‰ï¼š

```bash
# CentOS/RHEL
sudo yum install -y redis

# Ubuntu/Debian
sudo apt-get install -y redis-server

# å¯åŠ¨ Redis
sudo systemctl start redis
sudo systemctl enable redis
```

### 2.4 å®‰è£… Lua ä¾èµ–æ¨¡å—

**æ¨èä½¿ç”¨ä¾èµ–ç®¡ç†è„šæœ¬**ï¼ˆè‡ªåŠ¨æ£€æŸ¥å¹¶å®‰è£…æ‰€æœ‰ä¾èµ–ï¼‰ï¼š

```bash
# æ£€æŸ¥ä¾èµ–çŠ¶æ€ï¼ˆäº¤äº’å¼ï¼‰
sudo ./scripts/check_dependencies.sh

# æˆ–è‡ªåŠ¨å®‰è£…æ‰€æœ‰ä¾èµ–
sudo ./scripts/install_dependencies.sh
```

**æ‰‹åŠ¨å®‰è£…**ï¼ˆä¸æ¨èï¼Œä»…ä½œå‚è€ƒï¼‰ï¼š

```bash
# å®‰è£… lua-resty-mysql
opm get openresty/lua-resty-mysql

# å®‰è£… lua-resty-redisï¼ˆå¯é€‰ï¼‰
opm get openresty/lua-resty-redis

# å®‰è£… lua-resty-maxminddbï¼ˆç”¨äºåœ°åŸŸè¯†åˆ«ï¼Œå¯é€‰ï¼‰
opm get anjia0532/lua-resty-maxminddb
```

### 2.5 é…ç½® GeoIP2 æ•°æ®åº“ï¼ˆå¯é€‰ï¼Œç”¨äºåœ°åŸŸå°æ§ï¼‰

**é‡è¦**ï¼šåœ°åŸŸå°æ§æ”¯æŒå›½å†…ï¼ˆçœå¸‚çº§åˆ«ï¼‰å’Œå›½å¤–ï¼ˆå›½å®¶çº§åˆ«ï¼‰ï¼Œéœ€è¦ä½¿ç”¨ **GeoLite2-City.mmdb**ï¼ˆCity ç‰ˆæœ¬ï¼‰ï¼Œè€Œä¸æ˜¯ Country ç‰ˆæœ¬ã€‚

**æ¨èä½¿ç”¨ä¸€é”®å®‰è£…è„šæœ¬**ï¼š

```bash
# ä½¿ç”¨ä¸€é”®å®‰è£…è„šæœ¬ï¼ˆæ¨èï¼‰
sudo ./scripts/install_geoip.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- ä¸‹è½½ GeoLite2-City æ•°æ®åº“
- å®‰è£…åˆ°é¡¹ç›®ç›®å½•çš„ `lua/geoip/` ç›®å½•
- è®¾ç½®æ–‡ä»¶æƒé™
- é…ç½®è‡ªåŠ¨æ›´æ–°è®¡åˆ’ä»»åŠ¡

**æ‰‹åŠ¨å®‰è£…**ï¼ˆä¸æ¨èï¼‰ï¼š

```bash
# åˆ›å»º GeoIP2 æ•°æ®åº“ç›®å½•ï¼ˆé¡¹ç›®ç›®å½•ï¼‰
mkdir -p /path/to/project/lua/geoip

# ä¸‹è½½ GeoLite2-City æ•°æ®åº“ï¼ˆæ³¨æ„æ˜¯ City ç‰ˆæœ¬ï¼‰
# æ–¹å¼ä¸€ï¼šä» MaxMind å®˜ç½‘ä¸‹è½½ï¼ˆéœ€è¦æ³¨å†Œè´¦å·ï¼‰
# è®¿é—®ï¼šhttps://dev.maxmind.com/geoip/geoip2/geolite2/
# ä¸‹è½½ GeoLite2-City.mmdb å¹¶æ”¾åˆ°é¡¹ç›®ç›®å½•çš„ lua/geoip/ ç›®å½•

# æ–¹å¼äºŒï¼šä½¿ç”¨ wgetï¼ˆéœ€è¦ License Keyï¼‰
# wget "https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-City&license_key=YOUR_LICENSE_KEY&suffix=tar.gz" -O /tmp/GeoLite2-City.tar.gz
# tar -xzf /tmp/GeoLite2-City.tar.gz -C /tmp/
# cp /tmp/GeoLite2-City_*/GeoLite2-City.mmdb /path/to/project/lua/geoip/

# è®¾ç½®æ–‡ä»¶æƒé™
chown nobody:nobody /path/to/project/lua/geoip/GeoLite2-City.mmdb
chmod 644 /path/to/project/lua/geoip/GeoLite2-City.mmdb
```

**æ³¨æ„**ï¼š
- å¦‚æœä¸ä½¿ç”¨åœ°åŸŸå°æ§åŠŸèƒ½ï¼Œå¯ä»¥è·³è¿‡æ­¤æ­¥éª¤
- å¿…é¡»ä½¿ç”¨ **GeoLite2-City.mmdb**ï¼ˆCity ç‰ˆæœ¬ï¼‰ï¼ŒCountry ç‰ˆæœ¬ä¸åŒ…å«çœå¸‚ä¿¡æ¯
- æ•°æ®åº“æ–‡ä»¶è¾ƒå¤§ï¼ˆçº¦ 30-50MBï¼‰ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´

## ä¸‰ã€æ•°æ®åº“é…ç½®

### 3.1 åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·

```bash
# ç™»å½• MySQL
mysql -u root -p

# åˆ›å»ºæ•°æ®åº“
CREATE DATABASE waf_db DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

# åˆ›å»ºç”¨æˆ·
CREATE USER 'waf_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON waf_db.* TO 'waf_user'@'localhost';
FLUSH PRIVILEGES;

# é€€å‡º
EXIT;
```

### 3.2 å¯¼å…¥æ•°æ®åº“ç»“æ„

```bash
# æ‰§è¡Œ SQL è„šæœ¬
mysql -u waf_user -p waf_db < /path/to/init_file/æ•°æ®åº“è®¾è®¡.sql
```

### 3.3 éªŒè¯æ•°æ®åº“

```bash
mysql -u waf_user -p waf_db -e "SHOW TABLES;"
```

## å››ã€é…ç½®æ–‡ä»¶éƒ¨ç½²

### 4.1 ä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# ä½¿ç”¨éƒ¨ç½²è„šæœ¬è‡ªåŠ¨éƒ¨ç½²
sudo ./scripts/deploy.sh
```

éƒ¨ç½²è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- å¤åˆ¶ `init_file/nginx.conf` åˆ°ç³»ç»Ÿç›®å½•
- æ›´æ–°æ‰€æœ‰è·¯å¾„é…ç½®ï¼ˆæŒ‡å‘é¡¹ç›®ç›®å½•ï¼‰
- è®¾ç½®æ–‡ä»¶æƒé™

**éƒ¨ç½²ç­–ç•¥**ï¼š
- `init_file/nginx.conf` - å¤åˆ¶åˆ° `/usr/local/openresty/nginx/conf/nginx.conf`
- `conf.d/` - **ä¿æŒåœ¨é¡¹ç›®ç›®å½•**ï¼ˆæ–¹ä¾¿é…ç½®ç®¡ç†ï¼‰
- `lua/` - **ä¿æŒåœ¨é¡¹ç›®ç›®å½•**ï¼ˆä¸å¤åˆ¶ï¼‰
- `logs/` - **ä¿æŒåœ¨é¡¹ç›®ç›®å½•**ï¼ˆæ—¥å¿—æ–‡ä»¶ï¼‰

### 4.2 æ‰‹åŠ¨éƒ¨ç½²ï¼ˆä¸æ¨èï¼‰

å¦‚æœéœ€è¦æ‰‹åŠ¨éƒ¨ç½²ï¼š

```bash
# åªå¤åˆ¶ nginx.confï¼ˆä» init_file ç›®å½•ï¼‰
# ä½¿ç”¨é»˜è®¤è·¯å¾„
sudo cp init_file/nginx.conf /usr/local/openresty/nginx/conf/nginx.conf

# æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡æŒ‡å®šçš„è·¯å¾„
sudo cp init_file/nginx.conf ${OPENRESTY_PREFIX:-/usr/local/openresty}/nginx/conf/nginx.conf

# æ‰‹åŠ¨æ›´æ–° nginx.conf ä¸­çš„ include è·¯å¾„
# å°† include conf.d/set_conf/*.conf æ”¹ä¸º include $project_root/conf.d/set_conf/*.conf
# å°† include conf.d/vhost_conf/*.conf æ”¹ä¸º include $project_root/conf.d/vhost_conf/*.conf
# æ³¨æ„ï¼šä½¿ç”¨ $project_root å˜é‡è€Œä¸æ˜¯ç¡¬ç¼–ç è·¯å¾„
```

### 4.3 ä¿®æ”¹é…ç½®æ–‡ä»¶

ç¼–è¾‘é¡¹ç›®ç›®å½•ä¸‹çš„ `lua/config.lua`ï¼Œä¿®æ”¹æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼š

**é…ç½®æ–‡ä»¶ä½ç½®**ï¼š`lua/config.lua`ï¼ˆä¿æŒåœ¨é¡¹ç›®ç›®å½•ï¼Œä¸å¤åˆ¶åˆ°ç³»ç»Ÿç›®å½•ï¼‰

**Shell è„šæœ¬å…³è”**ï¼š
- `start.sh update-config` - è‡ªåŠ¨æ›´æ–° MySQL å’Œ Redis é…ç½®
- `deploy.sh` - æ›´æ–° Lua è„šæœ¬è·¯å¾„é…ç½®ï¼ˆ`conf.d/set_conf/lua.conf`ï¼‰
- `scripts/install_geoip.sh` - å®‰è£… GeoIP æ•°æ®åº“åˆ° `lua/geoip/`ï¼Œæç¤ºå¯ç”¨åœ°åŸŸå°æ§
- `scripts/optimize_system.sh` - ä¼˜åŒ–å…±äº«å†…å­˜é…ç½®ï¼ˆ`conf.d/set_conf/waf.conf`ï¼‰

**ä¸»è¦é…ç½®é¡¹**ï¼š

```lua
-- MySQL é…ç½®
_M.mysql = {
    host = "127.0.0.1",  -- ä¿®æ”¹ä¸ºå®é™… MySQL åœ°å€
    port = 3306,
    database = "waf_db",
    user = "waf_user",   -- ä¿®æ”¹ä¸ºå®é™…ç”¨æˆ·å
    password = "your_secure_password",  -- ä¿®æ”¹ä¸ºå®é™…å¯†ç 
    pool_size = 50,      -- è¿æ¥æ± å¤§å°
    pool_timeout = 10000,  -- è¿æ¥æ± è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
}

-- ç¼“å­˜é…ç½®ï¼ˆä¼˜åŒ–é¡¹ï¼‰
_M.cache = {
    ttl = 60,            -- ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
    max_items = 10000,   -- æœ€å¤§ç¼“å­˜é¡¹æ•°
    rule_list_ttl = 300, -- IP æ®µè§„åˆ™åˆ—è¡¨ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼Œ5åˆ†é’Ÿï¼‰
}

-- æ—¥å¿—é…ç½®ï¼ˆä¼˜åŒ–é¡¹ï¼‰
_M.log = {
    batch_size = 100,    -- æ‰¹é‡å†™å…¥å¤§å°
    batch_interval = 1,  -- æ‰¹é‡å†™å…¥é—´éš”ï¼ˆç§’ï¼‰
    enable_async = true, -- æ˜¯å¦å¼‚æ­¥å†™å…¥
    max_retry = 3,       -- æœ€å¤§é‡è¯•æ¬¡æ•°
    retry_delay = 0.1,   -- é‡è¯•å»¶è¿Ÿï¼ˆç§’ï¼‰
    buffer_warn_threshold = 0.8,  -- ç¼“å†²åŒºè­¦å‘Šé˜ˆå€¼ï¼ˆ80%ï¼‰
}
```

### 4.4 é…ç½®æ–‡ä»¶è¯´æ˜

**é‡è¦**ï¼šæ‰€æœ‰é…ç½®æ–‡ä»¶ä¿æŒåœ¨é¡¹ç›®ç›®å½•ï¼Œä¿®æ”¹åæ— éœ€é‡æ–°éƒ¨ç½²ï¼Œç›´æ¥ reload å³å¯ã€‚

- `conf.d/set_conf/waf.conf` - WAF å…±äº«å†…å­˜é…ç½®
- `conf.d/set_conf/lua.conf` - Lua æ¨¡å—è·¯å¾„é…ç½®
- `conf.d/set_conf/log.conf` - æ—¥å¿—é…ç½®
- `lua/config.lua` - æ•°æ®åº“è¿æ¥é…ç½®

ç¡®ä¿ `conf.d/set_conf/waf.conf` ä¸­é…ç½®äº†å…±äº«å†…å­˜ï¼š

```nginx
lua_shared_dict waf_cache 10m;      # WAF ç¼“å­˜
lua_shared_dict waf_log_buffer 50m; # æ—¥å¿—ç¼“å†²åŒº
```

## äº”ã€å¯åŠ¨æœåŠ¡

### 5.1 æµ‹è¯•é…ç½®æ–‡ä»¶

```bash
# æµ‹è¯• Nginx é…ç½®
sudo /usr/local/openresty/bin/openresty -t
```

### 5.2 å¯åŠ¨ OpenResty

```bash
# å¯åŠ¨æœåŠ¡
sudo /usr/local/openresty/bin/openresty

# æˆ–è€…ä½¿ç”¨ systemdï¼ˆéœ€è¦åˆ›å»ºæœåŠ¡æ–‡ä»¶ï¼‰
sudo systemctl start openresty
sudo systemctl enable openresty
```

### 5.3 åˆ›å»º systemd æœåŠ¡æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

åˆ›å»º `/etc/systemd/system/openresty.service`ï¼š

```ini
[Unit]
Description=OpenResty HTTP Server
After=network.target

[Service]
Type=forking
PIDFile=/path/to/project/logs/nginx.pid
ExecStart=/usr/local/openresty/bin/openresty
ExecReload=/bin/kill -s HUP $MAINPID
ExecStop=/bin/kill -s TERM $MAINPID
PrivateTmp=true

[Install]
WantedBy=multi-user.target
```

ç„¶åï¼š

```bash
sudo systemctl daemon-reload
sudo systemctl enable openresty
sudo systemctl start openresty
```

## å…­ã€éªŒè¯éƒ¨ç½²

### 6.1 æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥ OpenResty è¿›ç¨‹
ps aux | grep nginx

# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep :80

# æ£€æŸ¥ MySQL è¿æ¥
mysql -u waf_user -p waf_db -e "SELECT COUNT(*) FROM waf_access_logs;"
```

### 6.2 æµ‹è¯•åŠŸèƒ½

```bash
# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost/health

# æµ‹è¯•æ­£å¸¸è®¿é—®
curl http://localhost/

# æ£€æŸ¥æ—¥å¿—ï¼ˆé¡¹ç›®ç›®å½•ï¼‰
tail -f /path/to/project/logs/error.log
tail -f /path/to/project/logs/access.log
```

### 6.3 æµ‹è¯•å°æ§åŠŸèƒ½

```bash
# æ·»åŠ æµ‹è¯•å°æ§è§„åˆ™
mysql -u waf_user -p waf_db << EOF
INSERT INTO waf_block_rules (rule_type, rule_value, rule_name, status, priority)
VALUES ('single_ip', '127.0.0.1', 'æµ‹è¯•å°æ§', 1, 100);
EOF

# ç­‰å¾…ç¼“å­˜åˆ·æ–°ï¼ˆæˆ–é‡å¯æœåŠ¡ï¼‰
sleep 5

# æµ‹è¯•å°æ§ï¼ˆåº”è¯¥è¿”å› 403ï¼‰
curl -v http://localhost/
```

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–

### 7.1 ç³»ç»Ÿå‚æ•°ä¼˜åŒ–

ç¼–è¾‘ `/etc/sysctl.conf`ï¼š

```bash
# å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
fs.file-max = 65535

# ç½‘ç»œå‚æ•°ä¼˜åŒ–
net.core.somaxconn = 65535
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.ip_local_port_range = 1024 65535
```

åº”ç”¨é…ç½®ï¼š

```bash
sudo sysctl -p
```

### 7.2 OpenResty ä¼˜åŒ–

ç¼–è¾‘ `init_file/nginx.conf`ï¼ˆæˆ–ç³»ç»Ÿç›®å½•çš„ nginx.confï¼‰ï¼š

```nginx
# å¢åŠ  worker è¿›ç¨‹æ•°
worker_processes auto;

# å¢åŠ è¿æ¥æ•°
worker_connections 10240;

# å¯ç”¨ epoll
use epoll;
```

### 7.3 MySQL ä¼˜åŒ–

ç¼–è¾‘ `/etc/my.cnf` æˆ– `/etc/mysql/my.cnf`ï¼š

```ini
[mysqld]
# è¿æ¥æ•°
max_connections = 1000

# ç¼“å†²æ± å¤§å°ï¼ˆæ ¹æ®å†…å­˜è°ƒæ•´ï¼‰
innodb_buffer_pool_size = 2G

# æ—¥å¿—æ–‡ä»¶å¤§å°
innodb_log_file_size = 256M
```

## å…«ã€ç›‘æ§é…ç½®

### 8.1 æ—¥å¿—è½®è½¬

åˆ›å»º `/etc/logrotate.d/openresty`ï¼š

```
/path/to/project/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 nobody nobody
    sharedscripts
    postrotate
        /bin/kill -USR1 `cat /path/to/project/logs/nginx.pid 2> /dev/null` 2> /dev/null || true
    endscript
}
```

### 8.2 ç›‘æ§è„šæœ¬

åˆ›å»ºç›‘æ§è„šæœ¬æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼š

```bash
#!/bin/bash
# /usr/local/bin/check_waf.sh

# æ£€æŸ¥ OpenResty
if ! pgrep -f "nginx: master" > /dev/null; then
    echo "OpenResty is down!"
    exit 1
fi

# æ£€æŸ¥ MySQL
if ! mysqladmin -u waf_user -p'password' ping > /dev/null 2>&1; then
    echo "MySQL is down!"
    exit 1
fi

echo "All services are running"
exit 0
```

## ä¹ã€å¸¸è§é—®é¢˜

### 9.1 é…ç½®æ–‡ä»¶é”™è¯¯

**é—®é¢˜**ï¼š`nginx -t` æŠ¥é”™

**è§£å†³**ï¼š
- æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
- æ£€æŸ¥ Lua æ¨¡å—è·¯å¾„
- æ£€æŸ¥å…±äº«å†…å­˜é…ç½®

### 9.2 æ•°æ®åº“è¿æ¥å¤±è´¥

**é—®é¢˜**ï¼šæ—¥å¿—ä¸­æ˜¾ç¤ºæ•°æ®åº“è¿æ¥é”™è¯¯

**è§£å†³**ï¼š
- æ£€æŸ¥ MySQL æœåŠ¡æ˜¯å¦è¿è¡Œ
- æ£€æŸ¥ç”¨æˆ·åå¯†ç æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
- æ£€æŸ¥ MySQL ç”¨æˆ·æƒé™

### 9.3 æ€§èƒ½é—®é¢˜

**é—®é¢˜**ï¼šå“åº”æ…¢æˆ– QPS ä½

**è§£å†³**ï¼š
- æ£€æŸ¥æ•°æ®åº“è¿æ¥æ± é…ç½®
- æ£€æŸ¥ç¼“å­˜æ˜¯å¦ç”Ÿæ•ˆ
- æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
- ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•

### 9.4 æ—¥å¿—æœªå†™å…¥

**é—®é¢˜**ï¼šè®¿é—®æ—¥å¿—æœªå†™å…¥æ•°æ®åº“

**è§£å†³**ï¼š
- æ£€æŸ¥ `log_by_lua` æ˜¯å¦é…ç½®
- æ£€æŸ¥æ—¥å¿—ç¼“å†²åŒºå¤§å°
- æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„
- æŸ¥çœ‹é”™è¯¯æ—¥å¿—

## åã€å‡çº§å’Œç»´æŠ¤

### 10.1 å‡çº§æ­¥éª¤

```bash
# 1. å¤‡ä»½é…ç½®å’Œæ•°æ®
cp /usr/local/openresty/nginx/conf/nginx.conf /backup/nginx-conf-$(date +%Y%m%d).conf
cp -r /path/to/project/conf.d /backup/conf.d-$(date +%Y%m%d)
cp -r /path/to/project/lua /backup/lua-$(date +%Y%m%d)
cp -r /path/to/project/init_file /backup/init_file-$(date +%Y%m%d)
mysqldump -u waf_user -p waf_db > /backup/waf_db-$(date +%Y%m%d).sql

# 2. åœæ­¢æœåŠ¡
sudo systemctl stop openresty

# 3. æ›´æ–°ä»£ç 
# å¤åˆ¶æ–°çš„ Lua æ–‡ä»¶

# 4. æµ‹è¯•é…ç½®
sudo /usr/local/openresty/bin/openresty -t

# 5. å¯åŠ¨æœåŠ¡
sudo systemctl start openresty
```

### 10.2 æ•°æ®å¤‡ä»½

```bash
# æ¯æ—¥å¤‡ä»½è„šæœ¬
#!/bin/bash
BACKUP_DIR="/backup/waf"
DATE=$(date +%Y%m%d)

mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
mysqldump -u waf_user -p'password' waf_db | gzip > $BACKUP_DIR/waf_db_$DATE.sql.gz

# åˆ é™¤ 30 å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete
```

### 10.3 æ—¥å¿—å½’æ¡£

```bash
# å½’æ¡£ 90 å¤©å‰çš„æ—¥å¿—
mysql -u waf_user -p waf_db << EOF
CREATE TABLE IF NOT EXISTS waf_access_logs_archive LIKE waf_access_logs;
INSERT INTO waf_access_logs_archive SELECT * FROM waf_access_logs 
WHERE request_time < DATE_SUB(NOW(), INTERVAL 90 DAY);
DELETE FROM waf_access_logs WHERE request_time < DATE_SUB(NOW(), INTERVAL 90 DAY);
EOF
```

## åä¸€ã€å®‰å…¨å»ºè®®

### 11.1 æ•°æ®åº“å®‰å…¨

- ä½¿ç”¨å¼ºå¯†ç 
- é™åˆ¶æ•°æ®åº“ç”¨æˆ·æƒé™
- å¯ç”¨ SSL è¿æ¥ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- å®šæœŸæ›´æ–° MySQL

### 11.2 ç³»ç»Ÿå®‰å…¨

- å®šæœŸæ›´æ–°ç³»ç»Ÿè¡¥ä¸
- é…ç½®é˜²ç«å¢™è§„åˆ™
- é™åˆ¶ SSH è®¿é—®
- ä½¿ç”¨é root ç”¨æˆ·è¿è¡ŒæœåŠ¡

### 11.3 åº”ç”¨å®‰å…¨

- âœ… æ‰€æœ‰ç®¡ç†æ¥å£å’Œé¡µé¢éƒ½éœ€è¦ç™»å½•è®¤è¯
- âœ… æ”¯æŒTOTPåŒå› ç´ è®¤è¯ï¼ˆæ¨èå¯ç”¨ï¼‰
- âœ… å¯†ç ä½¿ç”¨BCryptå“ˆå¸Œå­˜å‚¨ï¼ˆå¿…é¡»ï¼‰
- âœ… é™åˆ¶ç®¡ç†æ¥å£è®¿é—®IPï¼ˆå»ºè®®é…ç½®ï¼‰
- âœ… ä½¿ç”¨HTTPSï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ï¼‰
- âœ… X-Forwarded-Forå®‰å…¨å¢å¼ºï¼ˆé˜²æ­¢IPä¼ªé€ ï¼‰
- âœ… å®šæœŸå®¡æŸ¥å°æ§è§„åˆ™
- âœ… å¯ç”¨ä¼šè¯ç®¡ç†ï¼ˆè‡ªåŠ¨è¿‡æœŸï¼‰
- âœ… è®°å½•æ‰€æœ‰ç®¡ç†æ“ä½œæ—¥å¿—

### 11.4 å¯†ç å®‰å…¨

**å¿…é¡»æ“ä½œ**ï¼š
1. å®‰è£…BCryptåº“ï¼š`opm get openresty/lua-resty-bcrypt`
2. ä½¿ç”¨APIç”Ÿæˆå¯†ç å“ˆå¸Œï¼š`POST /api/auth/password/hash`
3. æ›´æ–°æ•°æ®åº“ä¸­çš„å¯†ç å“ˆå¸Œ
4. åˆ é™¤é»˜è®¤å¯†ç 

**å¯†ç ç­–ç•¥**ï¼š
- å¯†ç é•¿åº¦è‡³å°‘12ä½ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦
- å®šæœŸæ›´æ¢å¯†ç 
- ä¸è¦åœ¨å¤šä¸ªç³»ç»Ÿä½¿ç”¨ç›¸åŒå¯†ç 

è¯¦ç»†è¯´æ˜è¯·å‚è€ƒï¼š[å¯†ç ç®¡ç†ä½¿ç”¨è¯´æ˜](å¯†ç ç®¡ç†ä½¿ç”¨è¯´æ˜.md)

## åäºŒã€æ•…éšœæ’æŸ¥

### 12.1 æŸ¥çœ‹æ—¥å¿—

```bash
# OpenResty é”™è¯¯æ—¥å¿—ï¼ˆé¡¹ç›®ç›®å½•ï¼‰
tail -f /path/to/project/logs/error.log

# OpenResty è®¿é—®æ—¥å¿—ï¼ˆé¡¹ç›®ç›®å½•ï¼‰
tail -f /path/to/project/logs/access.log

# MySQL é”™è¯¯æ—¥å¿—
tail -f /var/log/mysqld.log  # CentOS
tail -f /var/log/mysql/error.log  # Ubuntu
```

### 12.2 æ€§èƒ½åˆ†æ

```bash
# æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€
top -p $(pgrep -f "nginx: worker")

# æŸ¥çœ‹è¿æ¥æ•°
netstat -an | grep :80 | wc -l

# æŸ¥çœ‹æ•°æ®åº“è¿æ¥
mysql -u waf_user -p -e "SHOW PROCESSLIST;"
```

### 12.3 è°ƒè¯•æ¨¡å¼

åœ¨é¡¹ç›®ç›®å½•çš„ `init_file/nginx.conf` ä¸­å¯ç”¨è°ƒè¯•æ—¥å¿—ï¼ˆç¼–è¾‘åé‡æ–°éƒ¨ç½²ï¼‰ï¼š

```nginx
error_log /path/to/project/logs/error.log debug;
```

**æ³¨æ„**ï¼šä¿®æ”¹ `init_file/nginx.conf` åéœ€è¦é‡æ–°è¿è¡Œéƒ¨ç½²è„šæœ¬ `scripts/deploy.sh` æ‰èƒ½ç”Ÿæ•ˆã€‚

## åä¸‰ã€ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•

- [ ] æ•°æ®åº“å¯†ç å·²ä¿®æ”¹ä¸ºå¼ºå¯†ç 
- [ ] é…ç½®æ–‡ä»¶ä¸­çš„æ•æ„Ÿä¿¡æ¯å·²æ›´æ–°
- [ ] é˜²ç«å¢™è§„åˆ™å·²é…ç½®
- [ ] æ—¥å¿—è½®è½¬å·²é…ç½®
- [ ] ç›‘æ§å‘Šè­¦å·²é…ç½®
- [ ] æ•°æ®å¤‡ä»½å·²é…ç½®
- [ ] SSL è¯ä¹¦å·²é…ç½®ï¼ˆå¦‚ä½¿ç”¨ HTTPSï¼‰
- [ ] æ€§èƒ½å‚æ•°å·²ä¼˜åŒ–
- [ ] å®‰å…¨åŠ å›ºå·²å®Œæˆ
- [ ] æ–‡æ¡£å·²å®Œå–„

