# OpenResty + MySQL IP 采集与封控系统 - 部署文档

## 📋 快速开始

推荐使用本部署文档配合 `scripts/*.sh` 脚本分步安装；如需自定义一键流程，可自行编写包装脚本调用这些子脚本。

## 📁 项目结构详解

### 目录结构

```
OPENRESTY_WAF/
├── README.md                    # 项目主文档
├── start.sh                     # 可选的入口脚本（如需要可自行扩展）
│
├── init_file/                   # 初始配置文件目录
│   ├── nginx.conf               # Nginx 主配置文件（部署时复制到系统目录）
│   └── init.sql                 # 数据库表结构和初始数据
│
├── conf.d/                      # 配置文件目录（保持在项目目录）⭐
│   ├── http_set/                # HTTP 参数配置文件
│   │   ├── basic.conf           # 基础配置（sendfile、keepalive等）
│   │   ├── gzip.conf            # Gzip 压缩配置
│   │   ├── performance.conf     # 性能优化配置（包含 HTTP/2 配置）
│   │   ├── log.conf             # 日志格式和访问日志配置
│   │   ├── lua.conf             # Lua 模块路径配置
│   │   ├── mime.conf            # MIME 类型配置
│   │   ├── performance.conf     # 性能优化配置
│   │   ├── upstream.conf        # 后端服务器配置
│   │   └── waf.conf             # WAF 共享内存和限流配置
│   ├── vhost_conf/              # 虚拟主机配置
│   │   ├── default.conf         # 默认 HTTP 服务器配置（代理到后端）
│   │   └── waf.conf             # WAF 管理服务配置（API和Web界面）
│   └── cert/                    # SSL 证书目录（可选）
│
├── lua/                         # Lua 脚本目录（保持在项目目录）
│   ├── config.lua               # 主配置文件（数据库连接等）
│   ├── api/                     # API接口模块
│   │   ├── handler.lua          # API路由分发器
│   │   ├── auth.lua              # 认证API（登录、登出、密码管理）
│   │   ├── rules.lua             # 规则管理API（CRUD操作）
│   │   ├── stats.lua             # 统计报表API
│   │   ├── proxy.lua             # 反向代理管理API
│   │   ├── features.lua         # 功能开关管理API
│   │   ├── templates.lua         # 规则模板管理API
│   │   ├── batch.lua             # 批量操作API（导入/导出）
│   │   ├── config_check.lua      # 配置检查API
│   │   ├── system.lua            # 系统管理API（Nginx重载、状态）
│   │   ├── performance.lua      # 性能监控API
│   │   └── utils.lua             # API工具函数
│   ├── web/                     # Web前端文件
│   │   ├── handler.lua          # Web路由分发器
│   │   ├── login.html           # 登录页面
│   │   ├── features.html        # 功能管理界面
│   │   ├── rule_management.html # 规则管理界面
│   │   ├── proxy_management.html # 反向代理管理界面
│   │   ├── stats.html           # 统计报表界面
│   │   └── monitor.html         # 监控面板界面
│   ├── waf/                     # WAF 核心模块
│   │   ├── init.lua              # 初始化模块（定时器、缓存预热）
│   │   ├── ip_block.lua          # IP 封控模块
│   │   ├── ip_utils.lua          # IP 工具函数（CIDR、IP段匹配）
│   │   ├── ip_trie.lua           # IP Trie树（高效IP匹配）
│   │   ├── geo_block.lua         # 地域封控模块
│   │   ├── log_collect.lua       # 日志采集模块（异步批量写入）
│   │   ├── log_queue.lua         # 日志队列模块
│   │   ├── mysql_pool.lua        # MySQL 连接池
│   │   ├── redis_cache.lua       # Redis 缓存模块
│   │   ├── lru_cache.lua         # LRU 本地缓存
│   │   ├── cache_warmup.lua      # 缓存预热模块
│   │   ├── cache_invalidation.lua # 缓存失效模块
│   │   ├── cache_protection.lua   # 缓存穿透防护
│   │   ├── cache_optimizer.lua    # 缓存策略优化（动态TTL）
│   │   ├── cache_tuner.lua       # 缓存自动调优
│   │   ├── auto_block.lua        # 自动封控模块
│   │   ├── auto_unblock.lua      # 自动解封模块
│   │   ├── auth.lua              # 用户认证模块
│   │   ├── totp.lua              # TOTP双因素认证
│   │   ├── password_utils.lua    # 密码工具模块
│   │   ├── csrf.lua              # CSRF防护模块
│   │   ├── rate_limit.lua        # 速率限制模块
│   │   ├── rule_management.lua   # 规则管理模块
│   │   ├── rule_templates.lua    # 规则模板模块
│   │   ├── rule_backup.lua       # 规则备份模块
│   │   ├── rule_notification.lua # 规则更新通知
│   │   ├── batch_operations.lua  # 批量操作模块
│   │   ├── feature_switches.lua  # 功能开关模块
│   │   ├── proxy_management.lua  # 反向代理管理
│   │   ├── frequency_stats.lua   # 频率统计模块
│   │   ├── serializer.lua        # 序列化模块（JSON/MessagePack）
│   │   ├── metrics.lua           # 监控指标模块（Prometheus）
│   │   ├── alert.lua             # 告警模块
│   │   ├── health_check.lua      # 健康检查模块
│   │   ├── fallback.lua          # 降级机制模块
│   │   ├── pool_monitor.lua      # 连接池监控模块
│   │   ├── performance_monitor.lua # 性能监控模块（慢查询分析）
│   │   ├── path_utils.lua        # 路径工具模块
│   │   ├── config_manager.lua    # 配置管理模块（数据库配置）
│   │   ├── config_validator.lua  # 配置验证模块
│   │   ├── config_file_generator.lua # 配置文件生成器
│   │   ├── shared_memory_optimizer.lua # 共享内存优化
│   │   ├── audit_log.lua         # 审计日志模块
│   │   └── test_framework.lua    # 测试框架模块
│   ├── geoip/                    # GeoIP 数据库目录
│   │   └── GeoLite2-City.mmdb    # GeoIP2 数据库文件（可选）
│   └── tests/                    # 测试文件
│       ├── unit/                 # 单元测试
│       └── integration/          # 集成测试
│
├── scripts/                      # 脚本目录
│   ├── install_openresty.sh      # OpenResty 安装脚本
│   ├── install_mysql.sh          # MySQL 安装脚本
│   ├── install_redis.sh          # Redis 安装脚本
│   ├── install_geoip.sh          # GeoIP 数据库安装脚本
│   ├── install_dependencies.sh  # Lua 模块依赖安装脚本
│   ├── deploy.sh                 # 配置文件部署脚本
│   ├── optimize_system.sh        # 系统优化脚本
│   ├── check_all.sh              # 项目检查脚本
│   ├── update_geoip.sh           # GeoIP 数据库更新脚本
│   ├── set_lua_database_connect.sh # 数据库连接配置脚本
│   └── uninstall_*.sh           # 卸载脚本（各组件）
│
├── docs/                         # 文档目录
│   ├── 部署文档.md               # 本文件
│   ├── 技术实施方案.md           # 技术实施方案
│   ├── 性能优化指南.md           # 性能优化指南
│   └── 硬件开销与并发量分析.md   # 硬件配置分析
│
└── logs/                         # 日志文件目录（保持在项目目录）
    ├── error.log                 # 错误日志
    ├── access.log                # 访问日志
    └── nginx.pid                 # Nginx PID 文件
```

### 部署策略说明

**重要**：项目采用"配置分离"策略，确保代码可移植性和配置灵活性。

| 文件/目录 | 部署位置 | 说明 |
|----------|---------|------|
| `init_file/nginx.conf` | `${OPENRESTY_PREFIX}/nginx/conf/nginx.conf` | 主配置文件，部署时复制 |
| `conf.d/` | **保持在项目目录** | 所有配置文件保持在项目目录，通过 `$project_root` 变量引用 |
| `lua/` | **保持在项目目录** | Lua 脚本不复制，通过 `$project_root` 变量引用 |
| `logs/` | **保持在项目目录** | 日志文件保持在项目目录 |
| `init_file/init.sql` | 仅用于初始化数据库 | 不复制，直接执行 |

**路径配置说明**：
- 所有脚本支持通过环境变量 `OPENRESTY_PREFIX` 配置 OpenResty 安装路径（默认：`/usr/local/openresty`）
- 项目路径使用相对路径，通过 `$project_root` 变量在配置文件中引用
- 无硬编码绝对路径，支持灵活部署

## 🎯 系统功能概览

安装完成后，系统提供以下完整功能：

**核心功能**：
- ✅ IP封控（单个IP、IP段、地域封控）
- ✅ 白名单机制
- ✅ 访问日志采集
- ✅ 自动封控（基于频率和行为）
- ✅ 自动解封

**管理功能**：
- ✅ Web管理界面（登录、功能管理、规则管理、代理管理、统计、监控）
- ✅ RESTful API接口（完整的CRUD操作）
- ✅ 规则管理（CRUD、导入/导出、分组、模板）
- ✅ 规则备份和恢复
- ✅ 功能开关管理（动态控制功能启用/禁用）
- ✅ 反向代理管理（HTTP、TCP、UDP）
- ✅ 统计报表（概览、时间序列、IP统计、规则统计）
- ✅ 监控面板（实时监控、Prometheus指标）
- ✅ 配置验证（启动时和运行时）

**安全功能**：
- ✅ 用户认证（用户名密码登录）
- ✅ TOTP双因素认证（支持本地QR码生成）
- ✅ 密码管理（BCrypt哈希、强度检查、生成工具）
- ✅ 会话管理（Cookie-based）
- ✅ X-Forwarded-For安全增强（受信任代理检查）
- ✅ 所有API和页面都需要登录认证

**性能优化**：
- ✅ 多级缓存（共享内存、LRU、Redis二级缓存）
- ✅ 缓存预热机制
- ✅ 缓存失效机制（版本号检查）
- ✅ 缓存穿透防护（布隆过滤器、频率限制）
- ✅ 数据库连接池（可监控、可自动调整）
- ✅ 异步批量日志写入
- ✅ 日志队列机制
- ✅ IP Trie树高效匹配
- ✅ 降级机制（数据库故障时自动降级）
- ✅ 系统自动优化（根据硬件自动优化）

---

## 一、环境要求

### 1.1 系统要求

**操作系统支持**（脚本自动检测）：
- **RedHat 系列**：CentOS 6.x/7.x/8.x、RHEL 6.x/7.x/8.x/9.x、Fedora、Rocky Linux 8.x/9.x、AlmaLinux 8.x/9.x、Oracle Linux 7.x/8.x/9.x、Amazon Linux 1/2/2023
- **Debian 系列**：Debian 9+、Ubuntu 16.04+、Linux Mint、Kali Linux、Raspbian
- **SUSE 系列**：openSUSE Leap/Tumbleweed、SLES
- **Arch 系列**：Arch Linux、Manjaro
- **其他**：Alpine Linux、Gentoo

**硬件要求**：
- **CPU**：2 核及以上（推荐 4 核+）
- **内存**：4GB 及以上（推荐 8GB+）
- **磁盘**：20GB 及以上（根据日志量调整）

### 1.2 软件要求
- **OpenResty**：1.21.4.1 或更高版本
- **MySQL**：8.0 或 MariaDB 10.6+
- **Redis**：5.0+（可选，用于缓存）

## 二、安装步骤

### 2.1 安装 OpenResty

**推荐使用一键安装脚本**（自动检测系统类型并安装）：

```bash
# 使用一键安装脚本（支持多种 Linux 发行版）
sudo ./scripts/install_openresty.sh

# 自定义安装路径（默认：/usr/local/openresty）
sudo OPENRESTY_PREFIX=/opt/openresty ./scripts/install_openresty.sh
```

脚本会自动：
- ✅ 检测操作系统类型（支持 20+ 种 Linux 发行版）
- ✅ 安装所需依赖包
- ✅ 安装 OpenResty（优先使用包管理器，失败则从源码编译）
- ✅ 配置 systemd 服务
- ✅ 安装常用 Lua 模块

**手动安装**（不推荐，仅作参考）：

#### CentOS/RHEL
```bash
# 添加 OpenResty 仓库
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo

# 安装 OpenResty
sudo yum install -y openresty openresty-resty

# 验证安装
/usr/local/openresty/bin/openresty -v
```

#### Ubuntu/Debian
```bash
# 添加 OpenResty 仓库
wget -qO - https://openresty.org/package/pubkey.gpg | sudo apt-key add -
sudo apt-get -y install software-properties-common
sudo add-apt-repository -y "deb http://openresty.org/package/ubuntu $(lsb_release -sc) main"
sudo apt-get update

# 安装 OpenResty
sudo apt-get install -y openresty

# 验证安装
/usr/local/openresty/bin/openresty -v
```

**注意**：所有脚本都支持通过环境变量 `OPENRESTY_PREFIX` 配置安装路径，无硬编码绝对路径。

### 2.2 安装 MySQL

**推荐使用一键安装脚本**（自动检测系统类型并优化配置）：

```bash
# 使用一键安装脚本（支持多种 Linux 发行版）
sudo ./scripts/install_mysql.sh
```

脚本会自动：
- ✅ 检测操作系统类型
- ✅ 检测硬件配置（CPU、内存）
- ✅ 根据硬件自动优化 MySQL 配置参数
- ✅ 创建数据库和用户
- ✅ 执行 SQL 脚本初始化数据库
- ✅ 更新 WAF 配置文件

**手动安装**（不推荐，仅作参考）：

#### CentOS/RHEL
```bash
# 安装 MySQL 8.0
sudo yum install -y mysql-server

# 启动 MySQL
sudo systemctl start mysqld
sudo systemctl enable mysqld

# 获取临时密码
sudo grep 'temporary password' /var/log/mysqld.log
```

#### Ubuntu/Debian
```bash
# 安装 MySQL 8.0
sudo apt-get update
sudo apt-get install -y mysql-server

# 启动 MySQL
sudo systemctl start mysql
sudo systemctl enable mysql
```

### 2.3 安装 Redis（可选）

**推荐使用一键安装脚本**（自动检测系统类型并优化配置）：

```bash
# 使用一键安装脚本（支持多种 Linux 发行版）
sudo ./scripts/install_redis.sh
```

脚本会自动：
- ✅ 检测操作系统类型
- ✅ 检测硬件配置（CPU、内存）
- ✅ 根据硬件自动优化 Redis 配置参数
- ✅ 配置 systemd 服务
- ✅ 更新 WAF 配置文件

**手动安装**（不推荐，仅作参考）：

```bash
# CentOS/RHEL
sudo yum install -y redis

# Ubuntu/Debian
sudo apt-get install -y redis-server

# 启动 Redis
sudo systemctl start redis
sudo systemctl enable redis
```

### 2.4 安装 Lua 依赖模块

**推荐使用依赖管理脚本**（自动检查并安装所有依赖）：

```bash
# 检查依赖状态（交互式）
sudo ./scripts/check_dependencies.sh

# 或自动安装所有依赖
sudo ./scripts/install_dependencies.sh
```

**手动安装**（不推荐，仅作参考）：

```bash
# 安装 lua-resty-mysql
opm get openresty/lua-resty-mysql

# 安装 lua-resty-redis（可选）
opm get openresty/lua-resty-redis

# 安装 lua-resty-maxminddb（用于地域识别，可选）
opm get anjia0532/lua-resty-maxminddb
```

### 2.5 配置 GeoIP2 数据库（可选，用于地域封控）

**重要**：地域封控支持国内（省市级别）和国外（国家级别），需要使用 **GeoLite2-City.mmdb**（City 版本），而不是 Country 版本。

**推荐使用一键安装脚本**：

```bash
# 使用一键安装脚本（推荐）
sudo ./scripts/install_geoip.sh
```

脚本会自动：
- 下载 GeoLite2-City 数据库
- 安装到项目目录的 `lua/geoip/` 目录
- 设置文件权限
- 配置自动更新计划任务

**手动安装**（不推荐）：

```bash
# 创建 GeoIP2 数据库目录（项目目录）
mkdir -p /path/to/project/lua/geoip

# 下载 GeoLite2-City 数据库（注意是 City 版本）
# 方式一：从 MaxMind 官网下载（需要注册账号）
# 访问：https://dev.maxmind.com/geoip/geoip2/geolite2/
# 下载 GeoLite2-City.mmdb 并放到项目目录的 lua/geoip/ 目录

# 方式二：使用 wget（需要 License Key）
# wget "https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-City&license_key=YOUR_LICENSE_KEY&suffix=tar.gz" -O /tmp/GeoLite2-City.tar.gz
# tar -xzf /tmp/GeoLite2-City.tar.gz -C /tmp/
# cp /tmp/GeoLite2-City_*/GeoLite2-City.mmdb /path/to/project/lua/geoip/

# 设置文件权限
chown nobody:nobody /path/to/project/lua/geoip/GeoLite2-City.mmdb
chmod 644 /path/to/project/lua/geoip/GeoLite2-City.mmdb
```

**注意**：
- 如果不使用地域封控功能，可以跳过此步骤
- 必须使用 **GeoLite2-City.mmdb**（City 版本），Country 版本不包含省市信息
- 数据库文件较大（约 30-50MB），确保有足够空间

## 三、数据库配置

### 3.1 创建数据库和用户

```bash
# 登录 MySQL
mysql -u root -p

# 创建数据库
CREATE DATABASE waf_db DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

# 创建用户
CREATE USER 'waf_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON waf_db.* TO 'waf_user'@'localhost';
FLUSH PRIVILEGES;

# 退出
EXIT;
```

### 3.2 导入数据库结构

```bash
# 执行 SQL 脚本
mysql -u waf_user -p waf_db < /path/to/init_file/init.sql
```

### 3.3 验证数据库

```bash
mysql -u waf_user -p waf_db -e "SHOW TABLES;"
```

## 四、配置文件部署

### 4.1 使用部署脚本（推荐）

```bash
# 使用部署脚本自动部署
sudo ./scripts/deploy.sh
```

部署脚本会自动：
- 复制 `init_file/nginx.conf` 到系统目录
- 更新所有路径配置（指向项目目录）
- 设置文件权限

**部署策略**：
- `init_file/nginx.conf` - 复制到 `/usr/local/openresty/nginx/conf/nginx.conf`
- `conf.d/` - **保持在项目目录**（方便配置管理）
- `lua/` - **保持在项目目录**（不复制）
- `logs/` - **保持在项目目录**（日志文件）

### 4.2 手动部署（不推荐）

如果需要手动部署：

```bash
# 只复制 nginx.conf（从 init_file 目录）
# 使用默认路径
sudo cp init_file/nginx.conf /usr/local/openresty/nginx/conf/nginx.conf

# 或使用环境变量指定的路径
sudo cp init_file/nginx.conf ${OPENRESTY_PREFIX:-/usr/local/openresty}/nginx/conf/nginx.conf

# 手动更新 nginx.conf 中的 include 路径（如需从绝对路径改为项目路径）
# 例如：
# include /path/to/project/conf.d/http_set/*.conf;
# include /path/to/project/conf.d/vhost_conf/waf.conf;
```

### 4.3 修改配置文件

编辑项目目录下的 `lua/config.lua`，修改数据库连接信息：

**配置文件位置**：`lua/config.lua`（保持在项目目录，不复制到系统目录）

**脚本关联（可选辅助工具）**：
- `scripts/deploy.sh` - 部署 `init_file/nginx.conf` 并写入项目绝对路径、创建必要目录
- `scripts/install_geoip.sh` - 安装 GeoIP 数据库到 `lua/geoip/`，提示启用地域封控
- `scripts/optimize_system.sh` - 根据硬件自动优化内核和 OpenResty 配置

**主要配置项**：

```lua
-- MySQL 配置
_M.mysql = {
    host = "127.0.0.1",  -- 修改为实际 MySQL 地址
    port = 3306,
    database = "waf_db",
    user = "waf_user",   -- 修改为实际用户名
    password = "your_secure_password",  -- 修改为实际密码
    pool_size = 50,      -- 连接池大小
    pool_timeout = 10000,  -- 连接池超时（毫秒）
}

-- 缓存配置（优化项）
_M.cache = {
    ttl = 60,            -- 缓存过期时间（秒）
    max_items = 10000,   -- 最大缓存项数
    rule_list_ttl = 300, -- IP 段规则列表缓存时间（秒，5分钟）
}

-- 日志配置（优化项）
_M.log = {
    batch_size = 100,    -- 批量写入大小
    batch_interval = 1,  -- 批量写入间隔（秒）
    enable_async = true, -- 是否异步写入
    max_retry = 3,       -- 最大重试次数
    retry_delay = 0.1,   -- 重试延迟（秒）
    buffer_warn_threshold = 0.8,  -- 缓冲区警告阈值（80%）
}
```

### 4.4 配置文件详细说明

**重要**：所有配置文件保持在项目目录，修改后无需重新部署，直接 reload 即可。

#### 4.4.1 Nginx 主配置文件

**位置**：`init_file/nginx.conf`（部署后复制到系统目录）

**主要配置项**：
- `worker_processes auto` - Worker 进程数（自动检测 CPU 核心数）
- `worker_connections 65535` - 每个 worker 的最大连接数
- `error_log` - 错误日志路径（必须使用绝对路径）
- `pid` - PID 文件路径（必须使用绝对路径）
- `$project_root` - 项目根目录变量（部署脚本自动设置）

**注意**：
- `error_log` 和 `pid` 不支持变量，部署脚本会自动替换为绝对路径
- 其他路径使用 `$project_root` 变量引用项目目录

#### 4.4.2 WAF 共享内存配置

**位置**：`conf.d/http_set/waf.conf`

**配置项**：
```nginx
# WAF 缓存共享内存（用于存储IP封控规则、白名单等）
lua_shared_dict waf_cache 10m;

# 日志缓冲区（用于异步批量写入日志）
lua_shared_dict waf_log_buffer 50m;

# 限流配置（可选）
limit_req_zone $binary_remote_addr zone=req_limit:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
```

**调优建议**：
- `waf_cache`：根据规则数量调整，每1000条规则约需1MB
- `waf_log_buffer`：根据日志量调整，高并发场景建议100MB+

#### 4.4.3 Lua 模块路径配置

**位置**：`conf.d/http_set/lua.conf`

**配置项**：
```nginx
# Lua 包路径（指向项目目录）
lua_package_path "$project_root/lua/?.lua;$project_root/lua/?/init.lua;;";

# Lua C 模块路径（OpenResty 默认路径）
lua_package_cpath "/usr/local/openresty/lualib/?.so;;";

# 初始化脚本（在 master 进程启动时执行）
init_by_lua_block {
    -- 设置项目根目录
    package.path = package.path .. ";$project_root/lua/?.lua;$project_root/lua/?/init.lua"
    
    -- 初始化 WAF 模块
    require("waf.init").init()
}

# Worker 进程初始化（在每个 worker 启动时执行）
init_worker_by_lua_block {
    -- Worker 进程初始化逻辑
    require("waf.init").init_worker()
}
```

#### 4.4.4 日志配置

**位置**：`conf.d/http_set/log.conf`

**配置项**：
```nginx
# 日志格式定义
log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                '$status $body_bytes_sent "$http_referer" '
                '"$http_user_agent" "$http_x_forwarded_for" '
                'rt=$request_time uct="$upstream_connect_time" '
                'uht="$upstream_header_time" urt="$upstream_response_time"';

# 访问日志（项目目录）
access_log $project_root/logs/access.log main;

# 错误日志（已在 nginx.conf 中配置）
# error_log $project_root/logs/error.log warn;
```

#### 4.4.5 数据库连接配置

**位置**：`lua/config.lua`（保持在项目目录）

**MySQL 配置**：
```lua
_M.mysql = {
    host = "127.0.0.1",        -- MySQL 主机地址
    port = 3306,              -- MySQL 端口
    database = "waf_db",      -- 数据库名
    user = "waf_user",        -- 用户名
    password = "your_password", -- 密码（必须修改）
    pool_size = 50,           -- 连接池大小（高并发建议100+）
    pool_timeout = 10000,     -- 连接池超时（毫秒）
    max_packet_size = 1048576 -- 最大数据包大小（1MB）
}
```

**Redis 配置**（可选）：
```lua
_M.redis = {
    host = "127.0.0.1",       -- Redis 主机地址
    port = 6379,              -- Redis 端口
    password = nil,           -- Redis 密码（可选）
    db = 0,                   -- 数据库索引
    timeout = 1000,           -- 超时时间（毫秒）
    pool_size = 100           -- 连接池大小
}
```

**缓存配置**：
```lua
_M.cache = {
    ttl = 60,                -- 缓存过期时间（秒）
    max_items = 10000,       -- 最大缓存项数
    rule_list_ttl = 300      -- IP 段规则列表缓存时间（秒）
}
```

**日志配置**：
```lua
_M.log = {
    batch_size = 100,        -- 批量写入大小
    batch_interval = 1,      -- 批量写入间隔（秒）
    enable_async = true,     -- 是否异步写入
    max_retry = 3,          -- 最大重试次数
    retry_delay = 0.1,      -- 重试延迟（秒）
    buffer_warn_threshold = 0.8  -- 缓冲区警告阈值（80%）
}
```

**功能开关配置**（从数据库读取）：
```lua
-- 所有功能模块的 enable 配置都从数据库读取，支持热更新
-- 配置项存储在 waf_system_config 表中
-- 通过 config_manager 模块动态读取
```

#### 4.4.6 虚拟主机配置

**位置**：`conf.d/vhost_conf/waf.conf`（WAF 管理服务）

**主要配置**：
- `location /api/` - API 统一入口（路由分发到各个 API 模块）
- `location /` - Web 管理界面统一入口（路由分发到各个 HTML 页面）
- `log_by_lua_block` - 日志采集（异步批量写入）

**位置**：`conf.d/vhost_conf/default.conf`（代理到后端服务器）

**主要配置**：
- `access_by_lua_block` - IP 封控检查（在请求处理前执行）
- `log_by_lua_block` - 日志采集（在请求处理后执行）
- `proxy_pass` - 代理到后端服务器

#### 4.4.7 性能优化配置

**位置**：`conf.d/http_set/performance.conf`

**配置项**：
```nginx
# 启用 sendfile（零拷贝）
sendfile on;
tcp_nopush on;
tcp_nodelay on;

# Keepalive 连接
keepalive_timeout 65;
keepalive_requests 100;

# 客户端请求体大小限制
client_max_body_size 10m;
client_body_buffer_size 128k;

# 缓冲区大小
client_header_buffer_size 4k;
large_client_header_buffers 4 16k;
```

#### 4.4.8 压缩配置

**位置**：`conf.d/http_set/gzip.conf`（Gzip）

**Gzip 配置**：
```nginx
gzip on;
gzip_vary on;
gzip_min_length 1000;
gzip_comp_level 6;
gzip_types text/plain text/css text/xml text/javascript
           application/json application/javascript application/xml+rss
           application/rss+xml font/truetype font/opentype
           application/vnd.ms-fontobject image/svg+xml;
```

#### 4.4.9 HTTP/2 配置

**位置**：`conf.d/http_set/performance.conf`（已合并到性能配置中）

**配置项**：
```nginx
# 在 server 块中启用 HTTP/2（需要 SSL）
listen 443 ssl http2;

# HTTP/2 推送（可选）
http2_push_preload on;
```

**注意**：HTTP/2 通常与 SSL/TLS 一起使用，需要配置 SSL 证书。

## 五、启动服务

### 5.1 测试配置文件

```bash
# 测试 Nginx 配置
sudo /usr/local/openresty/bin/openresty -t
```

### 5.2 启动 OpenResty

```bash
# 启动服务
sudo /usr/local/openresty/bin/openresty

# 或者使用 systemd（需要创建服务文件）
sudo systemctl start openresty
sudo systemctl enable openresty
```

### 5.3 创建 systemd 服务文件（可选）

创建 `/etc/systemd/system/openresty.service`：

```ini
[Unit]
Description=OpenResty HTTP Server
After=network.target

[Service]
Type=forking
PIDFile=/path/to/project/logs/nginx.pid
ExecStart=/usr/local/openresty/bin/openresty
ExecReload=/bin/kill -s HUP $MAINPID
ExecStop=/bin/kill -s TERM $MAINPID
PrivateTmp=true

[Install]
WantedBy=multi-user.target
```

然后：

```bash
sudo systemctl daemon-reload
sudo systemctl enable openresty
sudo systemctl start openresty
```

## 六、验证部署

### 6.1 检查服务状态

```bash
# 检查 OpenResty 进程
ps aux | grep nginx

# 检查端口监听
netstat -tlnp | grep :80

# 检查 MySQL 连接
mysql -u waf_user -p waf_db -e "SELECT COUNT(*) FROM waf_access_logs;"
```

### 6.2 测试功能

```bash
# 测试健康检查
curl http://localhost/health

# 测试正常访问
curl http://localhost/

# 检查日志（项目目录）
tail -f /path/to/project/logs/error.log
tail -f /path/to/project/logs/access.log
```

### 6.3 测试封控功能

```bash
# 添加测试封控规则
mysql -u waf_user -p waf_db << EOF
INSERT INTO waf_block_rules (rule_type, rule_value, rule_name, status, priority)
VALUES ('single_ip', '127.0.0.1', '测试封控', 1, 100);
EOF

# 等待缓存刷新（或重启服务）
sleep 5

# 测试封控（应该返回 403）
curl -v http://localhost/
```

## 七、性能优化

### 7.1 系统参数优化

编辑 `/etc/sysctl.conf`：

```bash
# 增加文件描述符限制
fs.file-max = 65535

# 网络参数优化
net.core.somaxconn = 65535
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.ip_local_port_range = 1024 65535
```

应用配置：

```bash
sudo sysctl -p
```

### 7.2 OpenResty 优化

编辑 `init_file/nginx.conf`（或系统目录的 nginx.conf）：

```nginx
# 增加 worker 进程数
worker_processes auto;

# 增加连接数
worker_connections 10240;

# 启用 epoll
use epoll;
```

### 7.3 MySQL 优化

编辑 `/etc/my.cnf` 或 `/etc/mysql/my.cnf`：

```ini
[mysqld]
# 连接数
max_connections = 1000

# 缓冲池大小（根据内存调整）
innodb_buffer_pool_size = 2G

# 日志文件大小
innodb_log_file_size = 256M
```

## 八、监控配置

### 8.1 日志轮转

创建 `/etc/logrotate.d/openresty`：

```
/path/to/project/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 nobody nobody
    sharedscripts
    postrotate
        /bin/kill -USR1 `cat /path/to/project/logs/nginx.pid 2> /dev/null` 2> /dev/null || true
    endscript
}
```

### 8.2 监控脚本

创建监控脚本检查服务状态：

```bash
#!/bin/bash
# /usr/local/bin/check_waf.sh

# 检查 OpenResty
if ! pgrep -f "nginx: master" > /dev/null; then
    echo "OpenResty is down!"
    exit 1
fi

# 检查 MySQL
if ! mysqladmin -u waf_user -p'password' ping > /dev/null 2>&1; then
    echo "MySQL is down!"
    exit 1
fi

echo "All services are running"
exit 0
```

## 九、常见问题与故障排查

### 9.1 配置文件错误

#### 问题：`nginx -t` 报错

**可能原因**：
1. 配置文件语法错误
2. Lua 模块路径不正确
3. 共享内存配置错误
4. 变量未正确设置

**排查步骤**：
```bash
# 1. 检查配置文件语法
sudo /usr/local/openresty/bin/openresty -t

# 2. 检查错误日志
tail -f /path/to/project/logs/error.log

# 3. 检查 Lua 模块路径
grep -r "lua_package_path" /usr/local/openresty/nginx/conf/nginx.conf

# 4. 检查共享内存配置
grep -r "lua_shared_dict" /usr/local/openresty/nginx/conf/nginx.conf

# 5. 检查项目根目录变量
grep -r "project_root" /usr/local/openresty/nginx/conf/nginx.conf
```

**解决方案**：
- 确保 `$project_root` 变量已正确设置
- 检查 Lua 模块文件是否存在
- 确保共享内存大小足够
- 重新运行部署脚本：`sudo ./scripts/deploy.sh`

### 9.2 数据库连接失败

#### 问题：日志中显示数据库连接错误

**错误示例**：
```
[error] failed to connect to MySQL: timeout
[error] MySQL connection pool exhausted
```

**排查步骤**：
```bash
# 1. 检查 MySQL 服务状态
sudo systemctl status mysql
# 或
sudo systemctl status mysqld

# 2. 测试 MySQL 连接
mysql -u waf_user -p waf_db -e "SELECT 1"

# 3. 检查 MySQL 用户权限
mysql -u root -p -e "SHOW GRANTS FOR 'waf_user'@'localhost'"

# 4. 检查防火墙规则
sudo iptables -L -n | grep 3306
# 或
sudo firewall-cmd --list-all

# 5. 检查 MySQL 连接数限制
mysql -u root -p -e "SHOW VARIABLES LIKE 'max_connections'"

# 6. 检查当前连接数
mysql -u root -p -e "SHOW PROCESSLIST"
```

**解决方案**：
- 确保 MySQL 服务正在运行
- 检查 `lua/config.lua` 中的数据库连接信息
- 确保 MySQL 用户有足够权限
- 检查防火墙是否允许连接
- 增加 MySQL `max_connections` 配置
- 检查连接池大小配置（`pool_size`）

### 9.3 Redis 连接失败

#### 问题：Redis 连接错误（可选功能）

**排查步骤**：
```bash
# 1. 检查 Redis 服务状态
sudo systemctl status redis

# 2. 测试 Redis 连接
redis-cli ping

# 3. 检查 Redis 配置
redis-cli CONFIG GET requirepass

# 4. 检查防火墙规则
sudo iptables -L -n | grep 6379
```

**解决方案**：
- Redis 是可选的，如果不需要可以禁用
- 检查 `lua/config.lua` 中的 Redis 配置
- 确保 Redis 密码配置正确（如果有）

### 9.4 性能问题

#### 问题：响应慢或 QPS 低

**排查步骤**：
```bash
# 1. 检查系统资源使用情况
top
htop
free -h
df -h

# 2. 检查 Nginx Worker 进程
ps aux | grep nginx
top -p $(pgrep -d, -f "nginx: worker")

# 3. 检查数据库连接池使用情况
# 查看日志中的连接池警告

# 4. 检查缓存命中率
# 通过性能监控 API：GET /api/performance/stats

# 5. 检查慢查询
# 通过性能监控 API：GET /api/performance/slow-queries

# 6. 检查数据库索引
mysql -u waf_user -p waf_db -e "SHOW INDEX FROM waf_block_rules"
```

**解决方案**：
- 增加数据库连接池大小（`pool_size`）
- 检查缓存是否生效（查看缓存命中率）
- 优化数据库索引
- 增加共享内存大小
- 检查系统资源是否充足
- 使用 Redis 二级缓存
- 优化数据库查询（查看慢查询日志）

### 9.5 日志未写入数据库

#### 问题：访问日志未写入数据库

**排查步骤**：
```bash
# 1. 检查 log_by_lua 配置
grep -r "log_by_lua" /usr/local/openresty/nginx/conf/nginx.conf

# 2. 检查日志缓冲区大小
grep -r "waf_log_buffer" /usr/local/openresty/nginx/conf/nginx.conf

# 3. 检查数据库表结构
mysql -u waf_user -p waf_db -e "DESCRIBE waf_access_logs"

# 4. 查看错误日志
tail -f /path/to/project/logs/error.log | grep -i "log"

# 5. 检查日志采集模块
# 查看日志中是否有 log_collect 相关错误
```

**解决方案**：
- 确保 `log_by_lua_block` 已配置
- 增加日志缓冲区大小（`waf_log_buffer`）
- 检查数据库表结构是否正确
- 检查数据库连接是否正常
- 查看错误日志获取详细错误信息

### 9.6 IP 封控不生效

#### 问题：添加了封控规则但未生效

**排查步骤**：
```bash
# 1. 检查规则是否已启用
mysql -u waf_user -p waf_db -e "SELECT * FROM waf_block_rules WHERE status=1"

# 2. 检查缓存是否过期
# 规则列表缓存 TTL 为 300 秒（5分钟）

# 3. 检查封控功能是否启用
mysql -u waf_user -p waf_db -e "SELECT * FROM waf_system_config WHERE config_key='block_enable'"

# 4. 检查错误日志
tail -f /path/to/project/logs/error.log | grep -i "block"

# 5. 手动刷新缓存（通过 API 或重启服务）
```

**解决方案**：
- 确保规则状态为启用（`status=1`）
- 等待缓存刷新（最多5分钟）
- 确保封控功能已启用（`block_enable=1`）
- 检查 IP 地址格式是否正确
- 检查白名单是否包含该 IP
- 手动触发缓存刷新或重启服务

### 9.7 认证失败

#### 问题：无法登录或登录后立即失效

**排查步骤**：
```bash
# 1. 检查用户是否存在
mysql -u waf_user -p waf_db -e "SELECT * FROM waf_users"

# 2. 检查密码哈希格式
mysql -u waf_user -p waf_db -e "SELECT username, password FROM waf_users"

# 3. 检查会话表
mysql -u waf_user -p waf_db -e "SELECT * FROM waf_sessions"

# 4. 检查错误日志
tail -f /path/to/project/logs/error.log | grep -i "auth"

# 5. 检查 Cookie 设置
# 使用浏览器开发者工具检查 Cookie
```

**解决方案**：
- 确保用户存在且密码正确
- 确保密码使用 BCrypt 哈希格式
- 检查会话 Cookie 是否被正确设置
- 检查 Cookie 域名和路径配置
- 清除浏览器 Cookie 后重试
- 检查 TOTP 配置（如果启用）

### 9.8 API 返回 403 错误

#### 问题：API 调用返回 403 Forbidden

**可能原因**：
1. CSRF Token 验证失败
2. 功能开关被禁用
3. 权限不足

**排查步骤**：
```bash
# 1. 检查 CSRF Token
# 查看请求头中是否包含 X-CSRF-Token

# 2. 检查功能开关
curl -X GET http://localhost/api/features -b cookies.txt

# 3. 检查错误日志
tail -f /path/to/project/logs/error.log | grep -i "csrf\|403"
```

**解决方案**：
- 确保请求头包含 CSRF Token（POST、PUT、DELETE 请求）
- 检查功能开关是否启用
- 确保用户有足够权限
- 检查速率限制是否触发

### 9.9 缓存问题

#### 问题：缓存不生效或数据不一致

**排查步骤**：
```bash
# 1. 检查共享内存使用情况
# 通过系统状态 API：GET /api/system/status

# 2. 检查缓存配置
grep -r "waf_cache" /usr/local/openresty/nginx/conf/nginx.conf

# 3. 检查缓存版本号
mysql -u waf_user -p waf_db -e "SELECT * FROM waf_cache_versions"

# 4. 检查 Redis 连接（如果使用）
redis-cli ping
```

**解决方案**：
- 增加共享内存大小
- 检查缓存版本号是否更新
- 手动触发缓存刷新
- 检查 Redis 连接（如果使用）
- 重启服务清除缓存

### 9.10 GeoIP 地域识别失败

#### 问题：地域封控不生效或识别错误

**排查步骤**：
```bash
# 1. 检查 GeoIP 数据库文件是否存在
ls -lh /path/to/project/lua/geoip/GeoLite2-City.mmdb

# 2. 检查文件权限
stat /path/to/project/lua/geoip/GeoLite2-City.mmdb

# 3. 检查地域封控功能是否启用
mysql -u waf_user -p waf_db -e "SELECT * FROM waf_system_config WHERE config_key='geo_enable'"

# 4. 检查错误日志
tail -f /path/to/project/logs/error.log | grep -i "geo"
```

**解决方案**：
- 确保 GeoIP 数据库文件存在且可读
- 确保使用 GeoLite2-City.mmdb（City 版本）
- 启用地域封控功能（`geo_enable=1`）
- 更新 GeoIP 数据库：`sudo ./scripts/update_geoip.sh`
- 检查文件权限（nobody:nobody，644）

### 9.11 服务无法启动

#### 问题：OpenResty 服务无法启动

**排查步骤**：
```bash
# 1. 检查配置文件语法
sudo /usr/local/openresty/bin/openresty -t

# 2. 检查端口是否被占用
sudo netstat -tlnp | grep :80
sudo lsof -i :80

# 3. 检查 PID 文件
ls -l /path/to/project/logs/nginx.pid

# 4. 检查错误日志
tail -f /path/to/project/logs/error.log

# 5. 检查权限
ls -l /path/to/project/logs/
```

**解决方案**：
- 修复配置文件语法错误
- 停止占用端口的进程
- 删除旧的 PID 文件
- 检查日志目录权限
- 使用 root 权限启动服务

### 9.12 批量导入规则失败

#### 问题：批量导入规则时出错

**排查步骤**：
```bash
# 1. 检查文件格式
file /path/to/rules.json

# 2. 检查文件大小
ls -lh /path/to/rules.json

# 3. 检查数据库连接
mysql -u waf_user -p waf_db -e "SELECT COUNT(*) FROM waf_block_rules"

# 4. 检查错误日志
tail -f /path/to/project/logs/error.log | grep -i "import\|batch"
```

**解决方案**：
- 确保文件格式正确（JSON 或 CSV）
- 检查文件大小限制（`client_max_body_size`）
- 分批导入大量规则
- 检查数据库连接和权限
- 查看错误日志获取详细错误信息

## 十、升级和维护

### 10.1 升级步骤

```bash
# 1. 备份配置和数据
cp /usr/local/openresty/nginx/conf/nginx.conf /backup/nginx-conf-$(date +%Y%m%d).conf
cp -r /path/to/project/conf.d /backup/conf.d-$(date +%Y%m%d)
cp -r /path/to/project/lua /backup/lua-$(date +%Y%m%d)
cp -r /path/to/project/init_file /backup/init_file-$(date +%Y%m%d)
mysqldump -u waf_user -p waf_db > /backup/waf_db-$(date +%Y%m%d).sql

# 2. 停止服务
sudo systemctl stop openresty

# 3. 更新代码
# 复制新的 Lua 文件

# 4. 测试配置
sudo /usr/local/openresty/bin/openresty -t

# 5. 启动服务
sudo systemctl start openresty
```

### 10.2 数据备份

```bash
# 每日备份脚本
#!/bin/bash
BACKUP_DIR="/backup/waf"
DATE=$(date +%Y%m%d)

mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u waf_user -p'password' waf_db | gzip > $BACKUP_DIR/waf_db_$DATE.sql.gz

# 删除 30 天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete
```

### 10.3 日志归档

```bash
# 归档 90 天前的日志
mysql -u waf_user -p waf_db << EOF
CREATE TABLE IF NOT EXISTS waf_access_logs_archive LIKE waf_access_logs;
INSERT INTO waf_access_logs_archive SELECT * FROM waf_access_logs 
WHERE request_time < DATE_SUB(NOW(), INTERVAL 90 DAY);
DELETE FROM waf_access_logs WHERE request_time < DATE_SUB(NOW(), INTERVAL 90 DAY);
EOF
```

## 十一、安全建议

### 11.1 数据库安全

- 使用强密码
- 限制数据库用户权限
- 启用 SSL 连接（生产环境）
- 定期更新 MySQL

### 11.2 系统安全

- 定期更新系统补丁
- 配置防火墙规则
- 限制 SSH 访问
- 使用非 root 用户运行服务

### 11.3 应用安全

- ✅ 所有管理接口和页面都需要登录认证
- ✅ 支持TOTP双因素认证（推荐启用）
- ✅ 密码使用BCrypt哈希存储（必须）
- ✅ 限制管理接口访问IP（建议配置）
- ✅ 使用HTTPS（生产环境必须）
- ✅ X-Forwarded-For安全增强（防止IP伪造）
- ✅ 定期审查封控规则
- ✅ 启用会话管理（自动过期）
- ✅ 记录所有管理操作日志

### 11.4 密码安全

**必须操作**：
1. 安装BCrypt库：`opm get openresty/lua-resty-bcrypt`
2. 使用API生成密码哈希：`POST /api/auth/password/hash`
3. 更新数据库中的密码哈希
4. 删除默认密码

**密码策略**：
- 密码长度至少12位（生产环境）
- 包含大小写字母、数字、特殊字符
- 定期更换密码
- 不要在多个系统使用相同密码

密码策略和认证安全的详细说明请参考 `docs/技术实施方案.md` 中的安全设计章节。

## 十二、故障排查

### 12.1 查看日志

```bash
# OpenResty 错误日志（项目目录）
tail -f /path/to/project/logs/error.log

# OpenResty 访问日志（项目目录）
tail -f /path/to/project/logs/access.log

# MySQL 错误日志
tail -f /var/log/mysqld.log  # CentOS
tail -f /var/log/mysql/error.log  # Ubuntu
```

### 12.2 性能分析

```bash
# 查看进程状态
top -p $(pgrep -f "nginx: worker")

# 查看连接数
netstat -an | grep :80 | wc -l

# 查看数据库连接
mysql -u waf_user -p -e "SHOW PROCESSLIST;"
```

### 12.3 调试模式

在项目目录的 `init_file/nginx.conf` 中启用调试日志（编辑后重新部署）：

```nginx
error_log /path/to/project/logs/error.log debug;
```

**注意**：修改 `init_file/nginx.conf` 后需要重新运行部署脚本 `scripts/deploy.sh` 才能生效。

## 十三、API 接口详细说明

### 13.1 API 基础信息

**API 基础路径**：`http://your-domain/api/`

**认证方式**：
- Cookie-based 会话认证（`waf_session` Cookie）
- 除登录相关 API 外，所有 API 都需要认证
- 支持 CSRF Token 防护（POST、PUT、DELETE 请求）

**速率限制**：
- 登录接口：5次/分钟（每个用户名）
- API 接口：100次/分钟（每个用户）
- 响应头包含速率限制信息：`X-RateLimit-Limit`、`X-RateLimit-Remaining`、`X-RateLimit-Reset`

**响应格式**：
- 成功响应：`{"success": true, "data": {...}}`
- 错误响应：`{"error": "错误类型", "message": "错误信息"}`

### 13.2 认证相关 API

#### 13.2.1 用户登录

**接口**：`POST /api/auth/login`

**请求参数**：
```json
{
    "username": "admin",
    "password": "your_password",
    "totp_code": "123456"  // 可选，如果启用了TOTP
}
```

**响应示例**：
```json
{
    "success": true,
    "data": {
        "username": "admin",
        "session_id": "xxx",
        "totp_required": false
    }
}
```

#### 13.2.2 检查登录状态

**接口**：`GET /api/auth/check`

**响应示例**：
```json
{
    "success": true,
    "data": {
        "authenticated": true,
        "username": "admin"
    }
}
```

#### 13.2.3 用户登出

**接口**：`POST /api/auth/logout`

**响应示例**：
```json
{
    "success": true,
    "message": "登出成功"
}
```

#### 13.2.4 获取当前用户信息

**接口**：`GET /api/auth/me`

**响应示例**：
```json
{
    "success": true,
    "data": {
        "username": "admin",
        "totp_enabled": false
    }
}
```

#### 13.2.5 TOTP 双因素认证

**设置 TOTP**：`POST /api/auth/totp/setup`
**启用 TOTP**：`POST /api/auth/totp/enable`
**禁用 TOTP**：`POST /api/auth/totp/disable`

**密码管理**：
- `POST /api/auth/password/hash` - 生成密码哈希（管理员）
- `POST /api/auth/password/check` - 检查密码强度
- `POST /api/auth/password/generate` - 生成随机密码（管理员）

### 13.3 规则管理 API

#### 13.3.1 获取规则列表

**接口**：`GET /api/rules?page=1&page_size=20&rule_type=single_ip&status=1`

**查询参数**：
- `page` - 页码（默认：1）
- `page_size` - 每页数量（默认：20）
- `rule_type` - 规则类型（`single_ip`、`ip_range`、`geo`）
- `status` - 状态（`1`-启用，`0`-禁用）
- `keyword` - 关键词搜索

**响应示例**：
```json
{
    "success": true,
    "data": {
        "rules": [...],
        "total": 100,
        "page": 1,
        "page_size": 20
    }
}
```

#### 13.3.2 创建规则

**接口**：`POST /api/rules`

**请求参数**：
```json
{
    "rule_type": "single_ip",
    "rule_value": "192.168.1.100",
    "rule_name": "封控IP",
    "priority": 100,
    "status": 1,
    "group_name": "测试组"
}
```

#### 13.3.3 更新规则

**接口**：`PUT /api/rules/{id}`

**请求参数**：同创建规则

#### 13.3.4 删除规则

**接口**：`DELETE /api/rules/{id}`

#### 13.3.5 启用/禁用规则

**接口**：`POST /api/rules/{id}/enable` 或 `POST /api/rules/{id}/disable`

### 13.4 批量操作 API

#### 13.4.1 导出规则

**JSON 格式**：`GET /api/rules/export/json`
**CSV 格式**：`GET /api/rules/export/csv`

**查询参数**：
- `rule_type` - 过滤规则类型
- `status` - 过滤状态

#### 13.4.2 导入规则

**JSON 格式**：`POST /api/rules/import/json`
**CSV 格式**：`POST /api/rules/import/csv`

**请求体**：规则数据（JSON 或 CSV 格式）

**响应示例**：
```json
{
    "success": true,
    "data": {
        "imported": 100,
        "skipped": 5,
        "failed": 2
    }
}
```

### 13.5 功能开关管理 API

#### 13.5.1 获取所有功能开关

**接口**：`GET /api/features`

**响应示例**：
```json
{
    "success": true,
    "data": {
        "block_enable": true,
        "whitelist_enable": true,
        "geo_enable": false,
        ...
    }
}
```

#### 13.5.2 更新功能开关

**接口**：`PUT /api/features/{key}`

**请求参数**：
```json
{
    "value": true
}
```

#### 13.5.3 批量更新功能开关

**接口**：`POST /api/features/batch`

**请求参数**：
```json
{
    "updates": {
        "block_enable": true,
        "whitelist_enable": false
    }
}
```

### 13.6 统计报表 API

#### 13.6.1 统计概览

**接口**：`GET /api/stats/overview?start_time=2024-01-01&end_time=2024-01-31`

**响应示例**：
```json
{
    "success": true,
    "data": {
        "total_requests": 100000,
        "blocked_requests": 1000,
        "block_rate": 0.01,
        "top_blocked_ips": [...],
        "top_rules": [...]
    }
}
```

#### 13.6.2 时间序列统计

**接口**：`GET /api/stats/timeseries?start_time=2024-01-01&end_time=2024-01-31&interval=hour`

**查询参数**：
- `start_time` - 开始时间
- `end_time` - 结束时间
- `interval` - 时间间隔（`hour`、`day`、`week`、`month`）

#### 13.6.3 IP 统计

**接口**：`GET /api/stats/ip?ip=192.168.1.100&start_time=2024-01-01&end_time=2024-01-31`

#### 13.6.4 规则统计

**接口**：`GET /api/stats/rules?rule_id=1&start_time=2024-01-01&end_time=2024-01-31`

### 13.7 反向代理管理 API

#### 13.7.1 获取代理配置列表

**接口**：`GET /api/proxy`

#### 13.7.2 创建代理配置

**接口**：`POST /api/proxy`

**请求参数**：
```json
{
    "proxy_type": "http",
    "listen_port": 8080,
    "backend_host": "127.0.0.1",
    "backend_port": 3000,
    "status": 1
}
```

#### 13.7.3 更新代理配置

**接口**：`PUT /api/proxy/{id}`

#### 13.7.4 删除代理配置

**接口**：`DELETE /api/proxy/{id}`

### 13.8 系统管理 API

#### 13.8.1 重新加载 Nginx 配置

**接口**：`POST /api/system/reload`

**响应示例**：
```json
{
    "success": true,
    "message": "Nginx配置已重新加载"
}
```

#### 13.8.2 测试 Nginx 配置

**接口**：`GET /api/system/test-config` 或 `POST /api/system/test-config`

**响应示例**：
```json
{
    "success": true,
    "data": {
        "valid": true,
        "message": "配置文件语法正确"
    }
}
```

#### 13.8.3 获取系统状态

**接口**：`GET /api/system/status`

**响应示例**：
```json
{
    "success": true,
    "data": {
        "nginx_running": true,
        "mysql_connected": true,
        "redis_connected": true,
        "cache_size": 1024,
        "worker_processes": 8
    }
}
```

### 13.9 性能监控 API

#### 13.9.1 获取慢查询列表

**接口**：`GET /api/performance/slow-queries?limit=100`

**响应示例**：
```json
{
    "success": true,
    "data": [
        {
            "sql": "SELECT * FROM waf_block_rules",
            "duration_ms": 150,
            "timestamp": 1234567890
        }
    ],
    "total": 50
}
```

#### 13.9.2 获取性能统计

**接口**：`GET /api/performance/stats`

**响应示例**：
```json
{
    "success": true,
    "data": {
        "cache_hit_rate": 0.95,
        "avg_response_time": 10,
        "qps": 1000
    }
}
```

#### 13.9.3 分析慢查询

**接口**：`GET /api/performance/analyze`

#### 13.9.4 获取缓存使用情况

**接口**：`GET /api/performance/cache/usage`

#### 13.9.5 获取缓存调优历史

**接口**：`GET /api/performance/cache/tuning-history?limit=50`

#### 13.9.6 获取缓存调优建议

**接口**：`GET /api/performance/cache/recommendations`

### 13.10 模板管理 API

#### 13.10.1 获取模板列表

**接口**：`GET /api/templates/list`

#### 13.10.2 获取模板详情

**接口**：`GET /api/templates/get?name=template_name`

#### 13.10.3 应用模板

**接口**：`POST /api/templates/apply`

**请求参数**：
```json
{
    "template_name": "template_name",
    "variables": {
        "ip": "192.168.1.0/24"
    }
}
```

### 13.11 配置检查 API

#### 13.11.1 执行配置检查

**接口**：`GET /api/config/check`

**响应示例**：
```json
{
    "success": true,
    "data": {
        "valid": true,
        "errors": [],
        "warnings": []
    }
}
```

#### 13.11.2 获取配置验证结果

**接口**：`GET /api/config/results`

#### 13.11.3 获取格式化的配置验证结果

**接口**：`GET /api/config/formatted`

### 13.12 API 使用示例

#### 13.12.1 使用 curl 调用 API

```bash
# 登录
curl -X POST http://localhost/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"password"}' \
  -c cookies.txt

# 获取规则列表（使用Cookie）
curl -X GET http://localhost/api/rules \
  -b cookies.txt

# 创建规则
curl -X POST http://localhost/api/rules \
  -H "Content-Type: application/json" \
  -b cookies.txt \
  -d '{
    "rule_type": "single_ip",
    "rule_value": "192.168.1.100",
    "rule_name": "测试封控",
    "priority": 100,
    "status": 1
  }'
```

#### 13.12.2 使用 Python 调用 API

```python
import requests

# 登录
session = requests.Session()
response = session.post('http://localhost/api/auth/login', json={
    'username': 'admin',
    'password': 'password'
})
print(response.json())

# 获取规则列表
response = session.get('http://localhost/api/rules')
print(response.json())

# 创建规则
response = session.post('http://localhost/api/rules', json={
    'rule_type': 'single_ip',
    'rule_value': '192.168.1.100',
    'rule_name': '测试封控',
    'priority': 100,
    'status': 1
})
print(response.json())
```

## 十四、生产环境检查清单

- [ ] 数据库密码已修改为强密码
- [ ] 配置文件中的敏感信息已更新
- [ ] 防火墙规则已配置
- [ ] 日志轮转已配置
- [ ] 监控告警已配置
- [ ] 数据备份已配置
- [ ] SSL 证书已配置（如使用 HTTPS）
- [ ] 性能参数已优化
- [ ] 安全加固已完成
- [ ] 文档已完善
- [ ] API 接口已测试
- [ ] 功能开关已配置
- [ ] 速率限制已配置
- [ ] CSRF 防护已启用
- [ ] TOTP 双因素认证已配置（推荐）

