# OpenResty + MySQL IP 采集与封控系统 - 部署文档

## 一、环境要求

### 1.1 系统要求
- **操作系统**：CentOS 7+ / Ubuntu 18.04+ / Debian 9+
- **CPU**：2 核及以上
- **内存**：4GB 及以上
- **磁盘**：20GB 及以上（根据日志量调整）

### 1.2 软件要求
- **OpenResty**：1.21.4.1 或更高版本
- **MySQL**：8.0 或 MariaDB 10.6+
- **Redis**：5.0+（可选，用于缓存）

## 二、安装步骤

### 2.1 安装 OpenResty

#### CentOS/RHEL
```bash
# 添加 OpenResty 仓库
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo

# 安装 OpenResty
sudo yum install -y openresty openresty-resty

# 验证安装
/usr/local/openresty/bin/openresty -v
```

#### Ubuntu/Debian
```bash
# 添加 OpenResty 仓库
wget -qO - https://openresty.org/package/pubkey.gpg | sudo apt-key add -
sudo apt-get -y install software-properties-common
sudo add-apt-repository -y "deb http://openresty.org/package/ubuntu $(lsb_release -sc) main"
sudo apt-get update

# 安装 OpenResty
sudo apt-get install -y openresty

# 验证安装
/usr/local/openresty/bin/openresty -v
```

### 2.2 安装 MySQL

#### CentOS/RHEL
```bash
# 安装 MySQL 8.0
sudo yum install -y mysql-server

# 启动 MySQL
sudo systemctl start mysqld
sudo systemctl enable mysqld

# 获取临时密码
sudo grep 'temporary password' /var/log/mysqld.log
```

#### Ubuntu/Debian
```bash
# 安装 MySQL 8.0
sudo apt-get update
sudo apt-get install -y mysql-server

# 启动 MySQL
sudo systemctl start mysql
sudo systemctl enable mysql
```

### 2.3 安装 Redis（可选）

```bash
# CentOS/RHEL
sudo yum install -y redis

# Ubuntu/Debian
sudo apt-get install -y redis-server

# 启动 Redis
sudo systemctl start redis
sudo systemctl enable redis
```

### 2.4 安装 Lua 依赖模块

```bash
# 安装 lua-resty-mysql
opm get openresty/lua-resty-mysql

# 安装 lua-resty-redis（可选）
opm get openresty/lua-resty-redis

# 安装 lua-resty-maxminddb（用于地域识别，可选）
opm get anjia0532/lua-resty-maxminddb
```

### 2.5 配置 GeoIP2 数据库（可选，用于地域封控）

**重要**：地域封控支持国内（省市级别）和国外（国家级别），需要使用 **GeoLite2-City.mmdb**（City 版本），而不是 Country 版本。

**推荐使用一键安装脚本**：

```bash
# 使用一键安装脚本（推荐）
sudo ./scripts/install_geoip.sh
```

脚本会自动：
- 下载 GeoLite2-City 数据库
- 安装到项目目录的 `lua/geoip/` 目录
- 设置文件权限
- 配置自动更新计划任务

**手动安装**（不推荐）：

```bash
# 创建 GeoIP2 数据库目录（项目目录）
mkdir -p /path/to/project/lua/geoip

# 下载 GeoLite2-City 数据库（注意是 City 版本）
# 方式一：从 MaxMind 官网下载（需要注册账号）
# 访问：https://dev.maxmind.com/geoip/geoip2/geolite2/
# 下载 GeoLite2-City.mmdb 并放到项目目录的 lua/geoip/ 目录

# 方式二：使用 wget（需要 License Key）
# wget "https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-City&license_key=YOUR_LICENSE_KEY&suffix=tar.gz" -O /tmp/GeoLite2-City.tar.gz
# tar -xzf /tmp/GeoLite2-City.tar.gz -C /tmp/
# cp /tmp/GeoLite2-City_*/GeoLite2-City.mmdb /path/to/project/lua/geoip/

# 设置文件权限
chown nobody:nobody /path/to/project/lua/geoip/GeoLite2-City.mmdb
chmod 644 /path/to/project/lua/geoip/GeoLite2-City.mmdb
```

**注意**：
- 如果不使用地域封控功能，可以跳过此步骤
- 必须使用 **GeoLite2-City.mmdb**（City 版本），Country 版本不包含省市信息
- 数据库文件较大（约 30-50MB），确保有足够空间

## 三、数据库配置

### 3.1 创建数据库和用户

```bash
# 登录 MySQL
mysql -u root -p

# 创建数据库
CREATE DATABASE waf_db DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

# 创建用户
CREATE USER 'waf_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON waf_db.* TO 'waf_user'@'localhost';
FLUSH PRIVILEGES;

# 退出
EXIT;
```

### 3.2 导入数据库结构

```bash
# 执行 SQL 脚本
mysql -u waf_user -p waf_db < /path/to/init_file/数据库设计.sql
```

### 3.3 验证数据库

```bash
mysql -u waf_user -p waf_db -e "SHOW TABLES;"
```

## 四、配置文件部署

### 4.1 使用部署脚本（推荐）

```bash
# 使用部署脚本自动部署
sudo ./scripts/deploy.sh
```

部署脚本会自动：
- 复制 `init_file/nginx.conf` 到系统目录
- 更新所有路径配置（指向项目目录）
- 设置文件权限

**部署策略**：
- `init_file/nginx.conf` - 复制到 `/usr/local/openresty/nginx/conf/nginx.conf`
- `conf.d/` - **保持在项目目录**（方便配置管理）
- `lua/` - **保持在项目目录**（不复制）
- `logs/` - **保持在项目目录**（日志文件）

### 4.2 手动部署（不推荐）

如果需要手动部署：

```bash
# 只复制 nginx.conf（从 init_file 目录）
sudo cp init_file/nginx.conf /usr/local/openresty/nginx/conf/nginx.conf

# 手动更新 nginx.conf 中的 include 路径
# 将 include conf.d/set_conf/*.conf 改为 include /path/to/project/conf.d/set_conf/*.conf
# 将 include conf.d/vhost_conf/*.conf 改为 include /path/to/project/conf.d/vhost_conf/*.conf
```

### 4.3 修改配置文件

编辑项目目录下的 `lua/config.lua`，修改数据库连接信息：

**配置文件位置**：`lua/config.lua`（保持在项目目录，不复制到系统目录）

**Shell 脚本关联**：
- `install.sh` - 自动更新 MySQL 和 Redis 配置
- `deploy.sh` - 更新 Lua 脚本路径配置（`conf.d/set_conf/lua.conf`）
- `scripts/install_geoip.sh` - 安装 GeoIP 数据库到 `lua/geoip/`，提示启用地域封控
- `scripts/optimize_system.sh` - 优化共享内存配置（`conf.d/set_conf/waf.conf`）

**主要配置项**：

```lua
-- MySQL 配置
_M.mysql = {
    host = "127.0.0.1",  -- 修改为实际 MySQL 地址
    port = 3306,
    database = "waf_db",
    user = "waf_user",   -- 修改为实际用户名
    password = "your_secure_password",  -- 修改为实际密码
    pool_size = 50,      -- 连接池大小
    pool_timeout = 10000,  -- 连接池超时（毫秒）
}

-- 缓存配置（优化项）
_M.cache = {
    ttl = 60,            -- 缓存过期时间（秒）
    max_items = 10000,   -- 最大缓存项数
    rule_list_ttl = 300, -- IP 段规则列表缓存时间（秒，5分钟）
}

-- 日志配置（优化项）
_M.log = {
    batch_size = 100,    -- 批量写入大小
    batch_interval = 1,  -- 批量写入间隔（秒）
    enable_async = true, -- 是否异步写入
    max_retry = 3,       -- 最大重试次数
    retry_delay = 0.1,   -- 重试延迟（秒）
    buffer_warn_threshold = 0.8,  -- 缓冲区警告阈值（80%）
}
```

### 4.4 配置文件说明

**重要**：所有配置文件保持在项目目录，修改后无需重新部署，直接 reload 即可。

- `conf.d/set_conf/waf.conf` - WAF 共享内存配置
- `conf.d/set_conf/lua.conf` - Lua 模块路径配置
- `conf.d/set_conf/log.conf` - 日志配置
- `lua/config.lua` - 数据库连接配置

确保 `conf.d/set_conf/waf.conf` 中配置了共享内存：

```nginx
lua_shared_dict waf_cache 10m;      # WAF 缓存
lua_shared_dict waf_log_buffer 50m; # 日志缓冲区
```

## 五、启动服务

### 5.1 测试配置文件

```bash
# 测试 Nginx 配置
sudo /usr/local/openresty/bin/openresty -t
```

### 5.2 启动 OpenResty

```bash
# 启动服务
sudo /usr/local/openresty/bin/openresty

# 或者使用 systemd（需要创建服务文件）
sudo systemctl start openresty
sudo systemctl enable openresty
```

### 5.3 创建 systemd 服务文件（可选）

创建 `/etc/systemd/system/openresty.service`：

```ini
[Unit]
Description=OpenResty HTTP Server
After=network.target

[Service]
Type=forking
PIDFile=/usr/local/openresty/nginx/logs/nginx.pid
ExecStart=/usr/local/openresty/bin/openresty
ExecReload=/bin/kill -s HUP $MAINPID
ExecStop=/bin/kill -s TERM $MAINPID
PrivateTmp=true

[Install]
WantedBy=multi-user.target
```

然后：

```bash
sudo systemctl daemon-reload
sudo systemctl enable openresty
sudo systemctl start openresty
```

## 六、验证部署

### 6.1 检查服务状态

```bash
# 检查 OpenResty 进程
ps aux | grep nginx

# 检查端口监听
netstat -tlnp | grep :80

# 检查 MySQL 连接
mysql -u waf_user -p waf_db -e "SELECT COUNT(*) FROM waf_access_logs;"
```

### 6.2 测试功能

```bash
# 测试健康检查
curl http://localhost/health

# 测试正常访问
curl http://localhost/

# 检查日志（项目目录）
tail -f /path/to/project/logs/error.log
tail -f /path/to/project/logs/access.log
```

### 6.3 测试封控功能

```bash
# 添加测试封控规则
mysql -u waf_user -p waf_db << EOF
INSERT INTO waf_block_rules (rule_type, rule_value, rule_name, status, priority)
VALUES ('single_ip', '127.0.0.1', '测试封控', 1, 100);
EOF

# 等待缓存刷新（或重启服务）
sleep 5

# 测试封控（应该返回 403）
curl -v http://localhost/
```

## 七、性能优化

### 7.1 系统参数优化

编辑 `/etc/sysctl.conf`：

```bash
# 增加文件描述符限制
fs.file-max = 65535

# 网络参数优化
net.core.somaxconn = 65535
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.ip_local_port_range = 1024 65535
```

应用配置：

```bash
sudo sysctl -p
```

### 7.2 OpenResty 优化

编辑 `init_file/nginx.conf`（或系统目录的 nginx.conf）：

```nginx
# 增加 worker 进程数
worker_processes auto;

# 增加连接数
worker_connections 10240;

# 启用 epoll
use epoll;
```

### 7.3 MySQL 优化

编辑 `/etc/my.cnf` 或 `/etc/mysql/my.cnf`：

```ini
[mysqld]
# 连接数
max_connections = 1000

# 缓冲池大小（根据内存调整）
innodb_buffer_pool_size = 2G

# 日志文件大小
innodb_log_file_size = 256M
```

## 八、监控配置

### 8.1 日志轮转

创建 `/etc/logrotate.d/openresty`：

```
/path/to/project/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 nobody nobody
    sharedscripts
    postrotate
        /bin/kill -USR1 `cat /path/to/project/logs/nginx.pid 2> /dev/null` 2> /dev/null || true
    endscript
}
```

### 8.2 监控脚本

创建监控脚本检查服务状态：

```bash
#!/bin/bash
# /usr/local/bin/check_waf.sh

# 检查 OpenResty
if ! pgrep -f "nginx: master" > /dev/null; then
    echo "OpenResty is down!"
    exit 1
fi

# 检查 MySQL
if ! mysqladmin -u waf_user -p'password' ping > /dev/null 2>&1; then
    echo "MySQL is down!"
    exit 1
fi

echo "All services are running"
exit 0
```

## 九、常见问题

### 9.1 配置文件错误

**问题**：`nginx -t` 报错

**解决**：
- 检查配置文件语法
- 检查 Lua 模块路径
- 检查共享内存配置

### 9.2 数据库连接失败

**问题**：日志中显示数据库连接错误

**解决**：
- 检查 MySQL 服务是否运行
- 检查用户名密码是否正确
- 检查防火墙规则
- 检查 MySQL 用户权限

### 9.3 性能问题

**问题**：响应慢或 QPS 低

**解决**：
- 检查数据库连接池配置
- 检查缓存是否生效
- 检查系统资源使用情况
- 优化数据库索引

### 9.4 日志未写入

**问题**：访问日志未写入数据库

**解决**：
- 检查 `log_by_lua` 是否配置
- 检查日志缓冲区大小
- 检查数据库表结构
- 查看错误日志

## 十、升级和维护

### 10.1 升级步骤

```bash
# 1. 备份配置和数据
cp -r /usr/local/openresty/nginx/conf /backup/nginx-conf-$(date +%Y%m%d)
mysqldump -u waf_user -p waf_db > /backup/waf_db-$(date +%Y%m%d).sql

# 2. 停止服务
sudo systemctl stop openresty

# 3. 更新代码
# 复制新的 Lua 文件

# 4. 测试配置
sudo /usr/local/openresty/bin/openresty -t

# 5. 启动服务
sudo systemctl start openresty
```

### 10.2 数据备份

```bash
# 每日备份脚本
#!/bin/bash
BACKUP_DIR="/backup/waf"
DATE=$(date +%Y%m%d)

mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u waf_user -p'password' waf_db | gzip > $BACKUP_DIR/waf_db_$DATE.sql.gz

# 删除 30 天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete
```

### 10.3 日志归档

```bash
# 归档 90 天前的日志
mysql -u waf_user -p waf_db << EOF
CREATE TABLE IF NOT EXISTS waf_access_logs_archive LIKE waf_access_logs;
INSERT INTO waf_access_logs_archive SELECT * FROM waf_access_logs 
WHERE request_time < DATE_SUB(NOW(), INTERVAL 90 DAY);
DELETE FROM waf_access_logs WHERE request_time < DATE_SUB(NOW(), INTERVAL 90 DAY);
EOF
```

## 十一、安全建议

### 11.1 数据库安全

- 使用强密码
- 限制数据库用户权限
- 启用 SSL 连接（生产环境）
- 定期更新 MySQL

### 11.2 系统安全

- 定期更新系统补丁
- 配置防火墙规则
- 限制 SSH 访问
- 使用非 root 用户运行服务

### 11.3 应用安全

- 管理接口需要认证
- 限制管理接口访问 IP
- 使用 HTTPS（生产环境）
- 定期审查封控规则

## 十二、故障排查

### 12.1 查看日志

```bash
# OpenResty 错误日志（项目目录）
tail -f /path/to/project/logs/error.log

# OpenResty 访问日志（项目目录）
tail -f /path/to/project/logs/access.log

# MySQL 错误日志
tail -f /var/log/mysqld.log  # CentOS
tail -f /var/log/mysql/error.log  # Ubuntu
```

### 12.2 性能分析

```bash
# 查看进程状态
top -p $(pgrep -f "nginx: worker")

# 查看连接数
netstat -an | grep :80 | wc -l

# 查看数据库连接
mysql -u waf_user -p -e "SHOW PROCESSLIST;"
```

### 12.3 调试模式

在项目目录的 `init_file/nginx.conf` 中启用调试日志（编辑后重新部署）：

```nginx
error_log logs/error.log debug;
```

## 十三、生产环境检查清单

- [ ] 数据库密码已修改为强密码
- [ ] 配置文件中的敏感信息已更新
- [ ] 防火墙规则已配置
- [ ] 日志轮转已配置
- [ ] 监控告警已配置
- [ ] 数据备份已配置
- [ ] SSL 证书已配置（如使用 HTTPS）
- [ ] 性能参数已优化
- [ ] 安全加固已完成
- [ ] 文档已完善

