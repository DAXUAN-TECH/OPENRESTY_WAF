# OpenResty + MySQL IP 采集与封控系统 - 需求文档

## 一、项目概述

### 1.1 项目背景
构建基于 OpenResty 和 MySQL 的 Web 应用防火墙（WAF）系统，实现 IP 访问日志采集和智能封控功能。

### 1.2 项目目标
- ✅ 实时采集客户端 IP、请求路径、响应状态码
- ✅ 支持灵活的 IP 封控策略（单个 IP、IP 段、地域）
- ✅ 提供Web管理界面和API接口进行规则配置和查询
- ✅ 保证高并发下的系统性能和稳定性
- ✅ 支持用户认证和权限管理
- ✅ 支持功能开关动态控制
- ✅ 支持反向代理管理
- ✅ 支持统计报表和监控面板

## 二、功能需求

### 2.1 IP 采集功能（FR-001）

#### 2.1.1 采集内容
- **客户端 IP**：真实客户端 IP 地址（处理代理情况）
- **请求路径**：完整的 URI 路径（包含查询参数）
- **响应状态码**：HTTP 响应状态码（200, 404, 500 等）
- **请求时间**：请求发生的时间戳
- **请求方法**：GET、POST、PUT、DELETE 等
- **User-Agent**：客户端浏览器标识（可选）
- **Referer**：来源页面（可选）

#### 2.1.2 性能要求
- 日志采集不阻塞正常请求处理
- 支持异步批量写入，提高性能
- 单机支持 10,000+ QPS 的日志采集

#### 2.1.3 数据存储
- 存储到 MySQL 数据库
- 支持数据查询和统计分析
- 支持历史数据归档

### 2.2 IP 封控功能（FR-002）

#### 2.2.1 封控类型

**2.2.1.1 单个 IP 封控**
- 支持精确匹配单个 IP 地址
- 支持 IPv4 和 IPv6
- 支持临时封控和永久封控
- 支持封控原因记录

**2.2.1.2 IP 段封控**
- 支持 CIDR 格式（如：192.168.1.0/24）
- 支持 IP 范围（如：192.168.1.1-192.168.1.100）
- 支持多个 IP 段批量配置
- 支持 IP 段优先级设置

**2.2.1.3 地域封控**
- 支持按国家/地区封控
- 支持按省份/城市封控（可选）
- 基于 IP 地理位置数据库
- 支持白名单地域（允许特定地域）

#### 2.2.2 封控策略
- **立即生效**：规则配置后立即生效
- **定时生效**：支持设置封控开始和结束时间
- **条件封控**：基于访问频率、错误率等条件自动封控
- **白名单优先**：白名单 IP 不受封控规则影响

#### 2.2.3 封控响应
- 返回 HTTP 403 Forbidden
- 可自定义封控页面内容
- 记录封控日志

### 2.3 规则管理功能（FR-003）

#### 2.3.1 规则配置
- 添加、修改、删除封控规则
- 启用/禁用规则
- 规则优先级设置
- 规则生效时间设置

#### 2.3.2 规则查询
- 查询所有封控规则
- 按 IP、IP 段、地域查询
- 查询规则生效状态
- 查询规则命中统计

#### 2.3.3 白名单管理
- IP 白名单管理
- IP 段白名单管理
- 白名单优先级最高

### 2.4 日志查询功能（FR-004）

#### 2.4.1 基础查询
- 按 IP 地址查询访问记录
- 按时间范围查询
- 按请求路径查询
- 按状态码查询

#### 2.4.2 统计分析
- IP 访问频率统计
- 路径访问统计
- 状态码分布统计
- 地域访问分布

#### 2.4.3 异常检测
- 高频访问 IP 识别
- 异常路径访问识别
- 错误率异常识别

## 三、非功能需求

### 3.1 性能需求
- **响应时间**：封控检查延迟 < 1ms（缓存命中）
- **吞吐量**：单机支持 10,000+ QPS
- **日志写入**：异步写入，不阻塞请求
- **数据库查询**：复杂查询响应时间 < 100ms

### 3.2 可用性需求
- **系统可用性**：99.9%（年停机时间 < 8.76 小时）
- **故障恢复**：支持快速故障切换
- **数据备份**：每日自动备份

### 3.3 安全性需求
- **数据加密**：敏感数据传输加密
- **访问控制**：管理接口需要认证
- **审计日志**：记录所有规则变更操作

### 3.4 可维护性需求
- **日志记录**：详细的运行日志和错误日志
- **监控告警**：系统指标监控和异常告警
- **配置管理**：支持配置文件热更新

## 四、数据需求

### 4.1 访问日志表（waf_access_logs）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键，自增 |
| client_ip | VARCHAR(45) | 客户端 IP（支持 IPv6） |
| request_path | VARCHAR(512) | 请求路径 |
| request_method | VARCHAR(10) | 请求方法 |
| status_code | INT | 响应状态码 |
| user_agent | VARCHAR(512) | User-Agent |
| referer | VARCHAR(512) | Referer |
| request_time | DATETIME | 请求时间 |
| response_time | INT | 响应时间（毫秒） |
| created_at | TIMESTAMP | 创建时间 |

### 4.2 封控规则表（waf_block_rules）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键，自增 |
| rule_type | VARCHAR(20) | 规则类型（single_ip/ip_range/geo） |
| rule_value | VARCHAR(255) | 规则值（IP/CIDR/地域代码） |
| rule_name | VARCHAR(100) | 规则名称 |
| description | TEXT | 规则描述 |
| status | TINYINT | 状态（1-启用，0-禁用） |
| priority | INT | 优先级（数字越大优先级越高） |
| start_time | DATETIME | 生效开始时间 |
| end_time | DATETIME | 生效结束时间 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

### 4.3 白名单表（waf_whitelist）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键，自增 |
| ip_type | VARCHAR(20) | 类型（single_ip/ip_range） |
| ip_value | VARCHAR(255) | IP 值 |
| description | TEXT | 说明 |
| status | TINYINT | 状态（1-启用，0-禁用） |
| created_at | TIMESTAMP | 创建时间 |

### 4.4 封控日志表（waf_block_logs）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键，自增 |
| client_ip | VARCHAR(45) | 被封控的 IP |
| rule_id | BIGINT | 匹配的规则 ID |
| block_time | DATETIME | 封控时间 |
| request_path | VARCHAR(512) | 请求路径 |

## 五、接口需求

### 5.1 规则管理接口
- `POST /api/rules` - 创建封控规则
- `GET /api/rules` - 查询规则列表
- `GET /api/rules/:id` - 查询规则详情
- `PUT /api/rules/:id` - 更新规则
- `DELETE /api/rules/:id` - 删除规则
- `POST /api/rules/:id/enable` - 启用规则
- `POST /api/rules/:id/disable` - 禁用规则

### 5.2 白名单接口
- `POST /api/whitelist` - 添加白名单
- `GET /api/whitelist` - 查询白名单列表
- `DELETE /api/whitelist/:id` - 删除白名单

### 5.3 日志查询接口
- `GET /api/logs` - 查询访问日志
- `GET /api/logs/stats` - 访问统计
- `GET /api/logs/block` - 查询封控日志

## 六、约束条件

### 6.1 技术约束
- 必须使用 OpenResty 作为 Web 服务器
- 必须使用 MySQL 作为数据存储
- **操作系统支持**（脚本自动检测）：
  - **RedHat 系列**：CentOS、RHEL、Fedora、Rocky Linux、AlmaLinux、Oracle Linux、Amazon Linux
  - **Debian 系列**：Debian、Ubuntu、Linux Mint、Kali Linux、Raspbian
  - **SUSE 系列**：openSUSE、SLES
  - **Arch 系列**：Arch Linux、Manjaro
  - **其他**：Alpine Linux、Gentoo
- **路径配置**：所有脚本支持通过环境变量 `OPENRESTY_PREFIX` 配置安装路径，无硬编码绝对路径

### 6.2 业务约束
- 白名单优先级最高，不受任何封控规则影响
- 规则更新后需要在 60 秒内生效
- 历史日志保留 90 天

## 七、验收标准

### 7.1 功能验收
- ✅ 能够正确采集 IP、路径、状态码
- ✅ 单个 IP 封控功能正常
- ✅ IP 段封控功能正常
- ✅ 地域封控功能正常
- ✅ 白名单功能正常
- ✅ 规则管理功能正常

### 7.2 性能验收
- ✅ 单机 QPS > 10,000
- ✅ 封控检查延迟 < 1ms（缓存命中）
- ✅ 日志写入不阻塞请求

### 7.3 稳定性验收
- ✅ 7×24 小时稳定运行
- ✅ 规则更新不影响服务
- ✅ 数据库故障不影响基础功能（降级模式）

