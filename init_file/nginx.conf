# OpenResty WAF 主配置文件
# 注意：此文件会被复制到 /usr/local/openresty/nginx/conf/nginx.conf
# 所有路径使用 $project_root 变量，部署脚本会自动设置项目根目录
# 注意：error_log 和 pid 不支持变量，部署脚本会自动替换为绝对路径

user  nobody;
worker_processes  auto;

# 错误日志和 PID 文件路径（部署脚本会自动替换为项目目录的绝对路径）
error_log  /path/to/project/logs/error.log warn;
pid        /path/to/project/logs/nginx.pid;

events {
    # 每个 worker 进程的最大连接数
    # 理论最大并发 = worker_processes × worker_connections
    # 例如：8 workers × 65535 = 524,280 并发连接
    worker_connections  65535;
    
    # 使用 epoll 事件模型（Linux 系统，性能最佳）
    use epoll;
    
    # 允许 worker 进程同时接受多个新连接
    multi_accept on;
    
    # 接受连接后，尽可能多地接受新连接
    accept_mutex off;  # 在高并发场景下关闭互斥锁，减少延迟
}

http {
    # 项目根目录变量（部署脚本会自动替换为实际项目路径）
    # 注意：此变量必须在 http 块的最开始设置，以便后续配置使用
    set $project_root "/path/to/project";
    
    # 包含参数配置（指向项目目录的 conf.d/set_conf）
    include $project_root/conf.d/set_conf/*.conf; 
    
    # 包含服务器配置（指向项目目录的 conf.d/vhost_conf）
    include $project_root/conf.d/vhost_conf/*.conf;
}
