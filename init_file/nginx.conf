# OpenResty WAF 主配置文件
# 注意：此文件会被复制到 /usr/local/openresty/nginx/conf/nginx.conf
# 所有路径使用 $project_root 变量，部署脚本会自动设置项目根目录
# 注意：error_log 不支持变量，部署脚本会自动替换为绝对路径
# 注意：pid 路径固定为 /usr/local/openresty/nginx/logs/nginx.pid，不会被替换

user  nobody;
worker_processes  auto;

# 错误日志路径（部署脚本会自动替换为项目目录的绝对路径）
error_log  /path/to/project/logs/error.log warn;
# PID 文件路径（固定路径，必须与 systemd 服务文件 openresty.service 中的 PIDFile 一致）
# 注意：此路径不能被修改，否则 systemd 服务无法正确管理进程
pid        /usr/local/openresty/nginx/logs/nginx.pid;

events {
    # 每个 worker 进程的最大连接数
    # 理论最大并发 = worker_processes × worker_connections
    # 例如：8 workers × 65535 = 524,280 并发连接
    worker_connections  65535;
    
    # 使用 epoll 事件模型（Linux 系统，性能最佳）
    use epoll;
    
    # 允许 worker 进程同时接受多个新连接
    multi_accept on;
    
    # 接受连接后，尽可能多地接受新连接
    accept_mutex off;  # 在高并发场景下关闭互斥锁，减少延迟
}

http {
    
    # 包含参数配置（指向项目目录的 conf.d/set_conf）
    include /path/to/project/conf.d/set_conf/*.conf; 
    
    # 包含自动生成的upstream配置（每个upstream一个文件）
    # 注意：这些文件由系统自动生成，命名格式：upstream_{id}.conf
    # 如果没有任何upstream配置，此include不会报错（nginx会忽略不存在的通配符匹配）
    include /path/to/project/conf.d/upstream/upstream_*.conf;
    
    # 包含服务器配置（指向项目目录的 conf.d/vhost_conf）
    include /path/to/project/conf.d/vhost_conf/*.conf;
    
    # 包含自动生成的HTTP代理配置（每个代理一个文件）
    # 注意：这些文件由系统自动生成，命名格式：proxy_http_{id}.conf
    # 如果没有任何代理配置，此include不会报错（nginx会忽略不存在的通配符匹配）
    include /path/to/project/conf.d/vhost_conf/proxy_http_*.conf;
}

# ============================================
# Stream块（用于TCP/UDP代理）
# 注意：需要nginx stream模块支持
# ============================================
stream {
    # 包含自动生成的stream upstream配置（每个upstream一个文件）
    # 注意：这些文件由系统自动生成，命名格式：stream_upstream_{id}.conf
    # 如果没有任何upstream配置，此include不会报错（nginx会忽略不存在的通配符匹配）
    include /path/to/project/conf.d/upstream/stream_upstream_*.conf;
    
    # 包含自动生成的TCP/UDP代理配置（每个代理一个文件）
    # 注意：这些文件由系统自动生成，命名格式：proxy_stream_{id}.conf
    # 如果没有任何代理配置，此include不会报错（nginx会忽略不存在的通配符匹配）
    include /path/to/project/conf.d/vhost_conf/proxy_stream_*.conf;
}
