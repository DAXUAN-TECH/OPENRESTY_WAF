<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<style>
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .metric-card {
        background: #fff;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.3s, box-shadow 0.3s;
    }
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .metric-card h3 {
        font-size: 14px;
        color: #666;
        margin-bottom: 15px;
        font-weight: 500;
    }
    .metric-card .value {
        font-size: 36px;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 10px;
    }
    .metric-card .status {
        margin-top: 10px;
        padding: 6px 12px;
        border-radius: 4px;
        display: inline-block;
        font-size: 12px;
        font-weight: 500;
    }
    .status.healthy {
        background: #d4edda;
        color: #155724;
    }
    .status.unhealthy {
        background: #f8d7da;
        color: #721c24;
    }
    .status.warning {
        background: #fff3cd;
        color: #856404;
    }
    .chart-container {
        background: #fff;
        padding: 25px;
        margin-bottom: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .chart-container h2 {
        font-size: 18px;
        margin-bottom: 20px;
        color: #2c3e50;
        font-weight: 600;
    }
    .info-section {
        background: #fff;
        padding: 25px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .info-section h2 {
        font-size: 18px;
        margin-bottom: 20px;
        color: #2c3e50;
        font-weight: 600;
    }
    .info-item {
        padding: 12px 0;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .info-item:last-child {
        border-bottom: none;
    }
    .info-label {
        font-weight: 500;
        color: #666;
    }
    .info-value {
        color: #2c3e50;
        font-weight: 500;
    }
    .auto-refresh {
        text-align: right;
        margin-bottom: 20px;
        padding: 15px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .auto-refresh label {
        margin-right: 10px;
        color: #666;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 8px;
    }
    .auto-refresh input[type="checkbox"] {
        cursor: pointer;
    }
    .loading {
        text-align: center;
        padding: 60px;
        color: #666;
        font-size: 16px;
    }
    .metric-trend {
        font-size: 12px;
        color: #999;
        margin-top: 5px;
    }
    .metric-trend.up {
        color: #27ae60;
    }
    .metric-trend.down {
        color: #e74c3c;
    }
</style>

<div class="auto-refresh">
    <label>
        <input type="checkbox" id="autoRefresh" checked> 自动刷新（30秒）
    </label>
</div>

<div id="loading" class="loading">加载中...</div>

<div id="content" style="display:none;">
    <div class="metrics-grid">
        <div class="metric-card">
            <h3>数据库健康状态</h3>
            <div class="value" id="dbHealth">-</div>
            <span class="status" id="dbStatus">检查中</span>
        </div>
        <div class="metric-card">
            <h3>总封控次数</h3>
            <div class="value" id="totalBlocks">0</div>
            <div class="metric-trend" id="blocksTrend"></div>
        </div>
        <div class="metric-card">
            <h3>缓存命中率</h3>
            <div class="value" id="cacheHitRate">0%</div>
            <div class="metric-trend" id="cacheTrend"></div>
        </div>
        <div class="metric-card">
            <h3>当前被封控IP数</h3>
            <div class="value" id="blockedIPs">0</div>
            <div class="metric-trend" id="ipsTrend"></div>
        </div>
        <div class="metric-card">
            <h3>规则匹配耗时</h3>
            <div class="value" id="matchDuration">0ms</div>
            <div class="metric-trend" id="durationTrend"></div>
        </div>
        <div class="metric-card">
            <h3>降级模式</h3>
            <div class="value" id="fallbackMode">-</div>
            <span class="status" id="fallbackStatus">检查中</span>
        </div>
        <div class="metric-card">
            <h3>自动封控次数</h3>
            <div class="value" id="autoBlocks">0</div>
            <div class="metric-trend" id="autoBlocksTrend"></div>
        </div>
        <div class="metric-card">
            <h3>缓存命中次数</h3>
            <div class="value" id="cacheHits">0</div>
            <div class="metric-trend" id="cacheHitsTrend"></div>
        </div>
    </div>
    
    <div class="chart-container">
        <h2>封控趋势（最近1小时）</h2>
        <canvas id="blockTrendChart"></canvas>
    </div>
    
    <div class="info-section">
        <h2>系统信息</h2>
        <div class="info-item">
            <span class="info-label">当前时间</span>
            <span class="info-value" id="currentTime">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">数据库连接状态</span>
            <span class="info-value" id="dbConnection">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">缓存状态</span>
            <span class="info-value" id="cacheStatus">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">自动封控状态</span>
            <span class="info-value" id="autoBlockStatus">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">系统运行时间</span>
            <span class="info-value" id="uptime">-</span>
        </div>
    </div>
</div>

<script>
    let blockTrendChart = null;
    let refreshInterval = null;
    let previousMetrics = {};
    
    // 加载监控数据
    async function loadMetrics() {
        try {
            // 获取Prometheus指标
            const metricsRes = await fetch('/metrics');
            const metricsText = await metricsRes.text();
            
            // 解析Prometheus格式的指标
            const metrics = parsePrometheusMetrics(metricsText);
            
            // 更新指标卡片
            updateMetrics(metrics);
            
            // 更新图表
            updateBlockTrendChart(metrics);
            
            // 更新系统信息
            updateSystemInfo(metrics);
            
            // 保存当前指标用于趋势计算
            previousMetrics = metrics;
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        } catch (error) {
            console.error('加载监控数据失败：', error);
            document.getElementById('loading').textContent = '加载失败，请刷新页面重试';
        }
    }
    
    // 解析Prometheus格式的指标
    function parsePrometheusMetrics(text) {
        const metrics = {};
        const lines = text.split('\n');
        
        for (const line of lines) {
            if (line.startsWith('#') || !line.trim()) continue;
            
            // 匹配指标名称和值
            const match = line.match(/^(\w+)\s+([\d.]+)$/);
            if (match) {
                const [, name, value] = match;
                metrics[name] = parseFloat(value);
            }
        }
        
        return metrics;
    }
    
    // 更新指标卡片
    function updateMetrics(metrics) {
        // 数据库健康状态
        const dbHealth = metrics.waf_database_health || 0;
        document.getElementById('dbHealth').textContent = dbHealth === 1 ? '健康' : '异常';
        const dbStatusEl = document.getElementById('dbStatus');
        dbStatusEl.textContent = dbHealth === 1 ? '健康' : '异常';
        dbStatusEl.className = 'status ' + (dbHealth === 1 ? 'healthy' : 'unhealthy');
        
        // 总封控次数
        const totalBlocks = Math.floor(metrics.waf_blocks_total || 0);
        document.getElementById('totalBlocks').textContent = totalBlocks;
        updateTrend('blocksTrend', totalBlocks, previousMetrics.waf_blocks_total || 0);
        
        // 缓存命中率
        const hitRate = (metrics.waf_cache_hit_rate || 0) * 100;
        document.getElementById('cacheHitRate').textContent = hitRate.toFixed(2) + '%';
        const prevHitRate = (previousMetrics.waf_cache_hit_rate || 0) * 100;
        updateTrend('cacheTrend', hitRate, prevHitRate, '%');
        
        // 当前被封控IP数
        const blockedIPs = Math.floor(metrics.waf_blocked_ips || 0);
        document.getElementById('blockedIPs').textContent = blockedIPs;
        updateTrend('ipsTrend', blockedIPs, previousMetrics.waf_blocked_ips || 0);
        
        // 规则匹配耗时
        const duration = (metrics.waf_rule_match_duration_seconds || 0) * 1000;
        document.getElementById('matchDuration').textContent = duration.toFixed(2) + 'ms';
        const prevDuration = (previousMetrics.waf_rule_match_duration_seconds || 0) * 1000;
        updateTrend('durationTrend', duration, prevDuration, 'ms');
        
        // 降级模式
        const fallback = metrics.waf_fallback_enabled || 0;
        document.getElementById('fallbackMode').textContent = fallback === 1 ? '已启用' : '未启用';
        const fallbackStatusEl = document.getElementById('fallbackStatus');
        fallbackStatusEl.textContent = fallback === 1 ? '已启用' : '未启用';
        fallbackStatusEl.className = 'status ' + (fallback === 1 ? 'warning' : 'healthy');
        
        // 自动封控次数
        const autoBlocks = Math.floor(metrics.waf_auto_blocks_total || 0);
        document.getElementById('autoBlocks').textContent = autoBlocks;
        updateTrend('autoBlocksTrend', autoBlocks, previousMetrics.waf_auto_blocks_total || 0);
        
        // 缓存命中次数
        const cacheHits = Math.floor(metrics.waf_cache_hits_total || 0);
        document.getElementById('cacheHits').textContent = cacheHits;
        updateTrend('cacheHitsTrend', cacheHits, previousMetrics.waf_cache_hits_total || 0);
    }
    
    // 更新趋势指示
    function updateTrend(elementId, current, previous, unit = '') {
        const trendEl = document.getElementById(elementId);
        if (!trendEl) return;
        
        if (previous === 0 || previous === undefined) {
            trendEl.textContent = '';
            trendEl.className = 'metric-trend';
            return;
        }
        
        const diff = current - previous;
        const percent = ((diff / previous) * 100).toFixed(1);
        
        if (diff > 0) {
            trendEl.textContent = `↑ +${diff}${unit} (+${percent}%)`;
            trendEl.className = 'metric-trend up';
        } else if (diff < 0) {
            trendEl.textContent = `↓ ${diff}${unit} (${percent}%)`;
            trendEl.className = 'metric-trend down';
        } else {
            trendEl.textContent = `→ 无变化`;
            trendEl.className = 'metric-trend';
        }
    }
    
    // 更新封控趋势图表
    function updateBlockTrendChart(metrics) {
        const ctx = document.getElementById('blockTrendChart').getContext('2d');
        
        if (blockTrendChart) {
            blockTrendChart.destroy();
        }
        
        // 生成示例数据（实际应该从API获取时间序列数据）
        const labels = [];
        const data = [];
        const now = new Date();
        for (let i = 11; i >= 0; i--) {
            const time = new Date(now.getTime() - i * 5 * 60 * 1000);
            labels.push(time.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }));
            // 使用实际指标数据，如果没有则使用随机数
            data.push(Math.floor((metrics.waf_blocks_total || 0) / 12) + Math.floor(Math.random() * 10));
        }
        
        blockTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '封控次数',
                    data: data,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });
    }
    
    // 更新系统信息
    function updateSystemInfo(metrics) {
        document.getElementById('currentTime').textContent = new Date().toLocaleString('zh-CN');
        document.getElementById('dbConnection').textContent = (metrics.waf_database_health || 0) === 1 ? '已连接' : '未连接';
        document.getElementById('cacheStatus').textContent = '正常';
        document.getElementById('autoBlockStatus').textContent = (metrics.waf_auto_blocks_total || 0) > 0 ? '已启用' : '未启用';
        // 系统运行时间（简化处理）
        document.getElementById('uptime').textContent = '运行中';
    }
    
    // 设置自动刷新
    function setupAutoRefresh() {
        const checkbox = document.getElementById('autoRefresh');
        
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                refreshInterval = setInterval(loadMetrics, 30000);
            } else {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
            }
        });
        
        if (checkbox.checked) {
            refreshInterval = setInterval(loadMetrics, 30000);
        }
    }
    
    // 页面加载时初始化
    window.addEventListener('DOMContentLoaded', function() {
        loadMetrics();
        setupAutoRefresh();
    });
</script>

