<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日志查看 - WAF管理</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* 强制覆盖所有可能的样式冲突 - 确保content-area子元素的宽度正确 */
        /* 这个样式必须在最前面，确保优先级最高 */
        .content-area .container,
        .content-area .tab-content,
        .content-area .table-container,
        .content-area .table-wrapper,
        .content-area table {
            box-sizing: border-box !important;
            width: 100% !important;
            min-width: 100% !important;
            max-width: 100% !important;
        }
        
        /* 统一容器样式 */
        /* 注意：padding会影响内部元素宽度，需要确保table-container等子元素宽度计算正确 */
        /* 层级：content-area (padding: 30px) -> container (padding: 30px) -> tab-content -> table-container -> table-wrapper -> table */
        .container {
            width: 100% !important;
            min-width: 100% !important;
            max-width: 100% !important;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
            box-sizing: border-box;
            /* 移除overflow-x: auto，避免影响表格对齐 */
            overflow-x: visible;
            /* 确保子元素继承box-sizing */
            * {
                box-sizing: border-box;
            }
            /* 确保子元素能够正确使用100%宽度 */
            position: relative;
        }
        
        /* 标题样式 */
        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 30px;
            font-weight: 600;
        }
        
        .tabs {
            background: #fff;
            padding: 0;
            margin-bottom: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }
        .tab:hover {
            color: #0066cc;
        }
        .tab.active {
            color: #0066cc;
            border-bottom-color: #0066cc;
            font-weight: 500;
        }
        .tab-content {
            display: none;
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box;
            /* 确保没有浮动或其他布局影响 */
            position: relative;
            clear: both;
        }
        .tab-content.active {
            display: block;
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box;
            /* 确保没有浮动或其他布局影响 */
            position: relative;
            clear: both;
        }
        .filters {
            background: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box;
        }
        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        /* 访问日志：使用Grid布局确保对齐 */
        #access-tab .filters-row:first-child {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        #access-tab .filters-row:nth-child(2) {
            display: grid;
            /* 第一列宽度与第一行第一列相同，第二列宽度与第一行第二列相同 */
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        /* 访问日志：开始时间和客户端IP保持一样宽度 */
        /* 通过Grid的列宽自动对齐，第一行第一列和第二行第一列宽度相同 */
        
        /* 封控日志：使用Grid布局确保对齐 */
        #block-tab .filters-row:first-child {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        #block-tab .filters-row:nth-child(2) {
            display: grid;
            /* 第一列宽度与第一行第一列相同，第二列宽度与第一行第二列相同 */
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        /* 封控日志：开始时间和客户端IP保持一样宽度 */
        /* 通过Grid的列宽自动对齐，第一行第一列和第二行第一列宽度相同 */
        
        /* 审计日志：使用Grid布局确保对齐 */
        #audit-tab .filters-row:first-child {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        #audit-tab .filters-row:nth-child(2) {
            display: grid;
            /* 第一列宽度与第一行第一列相同，第二列宽度与第一行第二列相同 */
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        /* 审计日志：开始时间和用户名保持一样宽度 */
        /* 通过Grid的列宽自动对齐，第一行第一列和第二行第一列宽度相同 */
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
            color: #666;
        }
        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .btn-primary {
            background: #0066cc;
            color: #fff;
        }
        .btn-primary:hover {
            background: #0052a3;
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #fff;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }
        /* 表格容器样式 - 确保表格和table-wrapper左右对齐 */
        /* 逐级检查：.content-area (padding: 30px) -> .container (padding: 30px) -> .tab-content -> .table-container -> .table-wrapper -> table */
        /* 注意：.filters 有 padding: 20px，.table-container 有 padding: 0，为了对齐，需要确保它们的内容区域宽度一致 */
        .table-container {
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            min-width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box;
            /* 确保与父级对齐 */
            display: block;
            position: relative;
            /* 确保与.filters对齐：.filters的内容区域 = 100% - 40px (左右各20px padding) */
            /* 但为了表格能够完全展开，table-container保持padding: 0，表格本身使用100%宽度 */
        }
        
        /* 表格包装器 - 确保与表格左右对齐 */
        .table-wrapper {
            overflow-x: auto;
            width: 100% !important;
            min-width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box;
            /* 确保与表格对齐 */
            display: block;
            /* 确保没有额外的边框或间距影响对齐 */
            border: none;
            /* 确保没有负边距影响对齐 */
            position: relative;
        }
        
        /* 基础表格样式 - 确保与table-wrapper对齐 */
        table {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
            border-collapse: collapse;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box;
            /* 确保表格与wrapper对齐 */
            display: table;
            table-layout: fixed !important; /* 固定表格布局，确保宽度为100% */
            /* 确保没有额外的边框或间距影响对齐 */
            border-spacing: 0;
            /* 确保表格不会因为内容而缩小 */
            position: relative;
        }
        
        /* 访问日志：access-table和table-wrapper保持一样的宽度，确保左右对齐 */
        #access-tab {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box;
            position: relative;
            clear: both;
        }
        #access-tab .table-container {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box;
            display: block;
            position: relative;
            clear: both;
        }
        #access-tab .table-wrapper {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box;
            display: block;
            border: none;
            position: relative;
        }
        #access-table {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box;
            display: table;
            table-layout: fixed !important; /* 固定表格布局，确保宽度为100% */
            border-spacing: 0;
            position: relative;
        }
        
        /* 封控日志：block-table和table-wrapper保持一样的宽度，确保左右对齐 */
        #block-tab {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box;
            position: relative;
            clear: both;
        }
        #block-tab .table-container {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box;
            display: block;
            position: relative;
            clear: both;
        }
        #block-tab .table-wrapper {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box;
            display: block;
            border: none;
            position: relative;
        }
        #block-table {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box;
            display: table;
            table-layout: fixed !important; /* 固定表格布局，确保宽度为100% */
            border-spacing: 0;
            position: relative;
        }
        
        /* 审计日志：audit-table和table-wrapper保持一样的宽度，确保左右对齐 */
        #audit-tab {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box;
            position: relative;
            clear: both;
        }
        #audit-tab .table-container {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box;
            display: block;
            position: relative;
            clear: both;
        }
        #audit-tab .table-wrapper {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box;
            display: block;
            border: none;
            position: relative;
        }
        #audit-table {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box;
            display: table;
            table-layout: fixed !important; /* 固定表格布局，确保宽度为100% */
            border-spacing: 0;
            position: relative;
        }
        thead {
            background: #f8f9fa;
        }
        th {
            padding: 12px;
            text-align: center;
            font-weight: 500;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid #e0e0e0;
        }
        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            text-align: center;
        }
        tbody tr:hover {
            background: #f8f9fa;
        }
        .pagination {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            border-top: 1px solid #e0e0e0;
        }
        .pagination-info {
            color: #666;
            font-size: 14px;
        }
        .pagination-controls {
            display: flex;
            gap: 10px;
        }
        .pagination-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .pagination-btn:hover:not(:disabled) {
            background: #f0f0f0;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0; /* 只设置上下margin，避免影响左右对齐 */
        }
        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .status-code {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-weight: 500;
            font-size: 12px;
        }
        .status-2xx { background: #d4edda; color: #155724; }
        .status-3xx { background: #d1ecf1; color: #0c5460; }
        .status-4xx { background: #fff3cd; color: #856404; }
        .status-5xx { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>日志查看</h1>
        <div class="tabs">
            <button class="tab active" data-tab="access">访问日志</button>
            <button class="tab" data-tab="block">封控日志</button>
            <button class="tab" data-tab="audit">审计日志</button>
        </div>
        
        <!-- 访问日志 -->
        <div class="tab-content active" id="access-tab">
            <div class="filters">
                <div class="filters-row">
                    <div class="filter-group">
                        <label>客户端IP</label>
                        <input type="text" id="access-client-ip" placeholder="192.168.1.1">
                    </div>
                    <div class="filter-group">
                        <label>请求域名</label>
                        <input type="text" id="access-domain" placeholder="example.com">
                    </div>
                    <div class="filter-group">
                        <label>请求路径</label>
                        <input type="text" id="access-path" placeholder="/api/">
                    </div>
                    <div class="filter-group">
                        <label>状态码</label>
                        <input type="text" id="access-status" placeholder="200">
                    </div>
                </div>
                <div class="filters-row">
                    <div class="filter-group">
                        <label>开始时间</label>
                        <input type="datetime-local" id="access-start-time">
                    </div>
                    <div class="filter-group">
                        <label>结束时间</label>
                        <input type="datetime-local" id="access-end-time">
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-primary" onclick="loadAccessLogs()">查询</button>
                    <button class="btn btn-secondary" onclick="resetAccessFilters()">重置</button>
                </div>
            </div>
            
            <div id="access-loading" class="loading" style="display: none;">加载中...</div>
            <div id="access-error" class="error" style="display: none;"></div>
            <div class="table-container">
                <div class="table-wrapper">
                    <table id="access-table">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>IP地址</th>
                                <th>域名</th>
                                <th>请求路径</th>
                                <th>方法</th>
                                <th>状态码</th>
                                <th>响应时间</th>
                                <th>User-Agent</th>
                            </tr>
                        </thead>
                        <tbody id="access-tbody"></tbody>
                    </table>
                </div>
                <div class="pagination" id="access-pagination"></div>
            </div>
        </div>
        
        <!-- 封控日志 -->
        <div class="tab-content" id="block-tab">
            <div class="filters">
                <div class="filters-row">
                    <div class="filter-group">
                        <label>客户端IP</label>
                        <input type="text" id="block-client-ip" placeholder="192.168.1.1">
                    </div>
                    <div class="filter-group">
                        <label>封控原因</label>
                        <select id="block-reason">
                            <option value="">全部</option>
                            <option value="manual">手动封控</option>
                            <option value="auto_frequency">自动频率封控</option>
                            <option value="auto_error">自动错误率封控</option>
                            <option value="auto_scan">自动扫描封控</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>规则名称</label>
                        <input type="text" id="block-rule-name" placeholder="规则名称">
                    </div>
                </div>
                <div class="filters-row">
                    <div class="filter-group">
                        <label>开始时间</label>
                        <input type="datetime-local" id="block-start-time">
                    </div>
                    <div class="filter-group">
                        <label>结束时间</label>
                        <input type="datetime-local" id="block-end-time">
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-primary" onclick="loadBlockLogs()">查询</button>
                    <button class="btn btn-secondary" onclick="resetBlockFilters()">重置</button>
                </div>
            </div>
            
            <div id="block-loading" class="loading" style="display: none;">加载中...</div>
            <div id="block-error" class="error" style="display: none;"></div>
            <div class="table-container">
                <div class="table-wrapper">
                    <table id="block-table">
                        <thead>
                            <tr>
                                <th>封控时间</th>
                                <th>IP地址</th>
                                <th>规则名称</th>
                                <th>封控原因</th>
                                <th>请求路径</th>
                                <th>User-Agent</th>
                            </tr>
                        </thead>
                        <tbody id="block-tbody"></tbody>
                    </table>
                </div>
                <div class="pagination" id="block-pagination"></div>
            </div>
        </div>
        
        <!-- 审计日志 -->
        <div class="tab-content" id="audit-tab">
            <div class="filters">
                <div class="filters-row">
                    <div class="filter-group">
                        <label>用户名</label>
                        <input type="text" id="audit-username" placeholder="admin">
                    </div>
                    <div class="filter-group">
                        <label>操作类型</label>
                        <select id="audit-action-type">
                            <option value="">全部</option>
                            <option value="login">登录</option>
                            <option value="logout">登出</option>
                            <option value="create">创建</option>
                            <option value="update">更新</option>
                            <option value="delete">删除</option>
                            <option value="enable">启用</option>
                            <option value="disable">禁用</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>资源类型</label>
                        <input type="text" id="audit-resource-type" placeholder="rule">
                    </div>
                    <div class="filter-group">
                        <label>状态</label>
                        <select id="audit-status">
                            <option value="">全部</option>
                            <option value="success">成功</option>
                            <option value="failed">失败</option>
                            <option value="error">错误</option>
                        </select>
                    </div>
                </div>
                <div class="filters-row">
                    <div class="filter-group">
                        <label>开始时间</label>
                        <input type="datetime-local" id="audit-start-time">
                    </div>
                    <div class="filter-group">
                        <label>结束时间</label>
                        <input type="datetime-local" id="audit-end-time">
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-primary" onclick="loadAuditLogs()">查询</button>
                    <button class="btn btn-secondary" onclick="resetAuditFilters()">重置</button>
                </div>
            </div>
            
            <div id="audit-loading" class="loading" style="display: none;">加载中...</div>
            <div id="audit-error" class="error" style="display: none;"></div>
            <div class="table-container">
                <div class="table-wrapper">
                    <table id="audit-table">
                        <thead>
                            <tr>
                                <th>操作时间</th>
                                <th>用户名</th>
                                <th>操作类型</th>
                                <th>资源类型</th>
                                <th>操作描述</th>
                                <th>状态</th>
                                <th>IP地址</th>
                            </tr>
                        </thead>
                        <tbody id="audit-tbody"></tbody>
                    </table>
                </div>
                <div class="pagination" id="audit-pagination"></div>
            </div>
        </div>
    </div>
    
    <script>
        // 当前页数据
        let currentTab = 'access';
        let accessPage = 1;
        let blockPage = 1;
        let auditPage = 1;
        
        // 标签切换
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId + '-tab').classList.add('active');
                currentTab = tabId;
                
                // 加载对应标签的数据
                if (tabId === 'access') {
                    loadAccessLogs();
                } else if (tabId === 'block') {
                    loadBlockLogs();
                } else if (tabId === 'audit') {
                    loadAuditLogs();
                }
            });
        });
        
        // 加载访问日志
        function loadAccessLogs(page = 1) {
            accessPage = page;
            const loading = document.getElementById('access-loading');
            const error = document.getElementById('access-error');
            const tbody = document.getElementById('access-tbody');
            const pagination = document.getElementById('access-pagination');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            tbody.innerHTML = '';
            pagination.innerHTML = '';
            
            const params = new URLSearchParams({
                page: page,
                page_size: 50
            });
            
            const clientIp = document.getElementById('access-client-ip').value;
            const domain = document.getElementById('access-domain').value;
            const path = document.getElementById('access-path').value;
            const status = document.getElementById('access-status').value;
            const startTime = document.getElementById('access-start-time').value;
            const endTime = document.getElementById('access-end-time').value;
            
            if (clientIp) params.append('client_ip', clientIp);
            if (domain) params.append('request_domain', domain);
            if (path) params.append('request_path', path);
            if (status) params.append('status_code', status);
            if (startTime) params.append('start_time', startTime.replace('T', ' '));
            if (endTime) params.append('end_time', endTime.replace('T', ' '));
            
            fetch('/api/logs/access?' + params.toString())
                .then(res => res.json())
                .then(data => {
                    loading.style.display = 'none';
                    if (data.error) {
                        error.textContent = data.message || data.error;
                        error.style.display = 'block';
                        return;
                    }
                    
                    if (data.data && data.data.length > 0) {
                        data.data.forEach(log => {
                            const row = document.createElement('tr');
                            const statusClass = getStatusClass(log.status_code);
                            row.innerHTML = `
                                <td>${log.request_time || ''}</td>
                                <td>${log.client_ip || ''}</td>
                                <td>${log.request_domain || '-'}</td>
                                <td>${log.request_path || ''}</td>
                                <td>${log.request_method || ''}</td>
                                <td><span class="status-code ${statusClass}">${log.status_code || ''}</span></td>
                                <td>${log.response_time ? log.response_time + 'ms' : '-'}</td>
                                <td title="${log.user_agent || ''}">${truncate(log.user_agent, 50) || '-'}</td>
                            `;
                            tbody.appendChild(row);
                        });
                        
                        renderPagination(pagination, data.pagination, loadAccessLogs);
                    } else {
                        tbody.innerHTML = '<tr><td colspan="8" class="empty">暂无数据</td></tr>';
                    }
                    // 数据加载后强制设置表格宽度
                    setTimeout(forceTableWidths, 50);
                })
                .catch(err => {
                    loading.style.display = 'none';
                    error.textContent = '加载失败: ' + err.message;
                    error.style.display = 'block';
                });
        }
        
        // 加载封控日志
        function loadBlockLogs(page = 1) {
            blockPage = page;
            const loading = document.getElementById('block-loading');
            const error = document.getElementById('block-error');
            const tbody = document.getElementById('block-tbody');
            const pagination = document.getElementById('block-pagination');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            tbody.innerHTML = '';
            pagination.innerHTML = '';
            
            const params = new URLSearchParams({
                page: page,
                page_size: 50
            });
            
            const clientIp = document.getElementById('block-client-ip').value;
            const reason = document.getElementById('block-reason').value;
            const ruleName = document.getElementById('block-rule-name').value;
            const startTime = document.getElementById('block-start-time').value;
            const endTime = document.getElementById('block-end-time').value;
            
            if (clientIp) params.append('client_ip', clientIp);
            if (reason) params.append('block_reason', reason);
            if (ruleName) params.append('rule_name', ruleName);
            if (startTime) params.append('start_time', startTime.replace('T', ' '));
            if (endTime) params.append('end_time', endTime.replace('T', ' '));
            
            fetch('/api/logs/block?' + params.toString())
                .then(res => res.json())
                .then(data => {
                    loading.style.display = 'none';
                    if (data.error) {
                        error.textContent = data.message || data.error;
                        error.style.display = 'block';
                        return;
                    }
                    
                    if (data.data && data.data.length > 0) {
                        data.data.forEach(log => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${log.block_time || ''}</td>
                                <td>${log.client_ip || ''}</td>
                                <td>${log.rule_name || '-'}</td>
                                <td>${getBlockReasonText(log.block_reason)}</td>
                                <td>${log.request_path || '-'}</td>
                                <td title="${log.user_agent || ''}">${truncate(log.user_agent, 50) || '-'}</td>
                            `;
                            tbody.appendChild(row);
                        });
                        
                        renderPagination(pagination, data.pagination, loadBlockLogs);
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" class="empty">暂无数据</td></tr>';
                    }
                    // 数据加载后强制设置表格宽度
                    setTimeout(forceTableWidths, 50);
                })
                .catch(err => {
                    loading.style.display = 'none';
                    error.textContent = '加载失败: ' + err.message;
                    error.style.display = 'block';
                });
        }
        
        // 加载审计日志
        function loadAuditLogs(page = 1) {
            auditPage = page;
            const loading = document.getElementById('audit-loading');
            const error = document.getElementById('audit-error');
            const tbody = document.getElementById('audit-tbody');
            const pagination = document.getElementById('audit-pagination');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            tbody.innerHTML = '';
            pagination.innerHTML = '';
            
            const params = new URLSearchParams({
                page: page,
                page_size: 50
            });
            
            const username = document.getElementById('audit-username').value;
            const actionType = document.getElementById('audit-action-type').value;
            const resourceType = document.getElementById('audit-resource-type').value;
            const status = document.getElementById('audit-status').value;
            const startTime = document.getElementById('audit-start-time').value;
            const endTime = document.getElementById('audit-end-time').value;
            
            if (username) params.append('username', username);
            if (actionType) params.append('action_type', actionType);
            if (resourceType) params.append('resource_type', resourceType);
            if (status) params.append('status', status);
            if (startTime) params.append('start_time', startTime.replace('T', ' '));
            if (endTime) params.append('end_time', endTime.replace('T', ' '));
            
            fetch('/api/logs/audit?' + params.toString())
                .then(res => res.json())
                .then(data => {
                    loading.style.display = 'none';
                    if (data.error) {
                        error.textContent = data.message || data.error;
                        error.style.display = 'block';
                        return;
                    }
                    
                    if (data.data && data.data.length > 0) {
                        data.data.forEach(log => {
                            const row = document.createElement('tr');
                            const statusClass = log.status === 'success' ? 'status-2xx' : 
                                               log.status === 'failed' ? 'status-4xx' : 'status-5xx';
                            row.innerHTML = `
                                <td>${log.created_at || ''}</td>
                                <td>${log.username || '-'}</td>
                                <td>${log.action_type || ''}</td>
                                <td>${log.resource_type || '-'}</td>
                                <td title="${log.action_description || ''}">${truncate(log.action_description, 50) || '-'}</td>
                                <td><span class="status-code ${statusClass}">${getStatusText(log.status)}</span></td>
                                <td>${log.ip_address || '-'}</td>
                            `;
                            tbody.appendChild(row);
                        });
                        
                        renderPagination(pagination, data.pagination, loadAuditLogs);
                    } else {
                        tbody.innerHTML = '<tr><td colspan="7" class="empty">暂无数据</td></tr>';
                    }
                    // 数据加载后强制设置表格宽度
                    setTimeout(forceTableWidths, 50);
                })
                .catch(err => {
                    loading.style.display = 'none';
                    error.textContent = '加载失败: ' + err.message;
                    error.style.display = 'block';
                });
        }
        
        // 渲染分页
        function renderPagination(container, pagination, loadFn) {
            if (!pagination || pagination.total_pages <= 1) return;
            
            const info = document.createElement('div');
            info.className = 'pagination-info';
            info.textContent = `共 ${pagination.total} 条，第 ${pagination.page}/${pagination.total_pages} 页`;
            
            const controls = document.createElement('div');
            controls.className = 'pagination-controls';
            
            const prevBtn = document.createElement('button');
            prevBtn.className = 'pagination-btn';
            prevBtn.textContent = '上一页';
            prevBtn.disabled = pagination.page <= 1;
            prevBtn.onclick = () => loadFn(pagination.page - 1);
            
            // 添加跳转页数输入框
            const jumpContainer = document.createElement('span');
            jumpContainer.style.cssText = 'display: inline-flex; align-items: center; gap: 5px; margin: 0 10px;';
            
            const jumpLabel = document.createElement('span');
            jumpLabel.textContent = '跳转到';
            jumpLabel.style.cssText = 'font-size: 14px; color: #666;';
            
            const jumpInput = document.createElement('input');
            jumpInput.type = 'number';
            jumpInput.min = 1;
            jumpInput.max = pagination.total_pages;
            jumpInput.value = pagination.page;
            jumpInput.style.cssText = 'width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; text-align: center;';
            
            const jumpBtn = document.createElement('button');
            jumpBtn.className = 'pagination-btn';
            jumpBtn.textContent = '跳转';
            jumpBtn.style.cssText = 'padding: 5px 15px; font-size: 14px;';
            jumpBtn.onclick = () => {
                const targetPage = parseInt(jumpInput.value);
                if (targetPage >= 1 && targetPage <= pagination.total_pages) {
                    loadFn(targetPage);
                } else {
                    alert(`请输入1到${pagination.total_pages}之间的页数`);
                    jumpInput.value = pagination.page;
                }
            };
            
            // 回车键跳转
            jumpInput.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    jumpBtn.onclick();
                }
            };
            
            jumpContainer.appendChild(jumpLabel);
            jumpContainer.appendChild(jumpInput);
            jumpContainer.appendChild(jumpBtn);
            
            const nextBtn = document.createElement('button');
            nextBtn.className = 'pagination-btn';
            nextBtn.textContent = '下一页';
            nextBtn.disabled = pagination.page >= pagination.total_pages;
            nextBtn.onclick = () => loadFn(pagination.page + 1);
            
            controls.appendChild(prevBtn);
            controls.appendChild(jumpContainer);
            controls.appendChild(nextBtn);
            
            container.appendChild(info);
            container.appendChild(controls);
        }
        
        // 工具函数
        function getStatusClass(code) {
            if (!code) return '';
            if (code >= 200 && code < 300) return 'status-2xx';
            if (code >= 300 && code < 400) return 'status-3xx';
            if (code >= 400 && code < 500) return 'status-4xx';
            if (code >= 500) return 'status-5xx';
            return '';
        }
        
        function getBlockReasonText(reason) {
            const map = {
                'manual': '手动封控',
                'auto_frequency': '自动频率封控',
                'auto_error': '自动错误率封控',
                'auto_scan': '自动扫描封控'
            };
            return map[reason] || reason;
        }
        
        function getStatusText(status) {
            const map = {
                'success': '成功',
                'failed': '失败',
                'error': '错误'
            };
            return map[status] || status;
        }
        
        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }
        
        // 重置过滤器
        function resetAccessFilters() {
            document.getElementById('access-client-ip').value = '';
            document.getElementById('access-domain').value = '';
            document.getElementById('access-path').value = '';
            document.getElementById('access-status').value = '';
            document.getElementById('access-start-time').value = '';
            document.getElementById('access-end-time').value = '';
            loadAccessLogs(1);
        }
        
        function resetBlockFilters() {
            document.getElementById('block-client-ip').value = '';
            document.getElementById('block-reason').value = '';
            document.getElementById('block-rule-name').value = '';
            document.getElementById('block-start-time').value = '';
            document.getElementById('block-end-time').value = '';
            loadBlockLogs(1);
        }
        
        function resetAuditFilters() {
            document.getElementById('audit-username').value = '';
            document.getElementById('audit-action-type').value = '';
            document.getElementById('audit-resource-type').value = '';
            document.getElementById('audit-status').value = '';
            document.getElementById('audit-start-time').value = '';
            document.getElementById('audit-end-time').value = '';
            loadAuditLogs(1);
        }
        
        // 强制设置表格相关元素的宽度，确保对齐
        // 使用MutationObserver监听DOM变化，确保在元素创建后立即设置宽度
        function forceTableWidths() {
            // 获取content-area
            const contentArea = document.querySelector('.content-area');
            if (!contentArea) {
                // 如果content-area还没加载，延迟重试
                setTimeout(forceTableWidths, 100);
                return;
            }
            
            // 强制设置container的宽度（使用100%，相对于content-area）
            const container = document.querySelector('.container');
            if (container) {
                // 使用内联样式强制设置，优先级最高
                container.style.setProperty('width', '100%', 'important');
                container.style.setProperty('max-width', '100%', 'important');
                container.style.setProperty('min-width', '100%', 'important');
            }
            
            // 强制设置所有tab-content的宽度
            document.querySelectorAll('.tab-content').forEach(tabContent => {
                tabContent.style.setProperty('width', '100%', 'important');
                tabContent.style.setProperty('max-width', '100%', 'important');
                tabContent.style.setProperty('min-width', '100%', 'important');
            });
            
            // 强制设置所有table-container的宽度
            document.querySelectorAll('.table-container').forEach(tableContainer => {
                tableContainer.style.setProperty('width', '100%', 'important');
                tableContainer.style.setProperty('max-width', '100%', 'important');
                tableContainer.style.setProperty('min-width', '100%', 'important');
            });
            
            // 强制设置所有table-wrapper的宽度
            document.querySelectorAll('.table-wrapper').forEach(tableWrapper => {
                tableWrapper.style.setProperty('width', '100%', 'important');
                tableWrapper.style.setProperty('max-width', '100%', 'important');
                tableWrapper.style.setProperty('min-width', '100%', 'important');
            });
            
            // 强制设置所有表格的宽度
            document.querySelectorAll('#access-table, #block-table, #audit-table').forEach(table => {
                table.style.setProperty('width', '100%', 'important');
                table.style.setProperty('max-width', '100%', 'important');
                table.style.setProperty('min-width', '100%', 'important');
            });
        }
        
        // 使用MutationObserver监听DOM变化，确保新创建的元素也能正确设置宽度
        if (typeof MutationObserver !== 'undefined') {
            const observer = new MutationObserver(function(mutations) {
                // 检查是否有新的表格元素被创建
                const hasNewTables = document.querySelectorAll('#access-table, #block-table, #audit-table').length > 0;
                const hasTableContainers = document.querySelectorAll('.table-container').length > 0;
                if (hasNewTables || hasTableContainers) {
                    setTimeout(forceTableWidths, 50);
                }
            });
            
            // 观察content-area的变化
            const contentArea = document.querySelector('.content-area');
            if (contentArea) {
                observer.observe(contentArea, {
                    childList: true,
                    subtree: true
                });
            } else {
                // 如果content-area还没加载，等待DOMContentLoaded
                document.addEventListener('DOMContentLoaded', function() {
                    const contentArea = document.querySelector('.content-area');
                    if (contentArea) {
                        observer.observe(contentArea, {
                            childList: true,
                            subtree: true
                        });
                    }
                });
            }
        }
        
        // 页面加载时初始化
        window.addEventListener('DOMContentLoaded', function() {
            // 时间筛选默认为空，不设置默认时间范围
            // 用户可以根据需要自行设置时间范围进行筛选
            
            // 强制设置表格宽度
            forceTableWidths();
            
            // 延迟再次设置，确保所有元素都已渲染
            setTimeout(forceTableWidths, 100);
            setTimeout(forceTableWidths, 300);
            
            // 窗口大小改变时重新设置
            window.addEventListener('resize', function() {
                setTimeout(forceTableWidths, 100);
            });
            
            // 加载访问日志
            loadAccessLogs();
        });
        
        // 在layout-ready后也设置一次
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(forceTableWidths, 500);
        }
    </script>
</body>
</html>

