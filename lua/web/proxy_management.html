<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代理管理 - WAF管理</title>
    <link rel="stylesheet" href="/css/proxy_management.css">
    <script src="/common.js"></script>
    <script src="/js/proxy_management.js"></script>
    </head>
    <body>
    <div class="container">
        <h1>代理管理</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('proxies')">代理列表</button>
            <button class="tab" onclick="showCreateProxyModal()" style="display: none;">创建代理</button>
        </div>
        
        <div id="alert-container"></div>
        
        <!-- 代理列表 -->
        <div id="proxies-tab" class="tab-content active">
            <div class="toolbar">
                <div class="filters">
                    <select id="filter-type">
                        <option value="">全部类型</option>
                        <option value="http">HTTP</option>
                        <option value="tcp">TCP</option>
                        <option value="udp">UDP</option>
                    </select>
                    <select id="filter-status">
                        <option value="">全部状态</option>
                        <option value="1">已启用</option>
                        <option value="0">已禁用</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="applyFilters()">查询</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">重置</button>
                    <button class="btn btn-primary" onclick="showCreateProxyModal()">创建代理</button>
                    <button class="btn btn-primary" onclick="loadProxies()">刷新</button>
                </div>
            </div>
            
            <table id="proxies-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>代理名称</th>
                        <th>类型</th>
                        <th>监听端口</th>
                        <th>监听域名</th>
                        <th>后端地址</th>
                        <th>防护规则</th>
                        <th>规则类型</th>
                        <th>状态</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="proxies-tbody">
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 20px;">加载中...</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="pagination" id="pagination"></div>
        </div>
        
        <!-- 创建代理弹出框 -->
        <div id="create-proxy-modal" class="modal">
            <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2>创建代理</h2>
                    <span class="close" onclick="closeCreateProxyModal()">&times;</span>
                </div>
                <form id="create-form" onsubmit="createProxy(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>代理名称 *</label>
                        <input type="text" id="create-proxy-name" required placeholder="例如: web-proxy-80">
                    </div>
                    <div class="form-group">
                        <label>代理类型 *</label>
                        <select id="create-proxy-type" required onchange="toggleProxyFields()">
                            <option value="http" selected>HTTP/HTTPS</option>
                            <option value="tcp">TCP</option>
                            <option value="udp">UDP</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row" id="http-fields">
                    <div class="form-group">
                        <label>监听域名</label>
                        <input type="text" id="create-server-name" placeholder="example.com www.example.com（可选）">
                        <small style="color: #666; display: block; margin-top: 4px;">支持多个域名，用空格分隔（可为空）</small>
                    </div>
                    <div class="form-group">
                        <label>监听端口 *</label>
                        <input type="number" id="create-listen-port" required min="1" max="65535" placeholder="80">
                    </div>
                    <div class="form-group">
                        <label>监听地址</label>
                        <input type="text" id="create-listen-address" value="0.0.0.0" placeholder="0.0.0.0">
                    </div>
                </div>
                
                <div class="form-row" id="tcp-udp-fields" style="display: none;">
                    <div class="form-group">
                        <label>监听端口 *</label>
                        <input type="number" id="create-tcp-udp-listen-port" required min="1" max="65535" placeholder="3306">
                    </div>
                    <div class="form-group">
                        <label>监听地址</label>
                        <input type="text" id="create-tcp-udp-listen-address" value="0.0.0.0" placeholder="0.0.0.0">
                    </div>
                </div>
                
                <div class="form-group" id="upstream-fields">
                    <label>后端服务器配置</label>
                    <div class="config-section">
                        <div class="location-item">
                            <div class="location-content">
                                <div class="location-path-section">
                                    <div class="input-with-add location-path-input-wrapper" style="display: none;">
                                        <input type="text" placeholder="匹配路径：/PATH" class="location-path-input" title="匹配路径：/PATH">
                                    </div>
                                </div>
                                <div class="location-divider"></div>
                                <div class="location-backends">
                                    <div class="backend-row">
                                        <div class="input-with-add address-input">
                                            <input type="text" placeholder="IP地址" class="backend-address">
                                        </div>
                                        <div class="input-with-add port-input">
                                            <input type="number" placeholder="端口" class="backend-port" min="1" max="65535">
                                        </div>
                                        <div class="input-with-add location-backend-path-input-wrapper" style="display: none;">
                                            <input type="text" placeholder="目标路径：/PATH（可选）" class="location-backend-path-input" title="目标路径：/PATH（可选）">
                                        </div>
                                        <div class="input-with-add input-weight">
                                            <input type="number" placeholder="权重" class="backend-weight" value="1" min="1">
                                        </div>
                                        <div class="backend-row-actions">
                                            <button type="button" class="btn-icon btn-add-icon" onclick="addBackendRow(this)" title="添加">+</button>
                                            <button type="button" class="btn-icon btn-remove-icon" onclick="removeBackendRow(this)" title="删除">−</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="location-actions">
                                <button type="button" class="btn btn-primary btn-sm" onclick="addLocation()">添加location</button>
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeLocation(this)">删除location</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>负载均衡算法</label>
                        <select id="create-load-balance">
                            <option value="round_robin">轮询</option>
                            <option value="least_conn">最少连接</option>
                            <option value="ip_hash">IP哈希</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>连接超时（秒）</label>
                        <input type="number" id="create-proxy-connect-timeout" value="60" min="1">
                    </div>
                    <div class="form-group">
                        <label>发送超时（秒）</label>
                        <input type="number" id="create-proxy-send-timeout" value="60" min="1">
                    </div>
                    <div class="form-group">
                        <label>读取超时（秒）</label>
                        <input type="number" id="create-proxy-read-timeout" value="60" min="1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>描述</label>
                    <textarea id="create-description" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label>防护规则</label>
                    <div class="config-section">
                        <div class="rules-list" id="rules-list">
                            <div class="rule-item">
                                <select class="rule-type" onchange="onRuleTypeChange(this)">
                                    <option value="">请选择规则类型</option>
                                    <option value="ip_whitelist">IP白名单</option>
                                    <option value="ip_blacklist">IP黑名单</option>
                                    <option value="geo_whitelist">地域白名单</option>
                                    <option value="geo_blacklist">地域黑名单</option>
                                </select>
                                <select class="rule-id">
                                    <option value="">请选择规则条目</option>
                                </select>
                                <div class="rule-item-actions">
                                    <button type="button" class="btn-icon btn-add-icon" onclick="addRule()" title="添加防护规则">+</button>
                                    <button type="button" class="btn-icon btn-remove-icon" onclick="removeRule(this)" title="删除">−</button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary btn-sm" onclick="addRule()" style="margin-top: 10px;">添加防护规则</button>
                        <small style="color: #666; display: block; margin-top: 8px; font-size: 12px;">注意：IP白名单和IP黑名单不能同时存在，地域白名单和地域黑名单不能同时存在</small>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateProxyModal()">取消</button>
                    <button type="button" class="btn btn-secondary" onclick="resetCreateForm()">重置</button>
                    <button type="submit" class="btn btn-primary">创建代理</button>
                </div>
            </form>
            </div>
        </div>
        
        <!-- 创建代理标签页（已废弃，保留用于兼容） -->
        <div id="create-tab" class="tab-content" style="display: none;">
        </div>
    </div>
    
    <!-- 编辑代理模态框 -->
    <div id="edit-modal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>编辑代理配置</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <form id="edit-form" onsubmit="updateProxy(event)">
                <input type="hidden" id="edit-id">
                <div class="form-row">
                    <div class="form-group">
                        <label>代理名称 *</label>
                        <input type="text" id="edit-proxy-name" required>
                    </div>
                    <div class="form-group">
                        <label>代理类型</label>
                        <input type="text" id="edit-proxy-type" disabled>
                    </div>
                </div>
                <div class="form-row" id="edit-http-fields">
                    <div class="form-group">
                        <label>监听域名</label>
                        <input type="text" id="edit-server-name">
                        <small style="color: #666; display: block; margin-top: 4px;">支持多个域名，用空格分隔（可为空）</small>
                    </div>
                    <div class="form-group">
                        <label>监听端口 *</label>
                        <input type="number" id="edit-listen-port" required min="1" max="65535">
                    </div>
                    <div class="form-group">
                        <label>监听地址</label>
                        <input type="text" id="edit-listen-address">
                    </div>
                </div>
                
                <div class="form-row" id="edit-tcp-udp-fields" style="display: none;">
                    <div class="form-group">
                        <label>监听端口 *</label>
                        <input type="number" id="edit-tcp-udp-listen-port" required min="1" max="65535">
                    </div>
                    <div class="form-group">
                        <label>监听地址</label>
                        <input type="text" id="edit-tcp-udp-listen-address">
                    </div>
                </div>
                
                <div class="form-group" id="edit-upstream-fields">
                    <label>后端服务器配置</label>
                    <div class="config-section" id="edit-config-section">
                        <!-- location项将动态添加到这里 -->
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>负载均衡算法</label>
                        <select id="edit-load-balance">
                            <option value="round_robin">轮询</option>
                            <option value="least_conn">最少连接</option>
                            <option value="ip_hash">IP哈希</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>连接超时（秒）</label>
                        <input type="number" id="edit-proxy-connect-timeout" min="1" value="60">
                    </div>
                    <div class="form-group">
                        <label>发送超时（秒）</label>
                        <input type="number" id="edit-proxy-send-timeout" min="1" value="60">
                    </div>
                    <div class="form-group">
                        <label>读取超时（秒）</label>
                        <input type="number" id="edit-proxy-read-timeout" min="1" value="60">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>描述</label>
                    <textarea id="edit-description" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label>防护规则</label>
                    <div class="config-section">
                        <div class="rules-list" id="edit-rules-list">
                            <!-- 规则条目将动态添加到这里 -->
                        </div>
                        <button type="button" class="btn btn-primary btn-sm" onclick="addEditRule()" style="margin-top: 10px;">添加防护规则</button>
                        <small style="color: #666; display: block; margin-top: 8px; font-size: 12px;">注意：IP白名单和IP黑名单不能同时存在，地域白名单和地域黑名单不能同时存在</small>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 确认对话框模态框 -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="confirm-title">确认操作</h2>
            </div>
            <div style="padding: 20px;">
                <p id="confirm-message">确定要执行此操作吗？</p>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">取消</button>
                <button type="button" class="btn btn-primary" id="confirm-ok-btn">确定</button>
            </div>
        </div>
    </div>
    
</body>
</html>

