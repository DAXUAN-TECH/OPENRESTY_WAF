# Redis ä¸€é”®å®‰è£…è„šæœ¬è¯´æ˜

## è„šæœ¬åŠŸèƒ½

`install_redis.sh` æ˜¯ä¸€ä¸ªå…¨è‡ªåŠ¨çš„ Redis å®‰è£…å’Œé…ç½®è„šæœ¬ï¼Œæ”¯æŒå¤šç§ Linux å‘è¡Œç‰ˆã€‚

### æ”¯æŒçš„ç³»ç»Ÿ

#### RedHat ç³»åˆ—
- âœ… **CentOS** (6.x, 7.x, 8.x)
- âœ… **RHEL** (6.x, 7.x, 8.x, 9.x)
- âœ… **Fedora** (æ‰€æœ‰ç‰ˆæœ¬)
- âœ… **Rocky Linux** (8.x, 9.x)
- âœ… **AlmaLinux** (8.x, 9.x)
- âœ… **Oracle Linux** (7.x, 8.x, 9.x)
- âœ… **Amazon Linux** (1, 2, 2023)

#### Debian ç³»åˆ—
- âœ… **Debian** (9+, åŒ…æ‹¬ Debian 10/11/12)
- âœ… **Ubuntu** (16.04+, åŒ…æ‹¬ 18.04/20.04/22.04)
- âœ… **Linux Mint** (æ‰€æœ‰ç‰ˆæœ¬ï¼ŒåŸºäº Ubuntu)
- âœ… **Kali Linux** (æ‰€æœ‰ç‰ˆæœ¬ï¼ŒåŸºäº Debian)
- âœ… **Raspbian** (æ‰€æœ‰ç‰ˆæœ¬ï¼ŒåŸºäº Debian)

#### SUSE ç³»åˆ—
- âœ… **openSUSE** (Leap, Tumbleweed)
- âœ… **SLES** (SUSE Linux Enterprise Server)

#### Arch ç³»åˆ—
- âœ… **Arch Linux** (éœ€è¦ yay/paru æˆ–ä»æºç ç¼–è¯‘)
- âœ… **Manjaro** (éœ€è¦ yay/paru æˆ–ä»æºç ç¼–è¯‘)

#### å…¶ä»–å‘è¡Œç‰ˆ
- âœ… **Alpine Linux** (ä½¿ç”¨ apk æˆ–ä»æºç ç¼–è¯‘)
- âœ… **Gentoo** (ä½¿ç”¨ emerge æˆ–ä»æºç ç¼–è¯‘)
- âœ… **å…¶ä»–æœªåˆ—å‡ºçš„å‘è¡Œç‰ˆ** (è‡ªåŠ¨æ£€æµ‹åŒ…ç®¡ç†å™¨ï¼Œå¤±è´¥åˆ™ä»æºç ç¼–è¯‘)

### åŠŸèƒ½ç‰¹æ€§

- ğŸ” **è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿç±»å‹**ï¼šè‡ªåŠ¨è¯†åˆ« Linux å‘è¡Œç‰ˆï¼ˆæ”¯æŒ 20+ ç§å‘è¡Œç‰ˆï¼‰
- ğŸ’» **ç¡¬ä»¶è‡ªåŠ¨æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹ CPU æ ¸å¿ƒæ•°å’Œå†…å­˜å¤§å°
- âš¡ **ç¡¬ä»¶è‡ªåŠ¨ä¼˜åŒ–**ï¼šæ ¹æ®ç¡¬ä»¶é…ç½®è‡ªåŠ¨ä¼˜åŒ– Redis å‚æ•°ï¼Œæœ€å¤§åŒ–æ€§èƒ½
- ğŸ“¦ **è‡ªåŠ¨å®‰è£…ä¾èµ–**ï¼šæ ¹æ®ç³»ç»Ÿç±»å‹å®‰è£…ç¼–è¯‘å·¥å…·
- ğŸš€ **å¤šç§å®‰è£…æ–¹å¼**ï¼šä¼˜å…ˆä½¿ç”¨åŒ…ç®¡ç†å™¨ï¼Œå¤±è´¥åˆ™ä»æºç ç¼–è¯‘
- ğŸ›¡ï¸ **å®¹é”™æœºåˆ¶**ï¼šåŒ…ç®¡ç†å™¨å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°æºç ç¼–è¯‘
- âš™ï¸ **è‡ªåŠ¨é…ç½®**ï¼šé…ç½®æ–‡ä»¶ã€systemd/OpenRC æœåŠ¡ã€ç”¨æˆ·æƒé™
- ğŸ”’ **å¯†ç è®¾ç½®**ï¼šå¯é€‰è®¾ç½® Redis å¯†ç 
- ğŸ”§ **æœåŠ¡ç®¡ç†**ï¼šæ”¯æŒ systemdã€serviceã€OpenRC ç­‰å¤šç§æœåŠ¡ç®¡ç†æ–¹å¼
- âœ… **éªŒè¯å®‰è£…**ï¼šæ£€æŸ¥å®‰è£…æ˜¯å¦æˆåŠŸï¼Œæµ‹è¯•è¿æ¥

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨

```bash
# è¿è¡Œå®‰è£…è„šæœ¬ï¼ˆéœ€è¦ root æƒé™ï¼‰
sudo ./scripts/install_redis.sh
```

### æŒ‡å®šå¯†ç 

```bash
# é€šè¿‡ç¯å¢ƒå˜é‡æŒ‡å®šå¯†ç 
sudo REDIS_PASSWORD='your_password' ./scripts/install_redis.sh
```

### æŒ‡å®šç«¯å£

```bash
# é€šè¿‡ç¯å¢ƒå˜é‡æŒ‡å®šç«¯å£ï¼ˆé»˜è®¤ 6379ï¼‰
sudo REDIS_PORT=6380 ./scripts/install_redis.sh
```

### æŒ‡å®šç‰ˆæœ¬

```bash
# é€šè¿‡ç¯å¢ƒå˜é‡æŒ‡å®šç‰ˆæœ¬ï¼ˆé»˜è®¤ 7.0ï¼‰
sudo REDIS_VERSION=7.0 ./scripts/install_redis.sh
```

## å®‰è£…è¿‡ç¨‹

è„šæœ¬ä¼šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **[1/7] æ£€æµ‹æ“ä½œç³»ç»Ÿ** - è‡ªåŠ¨è¯†åˆ« Linux å‘è¡Œç‰ˆ
2. **æ£€æµ‹ç¡¬ä»¶é…ç½®** - è‡ªåŠ¨æ£€æµ‹ CPU æ ¸å¿ƒæ•°å’Œå†…å­˜å¤§å°
3. **[2/7] æ£€æŸ¥æ˜¯å¦å·²å®‰è£…** - å¦‚æœå·²å®‰è£…ï¼Œè¯¢é—®æ˜¯å¦ç»§ç»­
4. **[3/7] å®‰è£…ä¾èµ–åŒ…** - å®‰è£…ç¼–è¯‘å·¥å…·ï¼ˆgccã€make ç­‰ï¼‰
5. **[4/7] å®‰è£… Redis** - ä½¿ç”¨åŒ…ç®¡ç†å™¨æˆ–ä»æºç ç¼–è¯‘
   - RedHat ç³»åˆ—ï¼šä½¿ç”¨ EPEL ä»“åº“æˆ–ä»æºç ç¼–è¯‘
   - Debian ç³»åˆ—ï¼šä½¿ç”¨ apt-get å®‰è£…
   - openSUSEï¼šä½¿ç”¨ zypper å®‰è£…æˆ–ä»æºç ç¼–è¯‘
   - Arch Linuxï¼šä½¿ç”¨ yay æˆ– pacman å®‰è£…
6. **[5/7] é…ç½® Redis** - æ ¹æ®ç¡¬ä»¶è‡ªåŠ¨ä¼˜åŒ–é…ç½®å‚æ•°
   - å†…å­˜ä¼˜åŒ–ï¼šè‡ªåŠ¨è®¾ç½® maxmemoryï¼ˆæ ¹æ®æ€»å†…å­˜çš„ 50-70%ï¼‰
   - ç½‘ç»œä¼˜åŒ–ï¼šæ ¹æ® CPU æ ¸å¿ƒæ•°è®¾ç½® tcp-backlog
   - è¿æ¥ä¼˜åŒ–ï¼šæ ¹æ®å†…å­˜è®¾ç½® maxclients
   - æŒä¹…åŒ–ä¼˜åŒ–ï¼šå¤§å†…å­˜è‡ªåŠ¨å¯ç”¨ AOF + RDB
   - æ€§èƒ½ä¼˜åŒ–ï¼šè‡ªåŠ¨è°ƒæ•´æ…¢æŸ¥è¯¢æ—¥å¿—ã€è¶…æ—¶ç­‰å‚æ•°
7. **[6/7] è®¾ç½®å¯†ç ** - äº¤äº’å¼è¾“å…¥æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡
8. **[7/7] å¯åŠ¨æœåŠ¡** - å¯åŠ¨ Redis å¹¶è®¾ç½®å¼€æœºè‡ªå¯
9. **[8/8] éªŒè¯å®‰è£…** - æ£€æŸ¥å®‰è£…æ˜¯å¦æˆåŠŸï¼Œæµ‹è¯•è¿æ¥

## å®‰è£…ä½ç½®

Redis å°†å®‰è£…åˆ°ä»¥ä¸‹ä½ç½®ï¼š

```
/usr/local/bin/redis-server    # ä¸»ç¨‹åºï¼ˆæºç ç¼–è¯‘ï¼‰
/usr/bin/redis-server          # ä¸»ç¨‹åºï¼ˆåŒ…ç®¡ç†å™¨ï¼‰
/etc/redis/redis.conf          # é…ç½®æ–‡ä»¶
/var/lib/redis/                # æ•°æ®ç›®å½•
/var/log/redis/                # æ—¥å¿—ç›®å½•
```

## æœåŠ¡ç®¡ç†

å®‰è£…å®Œæˆåï¼Œå¯ä»¥ä½¿ç”¨ systemd ç®¡ç† Redisï¼š

```bash
# å¯åŠ¨æœåŠ¡
sudo systemctl start redis
sudo systemctl start redis-server

# åœæ­¢æœåŠ¡
sudo systemctl stop redis
sudo systemctl stop redis-server

# é‡å¯æœåŠ¡
sudo systemctl restart redis
sudo systemctl restart redis-server

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status redis
sudo systemctl status redis-server

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable redis
sudo systemctl enable redis-server

# ç¦ç”¨å¼€æœºè‡ªå¯
sudo systemctl disable redis
sudo systemctl disable redis-server
```

## è¿æ¥ Redis

### ä½¿ç”¨ redis-cli è¿æ¥

```bash
# æ— å¯†ç è¿æ¥
redis-cli

# æœ‰å¯†ç è¿æ¥
redis-cli -a 'your_password'

# æŒ‡å®šä¸»æœºå’Œç«¯å£
redis-cli -h 127.0.0.1 -p 6379

# æœ‰å¯†ç ä¸”æŒ‡å®šä¸»æœºç«¯å£
redis-cli -h 127.0.0.1 -p 6379 -a 'your_password'
```

### æµ‹è¯•è¿æ¥

```bash
# æ— å¯†ç 
redis-cli ping
# åº”è¿”å›: PONG

# æœ‰å¯†ç 
redis-cli -a 'your_password' ping
# åº”è¿”å›: PONG
```

## é…ç½®æ–‡ä»¶

### é…ç½®æ–‡ä»¶ä½ç½®

- `/etc/redis/redis.conf`ï¼ˆæ¨èï¼‰
- `/etc/redis.conf`ï¼ˆæ—§ç‰ˆæœ¬ï¼‰

### ä¸»è¦é…ç½®é¡¹

```conf
# ç«¯å£
port 6379

# å¯†ç ï¼ˆå¦‚æœè®¾ç½®ï¼‰
requirepass your_password

# æ•°æ®ç›®å½•
dir /var/lib/redis

# æ—¥å¿—æ–‡ä»¶
logfile /var/log/redis/redis-server.log

# æŒä¹…åŒ–é…ç½®
save 900 1      # 900 ç§’å†…è‡³å°‘ 1 ä¸ª key å˜åŒ–æ—¶ä¿å­˜
save 300 10     # 300 ç§’å†…è‡³å°‘ 10 ä¸ª key å˜åŒ–æ—¶ä¿å­˜
save 60 10000   # 60 ç§’å†…è‡³å°‘ 10000 ä¸ª key å˜åŒ–æ—¶ä¿å­˜
```

### ä¿®æ”¹é…ç½®

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo vim /etc/redis/redis.conf

# é‡æ–°åŠ è½½é…ç½®ï¼ˆä¸ä¸­æ–­æœåŠ¡ï¼‰
redis-cli CONFIG REWRITE

# æˆ–é‡å¯æœåŠ¡
sudo systemctl restart redis
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šRedis å®‰è£…å¤±è´¥

**å¯èƒ½åŸå› **ï¼š
- ç½‘ç»œè¿æ¥é—®é¢˜
- ä¾èµ–åŒ…å®‰è£…å¤±è´¥
- ç¼–è¯‘é”™è¯¯

**è§£å†³æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥ç½‘ç»œè¿æ¥
ping -c 3 download.redis.io

# æ£€æŸ¥ç¼–è¯‘å·¥å…·
gcc --version
make --version

# æ‰‹åŠ¨å®‰è£…ä¾èµ–åé‡è¯•
```

### é—®é¢˜ 2ï¼šæœåŠ¡å¯åŠ¨å¤±è´¥

**å¯èƒ½åŸå› **ï¼š
- ç«¯å£è¢«å ç”¨
- é…ç½®æ–‡ä»¶é”™è¯¯
- æƒé™é—®é¢˜

**è§£å†³æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep :6379

# æ£€æŸ¥é”™è¯¯æ—¥å¿—
tail -f /var/log/redis/redis-server.log

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status redis

# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
redis-server /etc/redis/redis.conf --test-memory 1
```

### é—®é¢˜ 3ï¼šæ— æ³•è¿æ¥ Redis

**å¯èƒ½åŸå› **ï¼š
- æœåŠ¡æœªå¯åŠ¨
- å¯†ç é”™è¯¯
- é˜²ç«å¢™é˜»æ­¢

**è§£å†³æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status redis

# æ£€æŸ¥é˜²ç«å¢™
firewall-cmd --list-all    # CentOS/RHEL
ufw status                 # Ubuntu/Debian

# æµ‹è¯•æœ¬åœ°è¿æ¥
redis-cli ping
```

### é—®é¢˜ 4ï¼šå¿˜è®°å¯†ç 

**è§£å†³æ–¹æ³•**ï¼š
```bash
# 1. ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo vim /etc/redis/redis.conf

# 2. æ³¨é‡Šæˆ–åˆ é™¤ requirepass è¡Œ
# requirepass your_password

# 3. é‡å¯æœåŠ¡
sudo systemctl restart redis

# 4. é‡æ–°è®¾ç½®å¯†ç 
redis-cli
CONFIG SET requirepass new_password
CONFIG REWRITE
```

## å®‰å…¨å»ºè®®

1. **è®¾ç½®å¯†ç **ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»è®¾ç½® Redis å¯†ç 
2. **é™åˆ¶ç½‘ç»œ**ï¼šåªå…è®¸æœ¬åœ°è¿æ¥ï¼ˆbind 127.0.0.1ï¼‰
3. **ç¦ç”¨å±é™©å‘½ä»¤**ï¼šç¦ç”¨ FLUSHALLã€CONFIG ç­‰å‘½ä»¤
4. **å®šæœŸæ›´æ–°**ï¼šä¿æŒ Redis ç‰ˆæœ¬æœ€æ–°
5. **ç›‘æ§æ—¥å¿—**ï¼šå®šæœŸæ£€æŸ¥ Redis æ—¥å¿—

## ç¡¬ä»¶è‡ªåŠ¨ä¼˜åŒ– â­

è„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹ç¡¬ä»¶é…ç½®å¹¶æ ¹æ®ç¡¬ä»¶è‡ªåŠ¨ä¼˜åŒ– Redis å‚æ•°ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒæ•´ã€‚

### è‡ªåŠ¨æ£€æµ‹çš„ç¡¬ä»¶ä¿¡æ¯

- **CPU æ ¸å¿ƒæ•°**ï¼šè‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿ CPU æ ¸å¿ƒæ•°
- **å†…å­˜å¤§å°**ï¼šè‡ªåŠ¨æ£€æµ‹æ€»å†…å­˜ï¼ˆGB å’Œ MBï¼‰

### è‡ªåŠ¨ä¼˜åŒ–é¡¹

#### 1. å†…å­˜ä¼˜åŒ–

æ ¹æ®æ€»å†…å­˜è‡ªåŠ¨è®¾ç½® `maxmemory`ï¼š
- **å°å†…å­˜ï¼ˆ<4GBï¼‰**ï¼šä½¿ç”¨ 50% å†…å­˜
- **ä¸­ç­‰å†…å­˜ï¼ˆ4-16GBï¼‰**ï¼šä½¿ç”¨ 60% å†…å­˜
- **å¤§å†…å­˜ï¼ˆ>16GBï¼‰**ï¼šä½¿ç”¨ 70% å†…å­˜ï¼Œæœ€å¤§ 32GB

**å†…å­˜æ·˜æ±°ç­–ç•¥**ï¼šè‡ªåŠ¨è®¾ç½®ä¸º `allkeys-lru`ï¼ˆé€‚åˆç¼“å­˜åœºæ™¯ï¼‰

#### 2. ç½‘ç»œä¼˜åŒ–

- **tcp-backlog**ï¼šæ ¹æ® CPU æ ¸å¿ƒæ•°è‡ªåŠ¨è®¾ç½®ï¼ˆCPU æ ¸å¿ƒæ•° Ã— 128ï¼ŒèŒƒå›´ 511-65535ï¼‰

#### 3. è¿æ¥ä¼˜åŒ–

æ ¹æ®å†…å­˜å¤§å°è‡ªåŠ¨è®¾ç½® `maxclients`ï¼š
- **4GB å†…å­˜**ï¼š10,000 è¿æ¥
- **8GB å†…å­˜**ï¼š20,000 è¿æ¥
- **16GB+ å†…å­˜**ï¼š50,000 è¿æ¥

#### 4. æŒä¹…åŒ–ä¼˜åŒ–

- **å¤§å†…å­˜ï¼ˆâ‰¥8GBï¼‰**ï¼šè‡ªåŠ¨å¯ç”¨ AOF + RDB åŒé‡æŒä¹…åŒ–
  - AOF åŒæ­¥ç­–ç•¥ï¼š`everysec`ï¼ˆå¹³è¡¡æ€§èƒ½å’Œæ•°æ®å®‰å…¨ï¼‰
- **æ‰€æœ‰é…ç½®**ï¼šå¯ç”¨ RDB å¿«ç…§ï¼ˆ900s/300s/60sï¼‰

#### 5. æ€§èƒ½ä¼˜åŒ–

- **æ…¢æŸ¥è¯¢æ—¥å¿—é˜ˆå€¼**ï¼š10,000 å¾®ç§’
- **è¶…æ—¶è®¾ç½®**ï¼š300 ç§’
- **æ—¥å¿—çº§åˆ«**ï¼š`notice`ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

### ä¼˜åŒ–æ•ˆæœç¤ºä¾‹

| ç¡¬ä»¶é…ç½® | maxmemory | maxclients | tcp-backlog | æŒä¹…åŒ–ç­–ç•¥ |
|---------|-----------|------------|-------------|-----------|
| 2 æ ¸ 4GB | ~2GB | 10,000 | 256 | RDB |
| 8 æ ¸ 16GB | ~9.6GB | 50,000 | 1,024 | AOF + RDB |
| 32 æ ¸ 64GB | 32GB | 50,000 | 4,096 | AOF + RDB |

### æ‰‹åŠ¨è°ƒæ•´

å¦‚æœéœ€è¦æ‰‹åŠ¨è°ƒæ•´é…ç½®ï¼Œå¯ä»¥ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼š

```bash
sudo vim /etc/redis/redis.conf
```

ä¿®æ”¹åé‡å¯æœåŠ¡ï¼š

```bash
sudo systemctl restart redis
```

## æ€§èƒ½ä¼˜åŒ–ï¼ˆæ‰‹åŠ¨ï¼‰

å¦‚æœè‡ªåŠ¨ä¼˜åŒ–ä¸æ»¡è¶³éœ€æ±‚ï¼Œå¯ä»¥æ‰‹åŠ¨è°ƒæ•´ï¼š

### å†…å­˜ä¼˜åŒ–

```conf
# è®¾ç½®æœ€å¤§å†…å­˜
maxmemory 2gb

# å†…å­˜æ·˜æ±°ç­–ç•¥
maxmemory-policy allkeys-lru
```

### æŒä¹…åŒ–ä¼˜åŒ–

```conf
# å¯ç”¨ AOFï¼ˆè¿½åŠ å¼æŒä¹…åŒ–ï¼‰
appendonly yes
appendfsync everysec
```

## åç»­é…ç½®

å®‰è£…å®Œæˆåï¼Œéœ€è¦ï¼š

1. **é…ç½® WAF è¿æ¥**ï¼ˆå¦‚æœä½¿ç”¨ Redisï¼‰ï¼š
   - ä½¿ç”¨ `install.sh` è‡ªåŠ¨é…ç½®ï¼ˆæ¨èï¼‰
   - æˆ–æ‰‹åŠ¨ç¼–è¾‘ `lua/config.lua`

2. **æµ‹è¯•è¿æ¥**ï¼š
   ```bash
   redis-cli -a 'your_password' ping
   ```

3. **ç›‘æ§ Redis**ï¼š
   ```bash
   # æŸ¥çœ‹ Redis ä¿¡æ¯
   redis-cli -a 'your_password' INFO

   # æŸ¥çœ‹å†…å­˜ä½¿ç”¨
   redis-cli -a 'your_password' INFO memory
   ```

## æ³¨æ„äº‹é¡¹

1. **éœ€è¦ root æƒé™**ï¼šå®‰è£…è¿‡ç¨‹éœ€è¦ root æƒé™
2. **ç½‘ç»œè¿æ¥**ï¼šéœ€è¦ç½‘ç»œè¿æ¥ä¸‹è½½åŒ…å’Œæºç 
3. **ç£ç›˜ç©ºé—´**ï¼šç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ï¼ˆè‡³å°‘ 500MBï¼‰
4. **ç«¯å£å ç”¨**ï¼šç¡®ä¿ 6379 ç«¯å£æœªè¢«å ç”¨
5. **ç¼–è¯‘æ—¶é—´**ï¼šä»æºç ç¼–è¯‘å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼ˆ5-10 åˆ†é’Ÿï¼‰

## å‚è€ƒæ–‡æ¡£

- [Redis å®˜ç½‘](https://redis.io/)
- [Redis å®‰è£…æ–‡æ¡£](https://redis.io/docs/getting-started/installation/)
- [Redis é…ç½®æ–‡æ¡£](https://redis.io/docs/management/config/)

